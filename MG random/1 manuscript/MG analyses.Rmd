---
title: "Scale Results"
author: "Erin M. Buchanan"
date: "10/25/2017"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, cache = TRUE)
##libraries
library(lavaan)
library(semPlot)
library(semTools)
library(car)
library(mice)
library(knitr)
options(scipen = 999)
library(kableExtra)
library(papaja)
percentmiss = function(x){ sum(is.na(x))/length(x) *100 }

```

```{r saveddata, echo=FALSE, results = 'asis'}

##create a table here
##scale name, number of scale points, sample size by group (2 columns), reliability, number of items, number of subscales
##did it break (y/n), where it broke, partial invariance (y/n), citation counts, publication year, 

tableprint = matrix(NA, nrow = 45, ncol = 9)
tableimport = read.csv("table MGCFA.csv")
#names(tableimport)

colnames(tableprint) = c("Scale Name", "Number of Scale Points", "N Not Random", "N Random", "Reliability", "Number of Items", "Number of Subscales", "Partial Invariance", "Where")

##need to add, "Did it Break Down(Y/N)", "Where it Broke Down", "Partial Invariance (Y/N)", "Citation Counts", "Publication Year"
tableprint[ , 1] = as.character(tableimport$scalename)
tableprint[ , 2] = as.character(tableimport$scaling)
tableprint[ , 5] = as.character(tableimport$reliability) 
tableprint[ , 7] = as.character(tableimport$subscales)

kable(tableprint, caption = "Final Table") %>%
  column_spec(1, width = "5cm")

```

```{r overalldata, include = FALSE}
master = read.csv("all_data_combined_edit.csv") ##might need to make an import data chunk maybe?
summary(master)
```

# Boredom Proness Scale
citation will go here

```{r BPS, include=FALSE}
##Reverse Code
##in the qualtrics true = 1, false = 2
##recode the false ones so that all 1s get 1 point, 
##all 2s should be coded as zero points

##make a new dataset with the columns we need 
bps = master[ , c(409:436, 955, 956, 14)]
names(bps)

bps$BP1 = recode(bps$BP1, "1='2'; 2='1'")
bps$BP7 = recode(bps$BP7, "1='2'; 2='1'")
bps$BP8 = recode(bps$BP8, "1='2'; 2='1'")
bps$BP11 = recode(bps$BP11, "1='2'; 2='1'")
bps$BP13 = recode(bps$BP13, "1='2'; 2='1'")
bps$BP15 = recode(bps$BP15, "1='2'; 2='1'")
bps$BP18 = recode(bps$BP18, "1='2'; 2='1'")
bps$BP22 = recode(bps$BP22, "1='2'; 2='1'")
bps$BP23 = recode(bps$BP23, "1='2'; 2='1'")
bps$BP24 = recode(bps$BP24, "1='2'; 2='1'")

##Make everything 0 and 1 to add up correctly
##true is 1, false is 2, so subtract 2 
names(bps)
bps[ , 1:28] = 2 - bps[ , 1:28]

####DATA SCREENING####

##Missing Data##
##Going by rows ONLY
notypos = bps
names(notypos)
missing = apply(notypos[ , 1:28], 1, percentmiss) 
table(missing)

##Replace only the data that you should
replacepeople = notypos[ missing <= 5 , ]  
dontpeople = notypos[ missing > 5 , ]

##Figure out the columns to exclude
##source, year, partno
apply(replacepeople, 2, percentmiss)
replacecolumn = replacepeople[ , -c(29,30,31)]
dontcolumn = replacepeople[ , c(29,30,31)]

##MICE
tempnomiss = mice(replacecolumn)
nomiss = complete(tempnomiss, 1)
summary(nomiss)

##(By your powers) Combine (I am Captain Planet!)
filledin_none = cbind(dontcolumn, nomiss)
summary(filledin_none)

##Small note: When MICE is run on this project the YEAR column
##is moved from the last column to the third column.
##This trend is not observed with data that does not need
##to be MICE'd. All code exluding ID columns has been corrected
##for this. 
#~Hannah 

##Outliers##
##Mahal
names(filledin_none)

mahal = mahalanobis(filledin_none[ , -c(1:3)], 
                    colMeans(filledin_none[ , -c(1:3)], na.rm = TRUE),
                    cov(filledin_none[ , -c(1:3)], use="pairwise.complete.obs"))

summary(mahal)
cutoff = qchisq(.999,ncol(filledin_none[ , -c(1:3)])) 
summary(mahal < cutoff)
noout = filledin_none[ mahal < cutoff, ]

##Additivity: correlations
correlations = cor(noout[,-c(1:3)], use="pairwise.complete.obs")
symnum(correlations)

##Make the random stuff & exclude the ID columns 
random = rchisq(nrow(noout), 7)
fake = lm(random~., data=noout[ , -c(1:3)])

##Linearity plot
##Create the standardized residuals
standardized = rstudent(fake)
{qqnorm(standardized)
abline(0,1)}

##Multivariate normality
hist(standardized, breaks=15)

##Homogeneity and homoscedaticity
fitvalues = scale(fake$fitted.values)
{plot(fitvalues, standardized) 
abline(0,0)
abline(v = 0)}

##Scoring
##This scale is true/false. The number of True and False for each question quantified below.
names(noout)
score = rowSums(noout[ , 4:31])
summary(score)

##Factoring source##
#Zero = notrandom, One = random, Two = paper
table(bps$source)
nooutnop = subset(noout, source != 'paper') ##excludes paper
nomissnop = subset(filledin_none, source != 'paper') ##excludes paper

notrandom = subset(nomissnop, source == 'not random') ##noout and filled in none same dataset
random = subset(nomissnop, source == 'random')

####overall cfa everyone together##
overallmodel = '
BP =~ BP1 + BP2 + BP3 + BP4 + BP5 + BP6 + BP7 + BP8 + 
      BP9 + BP10 + BP11 + BP12 + BP13 + BP14 + BP15 + 
      BP16 + BP17 + BP18 + BP19 + BP20 + BP21 + BP22 + 
      BP23 + BP24 + BP25 + BP26 + BP27 + BP28
'

overall.fit = cfa(overallmodel, 
                  data=nomissnop, 
                  meanstructure = TRUE)

summary(overall.fit, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE)

####separate group models####
##notrandom
overall.fit.nr = cfa(overallmodel, 
                    data=notrandom, 
                    meanstructure = TRUE)

summary(overall.fit.nr, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE)

##random
overall.fit.r = cfa(overallmodel, 
                    data=random, 
                    meanstructure = TRUE)

summary(overall.fit.r, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE)


####multi group testing####
###measurement invariance

multisteps = measurementInvariance(overallmodel, 
                                   data = nomissnop, 
                                   group = "source",
                                   strict = T)

fitmeasures(multisteps$fit.configural)
fitmeasures(multisteps$fit.loadings)
fitmeasures(multisteps$fit.intercepts)
fitmeasures(multisteps$fit.residuals)

tabletemp = measurementInvarianceTable(multisteps)
tabletemp = tabletemp[-5 , ]
if (sum(is.numeric(tabletemp$Dcfi > .01)) > 0) {PI = "Y"} else {PI = "N"}
if (PI == "Y") {
  wherebroke = rownames(tabletemp)[tabletemp$Dcfi > 0.01 ][2]
} else {wherebroke = "N/A"}

##scale name, number of scale points, sample size by group (2 columns), reliability, number of items, number of subscales
##did it break (y/n), where it broke, partial invariance (y/n), citation counts, publication year, 
tableprint[1, c(3, 4, 6, 8, 9)] = c(nrow(notrandom), nrow(random), ncol(random[ , -c(1:3)]), PI, wherebroke)

tableprint[1, c(3, 4, 6, 8, 9)]

```

```{r BPStable, echo = FALSE, results = 'asis'}
##columns Model, N, X2, df, RMSEA, SRMR, CFI, change CFI 
tableBPS = matrix(NA, nrow = 7, ncol = 8)
##rows will be: overall model, random, not random, multigroup steps 
tableBPS[ , 1] = c("Overall Model", "Random", "Not Random", 
                   "Configural", "Metric", "Scalar", "Strict")

fitused = c("chisq", "df", "rmsea", "srmr", "cfi")

tableBPS[1, 2:8 ] = c(nrow(nomissnop), 
                      fitmeasures(overall.fit, fit.measures = fitused), 
                      "-")
tableBPS[2, 2:8] = c(nrow(random), 
                      fitmeasures(overall.fit.r, fit.measures = fitused), 
                      "-")

tableBPS[3, 2:8] = c(nrow(notrandom), 
                      fitmeasures(overall.fit.nr, fit.measures = fitused), 
                      "-")

tableBPS[4, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.configural, fit.measures = fitused), 
                      "-")

tableBPS[5, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.loadings, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.loadings)["cfi"] - fitmeasures(multisteps$fit.configural)["cfi"])

tableBPS[6, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.intercepts, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.intercepts)["cfi"] - fitmeasures(multisteps$fit.loadings)["cfi"])

tableBPS[7, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.residuals, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.residuals)["cfi"] - fitmeasures(multisteps$fit.intercepts)["cfi"])

tableBPS[ , 3] = printnum(as.numeric(tableBPS[ , 3]), big.mark = "")
tableBPS[ , 5:8] = printnum(as.numeric(tableBPS[ , 5:8]), gt1 = F, digits = 3)


kable(tableBPS, 
      col.names = c("Model", "N", "Chi-Square", 
                       "df", "RMSEA", "SRMR", "CFI", "Change CFI"))
```

```{r BPS-SF, echo=FALSE}

bpssf = master[ , c(437:448, 14, 955,956)]
names(bpssf)

##No reverse coded items.

####DATA SCREENING####

##Going by rows ONLY
notypos = bpssf
names(notypos)
missing = apply(notypos[ , 1:12], 1, percentmiss) 
table(missing)

##Replace only the data that you should
replacepeople = notypos[ missing <= 5 , ]  
dontpeople = notypos[ missing > 5 , ]

##Figure out the columns to exclude
apply(replacepeople, 2, percentmiss)
replacecolumn = replacepeople[ , -c(13:15)]
dontcolumn = replacepeople[ , c(13:15)]

##MICE not needed here. If was we would have to replace and bind
nomiss = replacepeople ##no combine 

##Small note: When MICE is run on this project the YEAR column
##is moved from the last column to the thrid column.
##This trend is not observed with data that does not need
##to be MICE'd. All code exluding ID columns has been corrected
##for this. 
#~Hannah 

##Outliers##
##Mahal
names(nomiss)

mahal = mahalanobis(nomiss[ , -c(13:15)], 
                    colMeans(nomiss[ , -c(13:15)], na.rm = TRUE),
                    cov(nomiss[ , -c(13:15)], use="pairwise.complete.obs"))

summary(mahal)
cutoff = qchisq(.999,ncol(nomiss[ , -c(13:15)])) 
summary(mahal < cutoff)
noout = nomiss[ mahal < cutoff, ]

##Additivity: correlations
correlations = cor(noout[,-c(13:15)], use="pairwise.complete.obs")
symnum(correlations)

##Make the random stuff & exclude the ID columns 
random = rchisq(nrow(noout), 7)
fake = lm(random~., data=noout[ , -c(13:15)])

##get the linearity plot
##create the standardized residuals
standardized = rstudent(fake)
{qqnorm(standardized)
abline(0,1)}

##multivariate normality
hist(standardized, breaks=30)

##homogeneity and homoscedasticity
fitvalues = scale(fake$fitted.values)
{plot(fitvalues, standardized) 
abline(0,0)
abline(v = 0)}

##Scoring
#Internal 
internal = rowSums(noout[,c("BPSF1", "BPSF3", "BPSF5", "BPSF6", "BPSF8", "BPSF9")])
summary(internal)

#External 
external = rowSums(noout[,c("BPSF2", "BPSF4", "BPSF7", "BPSF10", "BPSF11", "BPSF12")])
summary(external)

##CFA with internal + external + noout datasets / need to drop paper
nooutnop = subset(noout, source != 'paper')
nomissnop = subset(nomiss, source != 'paper')


overallmodel = '
INT =~ BPSF1 + BPSF3 + BPSF5 + BPSF6 + BPSF8 + BPSF9
EXT =~ BPSF2 + BPSF4 + BPSF7 + BPSF10 + BPSF11 + BPSF12
'
fit = cfa(overallmodel, 
          data = nomissnop, 
          meanstructure = TRUE)

summary(fit, 
        standardized = TRUE, 
        rsquare = TRUE, 
        fit.measure = TRUE) ##no heywood cases 
fitMeasures(fit)

table(nomissnop$source)
##all significant 
## 0 is not random 
## 1 is random 
## 2 is paper 

##subset 
random = subset(nomissnop, source == 'random')
notrandom = subset(nomissnop, source =='not random')

##fit for random 
random.fit = cfa(overallmodel, 
                 data = random, 
                 meanstructure = TRUE)
summary(random.fit, 
        standardized = TRUE, 
        rsquare = TRUE, 
        fit.measure = TRUE)
fitMeasures(random.fit)

##fit for not random 
notrandom.fit = cfa(overallmodel, 
                 data = notrandom, 
                 meanstructure = TRUE)
summary(notrandom.fit, 
        standardized = TRUE, 
        rsquare = TRUE, 
        fit.measure = TRUE) ##this model seems better than random, let's see where it breaks down 
fitMeasures(notrandom.fit)

##invariances 
multisteps = measurementInvariance(overallmodel, 
                      data = nomissnop, 
                      group = 'source', 
                      strict = T)

fitMeasures(multisteps$fit.configural)
fitMeasures(multisteps$fit.loadings)
fitMeasures(multisteps$fit.intercepts)
fitMeasures(multisteps$fit.residuals)
fitMeasures(multisteps$fit.means)

##loadings seem to be related between groups 

##partials f/residuals
partial = partialInvariance(multisteps, 
                            type = "strict")

partial
strictfree = partial$results
group.partial = c("BPSF3~~BPSF3")

##after letting it go 
partialstrict = measurementInvariance(overallmodel, 
                                      data = nomissnop, 
                                      group = 'source', 
                                      strict = T, 
                                      group.partial = c("BPSF3~~BPSF3"))

fitMeasures(partialstrict$fit.residuals)


##scale name, number of scale points, sample size by group (2 columns), reliability, number of items, number of subscales
##did it break (y/n), where it broke, partial invariance (y/n), citation counts, publication year, 
tableprint[2, c(3, 4, 6, 8, 9)] = c(nrow(notrandom[, -c(1,2,15)]), nrow(random), ncol(random[ , -c(1,2,15)]), PI, wherebroke)

tableprint[2, c(3, 4, 6, 8, 9)]

```

```{r BPS-SFtable, echo = FALSE, results = 'asis'}
tableBPSSF = matrix(NA, nrow = 7, ncol = 8)
tableBPSSF[ , 1] = c("Overall Model", "Random", "Not Random", 
                   "Configural", "Metric", "Scalar", "Strict")

fitused = c("chisq", "df", "rmsea", "srmr", "cfi")

tableBPSSF[1, 2:8 ] = c(nrow(nomissnop), 
                      fitmeasures(overall.fit, fit.measures = fitused), 
                      "-")
tableBPSSF[2, 2:8] = c(nrow(random), 
                      fitmeasures(overall.fit.r, fit.measures = fitused), 
                      "-")

tableBPSSF[3, 2:8] = c(nrow(notrandom), 
                      fitmeasures(overall.fit.nr, fit.measures = fitused), 
                      "-")

tableBPSSF[4, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.configural, fit.measures = fitused), 
                      "-")

tableBPSSF[5, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.loadings, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.loadings)["cfi"] - fitmeasures(multisteps$fit.configural)["cfi"])

tableBPSSF[6, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.intercepts, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.intercepts)["cfi"] - fitmeasures(multisteps$fit.loadings)["cfi"])

tableBPSSF[7, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.residuals, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.residuals)["cfi"] - fitmeasures(multisteps$fit.intercepts)["cfi"])

tableBPSSF[ , 3] = printnum(as.numeric(tableBPSSF[ , 3]), big.mark = "")
tableBPSSF[ , 5:8] = printnum(as.numeric(tableBPSSF[ , 5:8]), gt1 = F, digits = 3)


kable(tableBPSSF, 
      col.names = c("Model", "N", "Chi-Square", 
                       "df", "RMSEA", "SRMR", "CFI", "Change CFI"))

```

```{r BRS, include=FALSE}
brs = master[ , c(850:855,14,955,956) ]
names(brs)

##Reverse coded items.
brs$BRS2 = recode(brs$BRS2, "1='5'; 2='4'; 3='3'; 4='2'; 5='1'")
brs$BRS4 = recode(brs$BRS4, "1='5'; 2='4'; 3='3'; 4='2'; 5='1'")
brs$BRS6 = recode(brs$BRS6, "1='5'; 2='4'; 3='3'; 4='2'; 5='1'")

####DATA SCREENING####

##Missing Data##

##Going by rows ONLY
notypos = brs
names(notypos)
missing = apply(notypos[ , 1:6], 1, percentmiss) 
table(missing)

##Replace only the data that you should
replacepeople = notypos[ missing <= 5 , ]  
dontpeople = notypos[ missing > 5 , ]

##Figure out the columns to exclude
apply(replacepeople, 2, percentmiss)
replacecolumn = replacepeople[ , -c(7:9)]
dontcolumn = replacepeople[ , c(7:9)]

##no missing data.
nomiss = replacepeople

##Outliers##
mahal = mahalanobis(nomiss[ , -c(7:9)], 
                    colMeans(nomiss[ , -c(7:9)], na.rm = TRUE),
                    cov(nomiss[ , -c(7:9)], use="pairwise.complete.obs"))
#mahal
summary(mahal)
cutoff = qchisq(.999,ncol(nomiss[ , -c(7:9)])) 
summary(mahal < cutoff)
noout = nomiss[ mahal < cutoff, ]

##additivity: correlations
correlations = cor(noout[,-c(7:9)], use="pairwise.complete.obs")
symnum(correlations)

##make the random stuff
random = rchisq(nrow(noout), 7)
##be sure here not to include the ID columns!
fake = lm(random~., data=noout[ , -c(7:9)])

##get the linearity plot
##create the standardized residuals
standardized = rstudent(fake)
{qqnorm(standardized)
abline(0,1)}

##multivariate normality
hist(standardized, breaks=15)

##homogeneity and homoscedaticity
fitvalues = scale(fake$fitted.values)
{plot(fitvalues, standardized) 
abline(0,0)
abline(v = 0)}

##Scoring
BRS <- rowSums(nomiss[, c(1:6)])
summary(BRS)

####CFA####
##subsetting data
#Zero = notrandom, One = random, Two = paper
##subset the data
nooutnop = subset(noout, source != 'paper')
nomissnop = subset(nomiss, source != 'paper')

notrandom = subset(nomissnop, source == 'not random')
random = subset(nomissnop, source == 'random')

####overall model for everyone together##
overallmodel = '
BRS =~
BRS1 + BRS2 + BRS3 + BRS4 + BRS5 + BRS6
'

overall.fit = cfa(model = overallmodel, 
                  data=nomissnop, 
                  meanstructure = TRUE)

summary(overall.fit, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE)

##random
overall.fit.r = cfa(overallmodel, 
                    data=random, 
                    meanstructure = TRUE)

summary(overall.fit.r, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE)

##notrandom
overall.fit.nr = cfa(overallmodel, 
                     data=notrandom, 
                     meanstructure = TRUE)

summary(overall.fit.nr, 
        standardized=TRUE,
        rsquare=TRUE, 
        fit.measure = TRUE)


####multi group testing####
###measurement invariance
multisteps = measurementInvariance(overallmodel, 
                                   data = nomissnop, 
                                   group = "source",
                                   strict = T)

fitmeasures(multisteps$fit.configural)
fitmeasures(multisteps$fit.loadings)
fitmeasures(multisteps$fit.intercepts)
fitmeasures(multisteps$fit.residuals)


##scale name, number of scale points, sample size by group (2 columns), reliability, number of items, number of subscales
##did it break (y/n), where it broke, partial invariance (y/n), citation counts, publication year, 

tableprint[3, c(3, 4, 6, 8, 9)] = c(nrow(notrandom[, -c(1,2,9)]), nrow(random), ncol(random[ , -c(1,2,9)]), PI, wherebroke)

tableprint[3, c(3, 4, 6, 8, 9)]
```

```{r BRStable, echo = FALSE, results = 'asis'}
tableBRS = matrix(NA, nrow = 7, ncol = 8)
tableBRS[ , 1] = c("Overall Model", "Random", "Not Random", 
                   "Configural", "Metric", "Scalar", "Strict")

fitused = c("chisq", "df", "rmsea", "srmr", "cfi")

tableBRS[1, 2:8 ] = c(nrow(nomissnop), 
                      fitmeasures(overall.fit, fit.measures = fitused), 
                      "-")
tableBRS[2, 2:8] = c(nrow(random), 
                      fitmeasures(overall.fit.r, fit.measures = fitused), 
                      "-")

tableBRS[3, 2:8] = c(nrow(notrandom), 
                      fitmeasures(overall.fit.nr, fit.measures = fitused), 
                      "-")

tableBRS[4, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.configural, fit.measures = fitused), 
                      "-")

tableBRS[5, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.loadings, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.loadings)["cfi"] - fitmeasures(multisteps$fit.configural)["cfi"])

tableBRS[6, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.intercepts, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.intercepts)["cfi"] - fitmeasures(multisteps$fit.loadings)["cfi"])

tableBRS[7, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.residuals, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.residuals)["cfi"] - fitmeasures(multisteps$fit.intercepts)["cfi"])

tableBRS[ , 3] = printnum(as.numeric(tableBRS[ , 3]), big.mark = "")
tableBRS[ , 5:8] = printnum(as.numeric(tableBRS[ , 5:8]), gt1 = F, digits = 3)


kable(tableBRS, 
      col.names = c("Model", "N", "Chi-Square", 
                       "df", "RMSEA", "SRMR", "CFI", "Change CFI"))

```


```{r DMS, include=FALSE}

dms = master[ ,c(449:470,14,955,956) ]
names(dms)


##Reverse Code. No reverse coding. Stopped here for scoring.
##fix text columns
dms$DMSTEXT8 = as.numeric(dms$DMSTEXT8)
dms$DMSTEXT11 = as.numeric(dms$DMSTEXT11)
dms$DMSTEXT13 = as.numeric(dms$DMSTEXT13)
##dr b I noticed this when fixing this one. there are a bunch of text columns other than this one. do they need to be fixed, too? leaving for now. - Jeff

####DATA SCREENING####
##Missing Data##

##Going by rows ONLY
notypos = dms
names(notypos)
missing = apply(notypos[ , 1:22], 1, percentmiss) 
table(missing)

##Replace only the data that you should
replacepeople = notypos[ missing <= 5 , ]  
dontpeople = notypos[ missing > 5 , ]

##Figure out the columns to exclude 
apply(replacepeople, 2, percentmiss)
replacecolumn = replacepeople[ , -c(23:25)]
dontcolumn = replacepeople[ , c(23:25)]

##MICE
tempnomiss = mice(replacecolumn)
nomiss = complete(tempnomiss, 1)
summary(nomiss)

##(By your powers) Combine (I am Captain Planet!)
filledin_none = cbind(dontcolumn, nomiss)
summary(filledin_none)

##Outliers##
##Mahal
names(filledin_none)
mahal = mahalanobis(filledin_none[ , -c(1:3)], 
                    colMeans(filledin_none[ , -c(1:3)], na.rm = TRUE),
                    cov(filledin_none[ , -c(1:3)], use="pairwise.complete.obs"))

summary(mahal)
cutoff = qchisq(.999,ncol(filledin_none[ , -c(1:3)])) 
summary(mahal < cutoff)
noout = filledin_none[ mahal < cutoff, ]

##additivity: correlations
correlations = cor(noout[,-c(1:3)], use="pairwise.complete.obs")
symnum(correlations)

##make the random stuff 
random = rchisq(nrow(noout), 7)
fake = lm(random~., data=noout[ , -c(1:3)])

##get the linearity plot
##create the standardized residuals
standardized = rstudent(fake)
{qqnorm(standardized)
abline(0,1)}

##multivariate normality
hist(standardized, breaks=15)

##homogeneity and homoscedaticity
fitvalues = scale(fake$fitted.values)
{plot(fitvalues, standardized) 
abline(0,0)
abline(v = 0)}

##Scoring
##Daily Meaning average Q1 & Q2 (Col 4&5 in dataset)
daymean <- rowMeans(filledin_none[,c("DMS1", "DMS2")])
summary(daymean)

daylife <- filledin_none$DMS3
summary(daylife)

Eud <- rowSums(filledin_none[,c(5:11)])
summary(Eud)

Hed <- rowSums(filledin_none[,c(12:22)])
summary(Hed)


##MGCFA

##Factoring source##
#Zero = notrandom, One = random, Two = paper
nooutnop = subset(noout, source != 'paper')
nomissnop = subset(filledin_none, source != 'paper')

notrandom = subset(nomissnop, source == 'not random')
random = subset(nomissnop, source == 'random')

##Model 
##we will need to exclude the two smaller subscales
##do not have enough questions for CFA
overallmodel = '
EudaimonicBehaviors =~ DMSTEXT1 + DMSTEXT2 + DMSTEXT3 + DMSTEXT4 + DMSTEXT5 + DMSTEXT6 + DMSTEXT7
HedonicBehaviors =~ DMSTEXT8 + DMSTEXT9 + DMSTEXT10 + DMSTEXT11 + DMSTEXT12 + DMSTEXT13 + DMSTEXT14 +  DMSTEXT15 + DMSTEXT16 + DMSTEXT17 + DMSTEXT18 + DMSTEXT19
'
overall.fit = cfa(overallmodel, 
                  data=nomissnop, 
                  meanstructure = TRUE)

summary(overall.fit, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE)

####separate group models####
##notrandom
overall.fit.nr = cfa(overallmodel, 
                     data=notrandom, 
                     meanstructure = TRUE)

summary(overall.fit.nr, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE)

##random
overall.fit.r = cfa(overallmodel, 
                    data=random, 
                    meanstructure = TRUE)

summary(overall.fit.r, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE)


####multi group testing####
###measurement invariance

multisteps = measurementInvariance(overallmodel, 
                                   data = nomissnop, 
                                   group = "source",
                                   strict = T)

fitmeasures(multisteps$fit.configural)
fitmeasures(multisteps$fit.loadings)
fitmeasures(multisteps$fit.intercepts)
fitmeasures(multisteps$fit.residuals)

##scale name, number of scale points, sample size by group (2 columns), reliability, number of items, number of subscales
##did it break (y/n), where it broke, partial invariance (y/n), citation counts, publication year, 

tableprint[4, c(3, 4, 6, 8, 9)] = c(nrow(notrandom[, -c(1,2,3)]), nrow(random), ncol(random[ , -c(1,2,3)]), PI, wherebroke)

tableprint[4, c(3, 4, 6, 8, 9)]

```


```{r DMStable, echo = FALSE, results = 'asis'}
tableDMS = matrix(NA, nrow = 7, ncol = 8)
tableDMS[ , 1] = c("Overall Model", "Random", "Not Random", 
                   "Configural", "Metric", "Scalar", "Strict")

fitused = c("chisq", "df", "rmsea", "srmr", "cfi")

tableDMS[1, 2:8 ] = c(nrow(nomissnop), 
                      fitmeasures(overall.fit, fit.measures = fitused), 
                      "-")
tableDMS[2, 2:8] = c(nrow(random), 
                      fitmeasures(overall.fit.r, fit.measures = fitused), 
                      "-")

tableDMS[3, 2:8] = c(nrow(notrandom), 
                      fitmeasures(overall.fit.nr, fit.measures = fitused), 
                      "-")

tableDMS[4, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.configural, fit.measures = fitused), 
                      "-")

tableDMS[5, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.loadings, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.loadings)["cfi"] - fitmeasures(multisteps$fit.configural)["cfi"])

tableDMS[6, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.intercepts, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.intercepts)["cfi"] - fitmeasures(multisteps$fit.loadings)["cfi"])

tableDMS[7, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.residuals, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.residuals)["cfi"] - fitmeasures(multisteps$fit.intercepts)["cfi"])

tableDMS[ , 3] = printnum(as.numeric(tableDMS[ , 3]), big.mark = "")
tableDMS[ , 5:8] = printnum(as.numeric(tableDMS[ , 5:8]), gt1 = F, digits = 3)


kable(tableDMS, 
      col.names = c("Model", "N", "Chi-Square", 
                       "df", "RMSEA", "SRMR", "CFI", "Change CFI"))

```


```{r ELM, include=FALSE}

elm = master[ , c(740:779,14,955,956)]
names(elm)

##Reverse Code. No Reverse Coding.

####DATA SCREENING####

##Missing Data##

##Going by rows ONLY
##here I excluded the first two columns because they were 
##included for everyone as IDs, so I don't want to count that
##as part of the percent toward what they did
notypos = elm
names(notypos)
missing = apply(notypos[ , 1:40], 1, percentmiss) 
table(missing)

##replace only the data that you should
replacepeople = notypos[ missing <= 5 , ]  
dontpeople = notypos[ missing > 5 , ]

##figure out the columns to exclude (survey data)
apply(replacepeople, 2, percentmiss)
replacecolumn = replacepeople[ , -c(41:43)]
dontcolumn = replacepeople[ , c(41:43)]

##let's mice it!
tempnomiss = mice(replacecolumn)
nomiss = complete(tempnomiss, 1)
summary(nomiss)

##put everything back together
filledin_none = cbind(dontcolumn, nomiss)
summary(filledin_none)

##Outliers##
names(filledin_none)
mahal = mahalanobis(filledin_none[ , -c(1:3)], 
                    colMeans(filledin_none[ , -c(1:3)], na.rm = TRUE),
                    cov(filledin_none[ , -c(1:3)], use="pairwise.complete.obs"))

summary(mahal)
cutoff = qchisq(.999,ncol(filledin_none[ , -c(1:3)])) 
summary(mahal < cutoff)
noout = filledin_none[ mahal < cutoff, ]

##additivity: correlations
correlations = cor(noout[,-c(1:3)], use="pairwise.complete.obs")
symnum(correlations)

##make the random stuff
random = rchisq(nrow(noout), 7)
##be sure here not to include the ID columns!
fake = lm(random~., data=noout[ , -c(1:3)])

##get the linearity plot
##create the standardized residuals
standardized = rstudent(fake)
{qqnorm(standardized)
abline(0,1)}

##multivariate normality
hist(standardized, breaks=15)

##homogeneity and homoscedaticity
fitvalues = scale(fake$fitted.values)
{plot(fitvalues, standardized) 
abline(0,0)
abline(v = 0)}

##Scoring
ELM <- rowSums(filledin_none[, c(1:40)])
summary(ELM)

##data sets
nooutnop = subset(noout, source != 'paper')
nomissnop = subset(filledin_none, source != 'paper')

notrandom = subset(nomissnop, source == 'not random')
random = subset(nomissnop, source == 'random')

overallmodel = '
RS =~ ELM1 + ELM2 + ELM3 + ELM4 + ELM5 + ELM6 + ELM7 + ELM8 +
ELM9 + ELM10 + ELM11 + ELM12 + ELM13 + ELM14 + ELM15 + ELM16 +
ELM17 + ELM18 + ELM19 + ELM20 + ELM21 + ELM22 + ELM23 + ELM24 +
ELM25 + ELM26 + ELM27 + ELM28 + ELM28 + ELM29 + ELM30 + ELM31 +
ELM32 + ELM33 + ELM34 + ELM35 + ELM36 + ELM37 + ELM38 + ELM39 +
ELM40' 


##fit for overall (excluding paper)
overall.fit = cfa(model = overallmodel, 
                  data = nomissnop, 
                  meanstructure = TRUE)

summary(overall.fit, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE) ##no heywood cases

##fit for random 
random.fit = cfa(overallmodel, 
                 data = random, 
                 meanstructure = TRUE)
summary(random.fit, 
        standardized = TRUE, 
        rsquare = TRUE, 
        fit.measure = TRUE)

##fit for not random 
notrandom.fit = cfa(overallmodel, 
                    data = notrandom, 
                    meanstructure = TRUE)
summary(notrandom.fit, 
        standardized = TRUE, 
        rsquare = TRUE, 
        fit.measure = TRUE)



multisteps = measurementInvariance(overallmodel, 
                                   data = nomissnop, 
                                   group = 'source', 
                                   strict = T)

fitmeasures(multisteps$fit.configural)
fitmeasures(multisteps$fit.loadings)
fitmeasures(multisteps$fit.intercepts)
fitmeasures(multisteps$fit.residuals)

## It broke down at Scalar Invariance 

partial = partialInvariance(multisteps, 
                            type = "intercepts")
##save only the results for easier viewing
interceptsfree = partial$results

##click on the name, sort by FREE CFI 
##release the biggest one first

multisteps2 = measurementInvariance(overallmodel,  
                                    data = nomissnop, 
                                    group = "source",
                                    strict = T,
                                    group.partial = c(ELM19~1 , ELM15~1 ,
                                                        ELM11~1, ELM23~1 ,
                                                      ELM9~1, ELM16~1, ELM_2~1))

## Allow for question 19, 15, 11, 23, 9, 16, and 2 to vary


##scale name, number of scale points, sample size by group (2 columns), reliability, number of items, number of subscales
##did it break (y/n), where it broke, partial invariance (y/n), citation counts, publication year, 

tableprint[5, c(3, 4, 6, 8, 9)] = c(nrow(notrandom[, -c(1,2,3)]), nrow(random), ncol(random[ , -c(1,2,3)]), PI, wherebroke)

tableprint[5, c(3, 4, 6, 8, 9)]

```


```{r ELMtable, echo = FALSE, results = 'asis'}
tableELM = matrix(NA, nrow = 7, ncol = 8)
tableELM[ , 1] = c("Overall Model", "Random", "Not Random", 
                   "Configural", "Metric", "Scalar", "Strict")

fitused = c("chisq", "df", "rmsea", "srmr", "cfi")

tableELM[1, 2:8 ] = c(nrow(nomissnop), 
                      fitmeasures(overall.fit, fit.measures = fitused), 
                      "-")
tableELM[2, 2:8] = c(nrow(random), 
                      fitmeasures(overall.fit.r, fit.measures = fitused), 
                      "-")

tableELM[3, 2:8] = c(nrow(notrandom), 
                      fitmeasures(overall.fit.nr, fit.measures = fitused), 
                      "-")

tableELM[4, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps2$fit.configural, fit.measures = fitused), 
                      "-")

tableELM[5, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps2$fit.loadings, fit.measures = fitused), 
                      fitmeasures(multisteps2$fit.loadings)["cfi"] - fitmeasures(multisteps2$fit.configural)["cfi"])

tableELM[6, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps2$fit.intercepts, fit.measures = fitused), 
                      fitmeasures(multisteps2$fit.intercepts)["cfi"] - fitmeasures(multisteps2$fit.loadings)["cfi"])

tableELM[7, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps2$fit.residuals, fit.measures = fitused), 
                      fitmeasures(multisteps2$fit.residuals)["cfi"] - fitmeasures(multisteps2$fit.intercepts)["cfi"])

tableELM[ , 3] = printnum(as.numeric(tableELM[ , 3]), big.mark = "")
tableELM[ , 5:8] = printnum(as.numeric(tableELM[ , 5:8]), gt1 = F, digits = 3)


kable(tableELM, 
      col.names = c("Model", "N", "Chi-Square", 
                       "df", "RMSEA", "SRMR", "CFI", "Change CFI"))

##check to make sure we use multisteps2 here instead of multisteps

```


```{r ELQ, include=FALSE}

elq = master[ , c(66:84, 14,955,956)]
names(elq)

##reverse items 2, 7, 14, 18
names(elq)
elq[ , c(2, 7, 14, 18)] = 6 - elq[ , c(2, 7, 14, 18)]

####DATA SCREENING####

##Missing Data##

##Going by rows ONLY
notypos = elq
missing = apply(notypos[ , 1:19], 1, percentmiss) 
table(missing)

##replace only the data that you should
replacepeople = notypos[ missing <= 5 , ]  
dontpeople = notypos[ missing > 5 , ]

##figure out the columns to exclude (survey data)
apply(replacepeople, 2, percentmiss)
replacecolumn = replacepeople[ , -c(20:22)]
dontcolumn = replacepeople[ , c(20:22)]

nomiss = replacepeople
names(nomiss)

##Outliers##
mahal = mahalanobis(nomiss[ , -c(20:22)], 
                    colMeans(nomiss[ , -c(20:22)], na.rm = TRUE),
                    cov(nomiss[ , -c(20:22)], use="pairwise.complete.obs"))

summary(mahal)
cutoff = qchisq(.999,ncol(nomiss[ , -c(20:22)])) 
summary(mahal < cutoff)
noout = nomiss[ mahal < cutoff, ]

##additivity: correlations
correlations = cor(noout[,-c(20:22)], use="pairwise.complete.obs")
symnum(correlations)

##make the random stuff
random = rchisq(nrow(noout), 7)
##be sure here not to include the ID columns!
fake = lm(random~., data=noout[ , -c(20:22)])

##get the linearity plot
##create the standardized residuals
standardized = rstudent(fake)
{qqnorm(standardized)
abline(0,1)}

##multivariate normality
hist(standardized, breaks=15)

##homogeneity and homoscedaticity
fitvalues = scale(fake$fitted.values)
{plot(fitvalues, standardized) 
abline(0,0)
abline(v = 0)}

##Scoring 
ELQ <- rowSums(nomiss[, -c(20:22)])
summary(ELQ)

####overall cfa everyone together####

nooutnop = subset(noout, source != 'paper')
nomissnop = subset(nomiss, source != 'paper')

notrandom = subset(nomissnop, source == 'not random')
random = subset(nomissnop, source == 'random')

overallmodel = '
ELQ =~ ELQ1 + ELQ2 + ELQ3 + ELQ4 + ELQ5 + ELQ6 + ELQ7 + ELQ8 + ELQ9 + ELQ10 + ELQ11 + ELQ12 + ELQ13 + ELQ14 +
ELQ15 + ELQ16 + ELQ17 + ELQ18 + ELQ19 + ELQ20 + ELQ21
'

##CFA

##fit for overall (excluding paper)
overall.fit = cfa(model = overallmodel, 
                  data = nomissnop, 
                  meanstructure = TRUE)

summary(overall.fit, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE) ##no heywood cases

##fit for random 
random.fit = cfa(overallmodel, 
                 data = random, 
                 meanstructure = TRUE)
summary(random.fit, 
        standardized = TRUE, 
        rsquare = TRUE, 
        fit.measure = TRUE)

##fit for not random 
notrandom.fit = cfa(overallmodel, 
                    data = notrandom, 
                    meanstructure = TRUE)
summary(notrandom.fit, 
        standardized = TRUE, 
        rsquare = TRUE, 
        fit.measure = TRUE)


multisteps = measurementInvariance(overallmodel, 
                                   data = nomissnop, 
                                   group = 'source', 
                                   strict = T)

fitmeasures(multisteps$fit.configural)
fitmeasures(multisteps$fit.loadings)
fitmeasures(multisteps$fit.intercepts)
fitmeasures(multisteps$fit.residuals)

##It broke down on the Scalar Invariance level

partial = partialInvariance(multisteps, 
                            type = "intercepts")
##save only the results for easier viewing
interceptsfree = partial$results

##click on the name, sort by FREE CFI
##release the biggest one first

multisteps2 = measurementInvariance(overallmodel, 
                                    data = nomissnop, 
                                    group = "source",
                                    strict = T,
                                    group.partial = c("ELQ19~1"))

##scale name, number of scale points, sample size by group (2 columns), reliability, number of items, number of subscales
##did it break (y/n), where it broke, partial invariance (y/n), citation counts, publication year, 

tableprint[6, c(3, 4, 6, 8, 9)] = c(nrow(notrandom[, -c(1,2,22)]), nrow(random), ncol(random[ , -c(1,2,22)]), PI, wherebroke)

tableprint[6, c(3, 4, 6, 8, 9)]

```


```{r ELQtable, echo = FALSE, results = 'asis'}
tableELQ = matrix(NA, nrow = 7, ncol = 8)
tableELQ[ , 1] = c("Overall Model", "Random", "Not Random", 
                   "Configural", "Metric", "Scalar", "Strict")

fitused = c("chisq", "df", "rmsea", "srmr", "cfi")

tableELQ[1, 2:8 ] = c(nrow(nomissnop), 
                      fitmeasures(overall.fit, fit.measures = fitused), 
                      "-")
tableELQ[2, 2:8] = c(nrow(random), 
                      fitmeasures(overall.fit.r, fit.measures = fitused), 
                      "-")

tableELQ[3, 2:8] = c(nrow(notrandom), 
                      fitmeasures(overall.fit.nr, fit.measures = fitused), 
                      "-")

tableELQ[4, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps2$fit.configural, fit.measures = fitused), 
                      "-")

tableELQ[5, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps2$fit.loadings, fit.measures = fitused), 
                      fitmeasures(multisteps2$fit.loadings)["cfi"] - fitmeasures(multisteps2$fit.configural)["cfi"])

tableELQ[6, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps2$fit.intercepts, fit.measures = fitused), 
                      fitmeasures(multisteps2$fit.intercepts)["cfi"] - fitmeasures(multisteps2$fit.loadings)["cfi"])

tableELQ[7, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps2$fit.residuals, fit.measures = fitused), 
                      fitmeasures(multisteps2$fit.residuals)["cfi"] - fitmeasures(multisteps2$fit.intercepts)["cfi"])

tableELQ[ , 3] = printnum(as.numeric(tableELQ[ , 3]), big.mark = "")
tableELQ[ , 5:8] = printnum(as.numeric(tableELQ[ , 5:8]), gt1 = F, digits = 3)


kable(tableELQ, 
      col.names = c("Model", "N", "Chi-Square", 
                       "df", "RMSEA", "SRMR", "CFI", "Change CFI"))

##double check to make sure we use multisteps2 instead of multisteps1

```


```{r EMAS, include=FALSE}

emas = master[ , c(606:617,14,955,956)]
names(emas)

##No reverse coded items.

####DATA SCREENING####

##Missing Data##

##Going by rows ONLY
notypos = emas
names(notypos)
missing = apply(notypos[ , 1:12], 1, percentmiss) 
table(missing)

##Replace only the data that you should
replacepeople = notypos[ missing <= 5 , ]  
dontpeople = notypos[ missing > 5 , ]

##figure out the columns to exclude (survey data)
apply(replacepeople, 2, percentmiss)
replacecolumn = replacepeople[ , -c(13:15)]
dontcolumn = replacepeople[ , c(13:15)]

nomiss = replacepeople
names(nomiss)

##Outliers##
mahal = mahalanobis(nomiss[ , -c(13:15)], 
                    colMeans(nomiss[ , -c(13:15)], na.rm = TRUE),
                    cov(nomiss[ , -c(13:15)], use="pairwise.complete.obs"))

summary(mahal)
cutoff = qchisq(.999,ncol(nomiss[ , -c(13:15)])) 
summary(mahal < cutoff)
noout = nomiss[ mahal < cutoff, ]

##additivity: correlations
correlations = cor(noout[,-c(13:15)], use="pairwise.complete.obs")
symnum(correlations)

##make the random stuff
random = rchisq(nrow(noout), 7)
##be sure here not to include the ID columns!
fake = lm(random~., data=noout[ , -c(13:15)])

##get the linearity plot
##create the standardized residuals
standardized = rstudent(fake)
{qqnorm(standardized)
abline(0,1)}

##multivariate normality
hist(standardized, breaks=15)

##homogeneity and homoscedaticity
fitvalues = scale(fake$fitted.values)
{plot(fitvalues, standardized) 
abline(0,0)
abline(v = 0)}

##Scoring
##Sum up all columns 
EMAS <- rowSums(nomiss[1:12])
summary(EMAS)

####CFA####
##subsetting data
#Zero = notrandom, One = random, Two = paper
nooutnop = subset(noout, source != 'paper')
nomissnop = subset(nomiss, source != 'paper')

notrandom = subset(nomissnop, source == 'not random')
random = subset(nomissnop, source == 'random')

####overall model for everyone together##
overallmodel = '
EMAS =~
EMAS1 + EMAS2 + EMAS3 + EMAS4 + EMAS5 + EMAS6 + EMAS7 
+ EMAS8 + EMAS9 + EMAS10 + EMAS11 + EMAS12
'

overall.fit = cfa(model = overallmodel, 
                  data=nomissnop, 
                  meanstructure = TRUE)

summary(overall.fit, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE)

##random
overall.fit.r = cfa(overallmodel, 
                    data=random, 
                    meanstructure = TRUE)

summary(overall.fit.r, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE)

##notrandom
overall.fit.nr = cfa(overallmodel, 
                     data=notrandom, 
                     meanstructure = TRUE)

summary(overall.fit.nr, 
        standardized=TRUE,
        rsquare=TRUE, 
        fit.measure = TRUE)


####multi group testing####
###measurement invariance

multisteps = measurementInvariance(overallmodel, 
                                   data = nomissnop, 
                                   group = "source",
                                   strict = T)

fitmeasures(multisteps$fit.configural)
fitmeasures(multisteps$fit.loadings)
fitmeasures(multisteps$fit.intercepts)
fitmeasures(multisteps$fit.residuals)

##scale name, number of scale points, sample size by group (2 columns), reliability, number of items, number of subscales
##did it break (y/n), where it broke, partial invariance (y/n), citation counts, publication year, 

tableprint[7, c(3, 4, 6, 8, 9)] = c(nrow(notrandom[, -c(1,2,15)]), nrow(random), ncol(random[ , -c(1,2,15)]), PI, wherebroke)

tableprint[7, c(3, 4, 6, 8, 9)]

```


```{r EMAStable, echo = FALSE, results = 'asis'}
tableEMAS = matrix(NA, nrow = 7, ncol = 8)
tableEMAS[ , 1] = c("Overall Model", "Random", "Not Random", 
                   "Configural", "Metric", "Scalar", "Strict")

fitused = c("chisq", "df", "rmsea", "srmr", "cfi")

tableEMAS[1, 2:8 ] = c(nrow(nomissnop), 
                      fitmeasures(overall.fit, fit.measures = fitused), 
                      "-")
tableEMAS[2, 2:8] = c(nrow(random), 
                      fitmeasures(overall.fit.r, fit.measures = fitused), 
                      "-")

tableEMAS[3, 2:8] = c(nrow(notrandom), 
                      fitmeasures(overall.fit.nr, fit.measures = fitused), 
                      "-")

tableEMAS[4, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.configural, fit.measures = fitused), 
                      "-")

tableEMAS[5, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.loadings, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.loadings)["cfi"] - fitmeasures(multisteps$fit.configural)["cfi"])

tableEMAS[6, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.intercepts, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.intercepts)["cfi"] - fitmeasures(multisteps$fit.loadings)["cfi"])

tableEMAS[7, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.residuals, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.residuals)["cfi"] - fitmeasures(multisteps$fit.intercepts)["cfi"])

tableEMAS[ , 3] = printnum(as.numeric(tableEMAS[ , 3]), big.mark = "")
tableEMAS[ , 5:8] = printnum(as.numeric(tableEMAS[ , 5:8]), gt1 = F, digits = 3)


kable(tableEMAS, 
      col.names = c("Model", "N", "Chi-Square", 
                       "df", "RMSEA", "SRMR", "CFI", "Change CFI"))

```


```{r EMS, include=FALSE}

ems = master[ , c(471:490, 14,955,956)]
summary(ems)
names(ems)

##Reverse Code. 1, 4, 7, 8, 9, 10, 13, 17, 19
##the paper says that seven of them were reverse coded but doesn't say which
##these items definitely are reversed given the histograms
ems[ , c(1, 4, 7:10, 13, 17, 19)] = 6 - ems[ , c(1, 4, 7:10, 13, 17, 19)] 

####DATA SCREENING####

##Missing Data##

##Going by rows ONLY
##here I excluded the first two columns because they were 
##included for everyone as IDs, so I don't want to count that
##as part of the percent toward what they did
notypos = ems
missing = apply(notypos[ , 1:20], 1, percentmiss) 
table(missing)

##replace only the data that you should
replacepeople = notypos[ missing <= 5 , ]  
dontpeople = notypos[ missing > 5 , ]

##figure out the columns to exclude (survey data)
apply(replacepeople, 2, percentmiss)
replacecolumn = replacepeople[ , -c(21:23)]
dontcolumn = replacepeople[ , c(21:23)]

##let's mice it!
tempnomiss = mice(replacecolumn)
nomiss = complete(tempnomiss, 1)
summary(nomiss)

##put everything back together
filledin_none = cbind(dontcolumn, nomiss)
summary(filledin_none)

##Outliers##
names(filledin_none)
mahal = mahalanobis(filledin_none[ , -c(1:3)], 
                    colMeans(filledin_none[ , -c(1:3)], na.rm = TRUE),
                    cov(filledin_none[ , -c(1:3)], use="pairwise.complete.obs"))

cutoff = qchisq(.999,ncol(filledin_none[ , -c(1:3)])) 
summary(mahal < cutoff)
noout = filledin_none[ mahal < cutoff, ]

##additivity: correlations
correlations = cor(noout[,-c(1:3)], use="pairwise.complete.obs")
symnum(correlations)

##make the random stuff
random = rchisq(nrow(noout), 7)
fake = lm(random~., data=noout[ , -c(1:3)])

##get the linearity plot
##create the standardized residuals
standardized = rstudent(fake)
{qqnorm(standardized)
abline(0,1)}

##multivariate normality
hist(standardized, breaks=15)

##homogeneity and homoscedaticity
fitvalues = scale(fake$fitted.values)
{plot(fitvalues, standardized) 
abline(0,0)
abline(v = 0)}

##Scoring 
EMS <- rowSums(filledin_none[, c(2,6,7,9,10,15,16,18,19,20)])
summary(EMS)

####mgcfa####

nooutnop = subset(noout, source != 'paper')
nomissnop = subset(filledin_none, source != 'paper')

notrandom = subset(nomissnop, source == 'not random')
random = subset(nomissnop, source == 'random')


overallmodel = '
EMS =~ EMS1 + EMS6 + EMS6  + EMS8 + EMS9 +
EMS14 + EMS15 + EMS17 + EMS18 + EMS19'

##fit for overall (excluding paper)
overall.fit = cfa(model = overallmodel, 
                  data = nomissnop, 
                  meanstructure = TRUE)

summary(overall.fit, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE) ##no heywood cases

##fit for random 
random.fit = cfa(overallmodel, 
                 data = random, 
                 meanstructure = TRUE)
summary(random.fit, 
        standardized = TRUE, 
        rsquare = TRUE, 
        fit.measure = TRUE)

##fit for not random 
notrandom.fit = cfa(overallmodel, 
                    data = notrandom, 
                    meanstructure = TRUE)
summary(notrandom.fit, 
        standardized = TRUE, 
        rsquare = TRUE, 
        fit.measure = TRUE)


multisteps = measurementInvariance(overallmodel, 
                                   data = nomissnop, 
                                   group = 'source', 
                                   strict = T)

fitmeasures(multisteps$fit.configural)
fitmeasures(multisteps$fit.loadings)
fitmeasures(multisteps$fit.intercepts)
fitmeasures(multisteps$fit.residuals)

##scale name, number of scale points, sample size by group (2 columns), reliability, number of items, number of subscales
##did it break (y/n), where it broke, partial invariance (y/n), citation counts, publication year, 

tableprint[8, c(3, 4, 6, 8, 9)] = c(nrow(notrandom[, -c(1:3)]), nrow(random), ncol(random[ , -c(1:3)]), PI, wherebroke)

tableprint[8, c(3, 4, 6, 8, 9)]


```


```{r EMStable, echo = FALSE, results = 'asis'}
tableEMS = matrix(NA, nrow = 7, ncol = 8)
tableEMS[ , 1] = c("Overall Model", "Random", "Not Random", 
                   "Configural", "Metric", "Scalar", "Strict")

fitused = c("chisq", "df", "rmsea", "srmr", "cfi")

tableEMS[1, 2:8 ] = c(nrow(nomissnop), 
                      fitmeasures(overall.fit, fit.measures = fitused), 
                      "-")
tableEMS[2, 2:8] = c(nrow(random), 
                      fitmeasures(overall.fit.r, fit.measures = fitused), 
                      "-")

tableEMS[3, 2:8] = c(nrow(notrandom), 
                      fitmeasures(overall.fit.nr, fit.measures = fitused), 
                      "-")

tableEMS[4, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.configural, fit.measures = fitused), 
                      "-")

tableEMS[5, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.loadings, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.loadings)["cfi"] - fitmeasures(multisteps$fit.configural)["cfi"])

tableEMS[6, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.intercepts, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.intercepts)["cfi"] - fitmeasures(multisteps$fit.loadings)["cfi"])

tableEMS[7, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.residuals, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.residuals)["cfi"] - fitmeasures(multisteps$fit.intercepts)["cfi"])

tableEMS[ , 3] = printnum(as.numeric(tableEMS[ , 3]), big.mark = "")
tableEMS[ , 5:8] = printnum(as.numeric(tableEMS[ , 5:8]), gt1 = F, digits = 3)


kable(tableEMS, 
      col.names = c("Model", "N", "Chi-Square", 
                       "df", "RMSEA", "SRMR", "CFI", "Change CFI"))

```


```{r ES, include=FALSE}

es = master [, c(20:65,14,955,956)]
names(es)

##Reverse Code. 2, 15, 21, 26, 36
names(es)
es$ES2 = recode(es$ES2, "1='7'; 2='6'; 3='5'; 4='4'; 5='3'; 6='2'; 7='1'")
es$ES15 = recode(es$ES15, "1='7'; 2='6'; 3='5'; 4='4'; 5='3'; 6='2'; 7='1'")
es$ES21 = recode(es$ES21, "1='7'; 2='6'; 3='5'; 4='4'; 5='3'; 6='2'; 7='1'")
es$ES26 = recode(es$ES26, "1='7'; 2='6'; 3='5'; 4='4'; 5='3'; 6='2'; 7='1'")
es$ES36 = recode(es$ES36, "1='7'; 2='6'; 3='5'; 4='4'; 5='3'; 6='2'; 7='1'")

####DATA SCREENING####

##Missing Data##

##Going by rows ONLY
##here I excluded the first two columns because they were 
##included for everyone as IDs, so I don't want to count that
##as part of the percent toward what they did
notypos = es
missing = apply(notypos[ , 1:46], 1, percentmiss) 
table(missing)

##replace only the data that you should
replacepeople = notypos[ missing <= 5 , ]  
dontpeople = notypos[ missing > 5 , ]

##figure out the columns to exclude (survey data)
apply(replacepeople, 2, percentmiss)
replacecolumn = replacepeople[ , -c(47:49)]
dontcolumn = replacepeople[ , c(47:49)]

##let's mice it!
tempnomiss = mice(replacecolumn)
nomiss = complete(tempnomiss, 1)
summary(nomiss)

##put everything back together
filledin_none = cbind(dontcolumn, nomiss)
summary(filledin_none)


##Outliers##
names(filledin_none)
mahal = mahalanobis(filledin_none[ , -c(1:3)], 
                    colMeans(filledin_none[ , -c(1:3)], na.rm = TRUE),
                    cov(filledin_none[ , -c(1:3)], use="pairwise.complete.obs"))

summary(mahal)
cutoff = qchisq(.999,ncol(filledin_none[ , -c(1:3)])) 
summary(mahal < cutoff)
noout = filledin_none[ mahal < cutoff, ]

##additivity: correlations
correlations = cor(noout[,-c(1:3)], use="pairwise.complete.obs")
symnum(correlations)

##make the random stuff
random = rchisq(nrow(noout), 7)
##be sure here not to include the ID columns!
fake = lm(random~., data=noout[ , -c(1:3)])

#get the linearity plot
##create the standardized residuals
standardized = rstudent(fake)
{qqnorm(standardized)
abline(0,1)}

##multivariate normality
hist(standardized, breaks=15)

##homogeneity and homoscedaticity
fitvalues = scale(fake$fitted.values)
{plot(fitvalues, standardized) 
abline(0,0)
abline(v = 0)}

#MGCFA

##Factoring source##
#Zero = notrandom, One = random, Two = paper
nooutnop = subset(noout, source != 'paper')
nomissnop = subset(filledin_none, source != 'paper')

notrandom = subset(nomissnop, source == 'not random')
random = subset(nomissnop, source == 'random')

##Model 
overallmodel = '
SelfDistance =~ ES3 + ES5 + ES19 + ES32 + ES40 + ES42 + ES43 + ES44
SelfTrans =~ ES2 + ES4 + ES11 + ES12 + ES13 + ES14 + ES21 + ES27 + ES33 + ES34 + ES35 + ES36 + ES41 + ES45
Freedom =~ ES9 + ES10 + ES15 + ES17 + ES18 + ES23 + ES24 + ES26 + ES28 + ES31 + ES46
Responsibility =~ ES1 + ES6 + ES7 + ES8 + ES16 + ES20 + ES22 + ES25 + ES29 + ES30 + ES37 + ES38 + ES39
'
overall.fit = cfa(overallmodel, 
                  data=nomissnop, 
                  meanstructure = TRUE)

summary(overall.fit, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE)

####separate group models####
##notrandom
overall.fit.nr = cfa(overallmodel, 
                     data=notrandom, 
                     meanstructure = TRUE)

summary(overall.fit.nr, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE)

##random
overall.fit.r = cfa(overallmodel, 
                    data=random, 
                    meanstructure = TRUE)

summary(overall.fit.r, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE)


####multi group testing####
###measurement invariance

multisteps = measurementInvariance(overallmodel, 
                                   data = nomissnop, 
                                   group = "source",
                                   strict = T)

fitmeasures(multisteps$fit.configural)
fitmeasures(multisteps$fit.loadings)
fitmeasures(multisteps$fit.intercepts)
fitmeasures(multisteps$fit.residuals)

##scale name, number of scale points, sample size by group (2 columns), reliability, number of items, number of subscales
##did it break (y/n), where it broke, partial invariance (y/n), citation counts, publication year, 

tableprint[9, c(3, 4, 6, 8, 9)] = c(nrow(notrandom[, -c(1:3)]), nrow(random), ncol(random[ , -c(1:3)]), PI, wherebroke)

tableprint[9, c(3, 4, 6, 8, 9)]

```


```{r EStable, echo = FALSE, results = 'asis'}
tableES = matrix(NA, nrow = 7, ncol = 8)
tableES[ , 1] = c("Overall Model", "Random", "Not Random", 
                   "Configural", "Metric", "Scalar", "Strict")

fitused = c("chisq", "df", "rmsea", "srmr", "cfi")

tableES[1, 2:8 ] = c(nrow(nomissnop), 
                      fitmeasures(overall.fit, fit.measures = fitused), 
                      "-")
tableES[2, 2:8] = c(nrow(random), 
                      fitmeasures(overall.fit.r, fit.measures = fitused), 
                      "-")

tableES[3, 2:8] = c(nrow(notrandom), 
                      fitmeasures(overall.fit.nr, fit.measures = fitused), 
                      "-")

tableES[4, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.configural, fit.measures = fitused), 
                      "-")

tableES[5, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.loadings, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.loadings)["cfi"] - fitmeasures(multisteps$fit.configural)["cfi"])

tableES[6, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.intercepts, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.intercepts)["cfi"] - fitmeasures(multisteps$fit.loadings)["cfi"])

tableES[7, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.residuals, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.residuals)["cfi"] - fitmeasures(multisteps$fit.intercepts)["cfi"])

tableES[ , 3] = printnum(as.numeric(tableES[ , 3]), big.mark = "")
tableES[ , 5:8] = printnum(as.numeric(tableES[ , 5:8]), gt1 = F, digits = 3)


kable(tableES, 
      col.names = c("Model", "N", "Chi-Square", 
                       "df", "RMSEA", "SRMR", "CFI", "Change CFI"))

```


```{r FOM, include=FALSE}

FOM = master[ , c(618:629, 14, 955,956)]
names(FOM)
summary(master)

##fix qualtrics coding that's incorrect 1-5 instead of 0-4
FOM[ , c(1:12)] = FOM[ , c(1:12)] - 1

##Reverse Code. 2, 4, 5, 7, 9 , 11
FOM[ , c(2, 4, 5, 7, 9, 11)] = 4 - FOM[ , c(2, 4, 5, 7, 9, 11)] 
summary(master)

####DATA SCREENING####

##Missing Data##

##Going by rows ONLY
##here I excluded the first two columns because they were 
##included for everyone as IDs, so I don't want to count that
##as part of the percent toward what they did
notypos = FOM
missing = apply(notypos[ , 1:12], 1, percentmiss) 
table(missing)

##replace only the data that you should
replacepeople = notypos[ missing <= 5 , ]  
dontpeople = notypos[ missing > 5 , ]

##figure out the columns to exclude (survey data)
apply(replacepeople, 2, percentmiss)
replacecolumn = replacepeople[ , -c(13:15)]
dontcolumn = replacepeople[ , c(13:15)]

nomiss = replacepeople

##Outliers##
names(nomiss)
mahal = mahalanobis(nomiss[ , -c(13:15)], 
                    colMeans(nomiss[ , -c(13:15)], na.rm = TRUE),
                    cov(nomiss[ , -c(13:15)], use="pairwise.complete.obs"))

summary(mahal)
cutoff = qchisq(.999,ncol(nomiss[ , -c(13:15)])) 
summary(mahal < cutoff)
noout = nomiss[ mahal < cutoff, ]

##additivity: correlations
correlations = cor(noout[,-c(13:15)], use="pairwise.complete.obs")
symnum(correlations)

##make the random stuff
random = rchisq(nrow(noout), 7)
##be sure here not to include the ID columns!
fake = lm(random~., data=noout[ , -c(13:15)])

##get the linearity plot
##create the standardized residuals
standardized = rstudent(fake)
{qqnorm(standardized)
abline(0,1)}

##multivariate normality
hist(standardized, breaks=15)

##homogeneity and homoscedaticity
fitvalues = scale(fake$fitted.values)
{plot(fitvalues, standardized) 
abline(0,0)
abline(v = 0)}

##Scoring
FOM <- rowSums(nomiss[, c(1:12)])
summary(FOM)

nooutnop = subset(noout, source != 'paper')
nomissnop = subset(nomiss, source != 'paper')

notrandom = subset(nomissnop, source == 'not random')
random = subset(nomissnop, source == 'random')

overallmodel = '
FOM =~ FOM1 + FOM2 + FOM3 + FOM4 + FOM5 + FOM6 + FOM7 +
FOM8 + FOM9 + FOM10 + FOM11 + FOM12
'

##fit for overall (excluding paper)
overall.fit = cfa(model = overallmodel, 
                  data = nomissnop, 
                  meanstructure = TRUE)

summary(overall.fit, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE) ##no heywood cases

##fit for random 
random.fit = cfa(overallmodel, 
                 data = random, 
                 meanstructure = TRUE)
summary(random.fit, 
        standardized = TRUE, 
        rsquare = TRUE, 
        fit.measure = TRUE)

##fit for not random 
notrandom.fit = cfa(overallmodel, 
                    data = notrandom, 
                    meanstructure = TRUE)
summary(notrandom.fit, 
        standardized = TRUE, 
        rsquare = TRUE, 
        fit.measure = TRUE)

multisteps = measurementInvariance(overallmodel, 
                                   data = nomissnop, 
                                   group = 'source', 
                                   strict = T)

fitmeasures(multisteps$fit.configural)
fitmeasures(multisteps$fit.loadings)
fitmeasures(multisteps$fit.intercepts)
fitmeasures(multisteps$fit.residuals)

##Broke Down on Metric Invariance 

partial = partialInvariance(multisteps, 
                            type = "loadings")
##save only the results for easier viewing
loadinsfree = partial$results

multisteps2 = measurementInvariance(overallmodel, 
                                    data = nomissnop, 
                                    group = "source",
                                    strict = T,
                                    group.partial = c("FOM2=~FOM2"))

## Allow for question 2 to vary 

##scale name, number of scale points, sample size by group (2 columns), reliability, number of items, number of subscales
##did it break (y/n), where it broke, partial invariance (y/n), citation counts, publication year, 

tableprint[10, c(3, 4, 6, 8, 9)] = c(nrow(notrandom[, -c(1:2,15)]), nrow(random), ncol(random[ , -c(1:2,15)]), PI, wherebroke)

tableprint[10, c(3, 4, 6, 8, 9)]


```


```{r FOMtable, echo = FALSE, results = 'asis'}
tableFOM = matrix(NA, nrow = 7, ncol = 8)
tableFOM[ , 1] = c("Overall Model", "Random", "Not Random", 
                   "Configural", "Metric", "Scalar", "Strict")

fitused = c("chisq", "df", "rmsea", "srmr", "cfi")

tableFOM[1, 2:8 ] = c(nrow(nomissnop), 
                      fitmeasures(overall.fit, fit.measures = fitused), 
                      "-")
tableFOM[2, 2:8] = c(nrow(random), 
                      fitmeasures(overall.fit.r, fit.measures = fitused), 
                      "-")

tableFOM[3, 2:8] = c(nrow(notrandom), 
                      fitmeasures(overall.fit.nr, fit.measures = fitused), 
                      "-")

tableFOM[4, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps2$fit.configural, fit.measures = fitused), 
                      "-")

tableFOM[5, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps2$fit.loadings, fit.measures = fitused), 
                      fitmeasures(multisteps2$fit.loadings)["cfi"] - fitmeasures(multisteps2$fit.configural)["cfi"])

tableFOM[6, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps2$fit.intercepts, fit.measures = fitused), 
                      fitmeasures(multisteps2$fit.intercepts)["cfi"] - fitmeasures(multisteps2$fit.loadings)["cfi"])

tableFOM[7, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps2$fit.residuals, fit.measures = fitused), 
                      fitmeasures(multisteps2$fit.residuals)["cfi"] - fitmeasures(multisteps2$fit.intercepts)["cfi"])

tableFOM[ , 3] = printnum(as.numeric(tableFOM[ , 3]), big.mark = "")
tableFOM[ , 5:8] = printnum(as.numeric(tableFOM[ , 5:8]), gt1 = F, digits = 3)


kable(tableFOM, 
      col.names = c("Model", "N", "Chi-Square", 
                       "df", "RMSEA", "SRMR", "CFI", "Change CFI"))
```


```{r GLPS, include=FALSE}

glps = master[ , c(491:505,14,955,956)]
names(glps)

##Reverse Code. 5 8 and 13
glps[ , c(5, 8, 13)] =  8 - glps[ , c(5, 8, 13)]

####DATA SCREENING####

##Missing Data##

##Going by rows ONLY
##here I excluded the first two columns because they were 
##included for everyone as IDs, so I don't want to count that
##as part of the percent toward what they did
notypos = glps
names(notypos)
missing = apply(notypos[ , 1:15], 1, percentmiss) 
table(missing)

##replace only the data that you should
replacepeople = notypos[ missing <= 5 , ]  
dontpeople = notypos[ missing > 5 , ]

##figure out the columns to exclude (survey data)
apply(replacepeople, 2, percentmiss)
names(replacepeople)
replacecolumn = replacepeople[ , -c(16:18)]
dontcolumn = replacepeople[ , c(16:18)]

nomiss = replacepeople

##Outliers##
names(nomiss)
mahal = mahalanobis(nomiss[ , -c(16:18)], 
                    colMeans(nomiss[ , -c(16:18)], na.rm = TRUE),
                    cov(nomiss[ , -c(16:18)], use="pairwise.complete.obs"))

summary(mahal)
cutoff = qchisq(.999,ncol(nomiss[ , -c(16:18)])) 
summary(mahal < cutoff)
noout = nomiss[ mahal < cutoff, ]

##additivity: correlations
correlations = cor(noout[,-c(16:18)], use="pairwise.complete.obs")
symnum(correlations)

##make the random stuff
random = rchisq(nrow(noout), 7)
##be sure here not to include the ID columns!
fake = lm(random~., data=noout[ , -c(16:18)])

##get the linearity plot
##create the standardized residuals
standardized = rstudent(fake)
{qqnorm(standardized)
abline(0,1)}

##multivariate normality
hist(standardized, breaks=15)

##homogeneity and homoscedaticity
fitvalues = scale(fake$fitted.values)
{plot(fitvalues, standardized) 
abline(0,0)
abline(v = 0)}

##Scoring
GLPS <- rowSums(nomiss[, c(1:15)])
summary(GLPS)

##CFA

nooutnop = subset(noout, source != 'paper')
nomissnop = subset(nomiss, source != 'paper')

notrandom = subset(nomissnop, source == 'not random')
random = subset(nomissnop, source == 'random')

overallmodel = '
GLPS =~ GLPS1 + GLPS2 + GLPS3 + GLPS4 + GLPS5 + GLPS6 + GLPS7
+ GLPS8 + GLPS9 + GLPS10 + GLPS11 + GLPS12 + GLPS13 + GLPS14 + GLPS15
'

##fit for overall 
overall.fit = cfa(model = overallmodel, 
                  data = nomissnop, 
                  meanstructure = TRUE)

summary(overall.fit, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE) 

##fit for random 
random.fit = cfa(overallmodel, 
                 data = random, 
                 meanstructure = TRUE)
summary(random.fit, 
        standardized = TRUE, 
        rsquare = TRUE, 
        fit.measure = TRUE)

##fit for not random 
notrandom.fit = cfa(overallmodel, 
                    data = notrandom, 
                    meanstructure = TRUE)
summary(notrandom.fit, 
        standardized = TRUE, 
        rsquare = TRUE, 
        fit.measure = TRUE)


multisteps = measurementInvariance(overallmodel, 
                                   data = nomissnop, 
                                   group = 'source', 
                                   strict = T)

fitmeasures(multisteps$fit.configural)
fitmeasures(multisteps$fit.loadings)
fitmeasures(multisteps$fit.intercepts)
fitmeasures(multisteps$fit.residuals)

##It broke down on the Strict Invariance level

partial = partialInvariance(multisteps, 
                            type = "residuals")

##save only the results for easier viewing
residualsfree = partial$results

##click on the name, sort by FREE CFI
##release the biggest one first

multisteps2 = measurementInvariance(overallmodel, 
                                    data = nomissnop, 
                                    group = "source",
                                    strict = T,
                                    group.partial = c(GLPS3~~GLPS3))
##Removing question 3 did it. 

##scale name, number of scale points, sample size by group (2 columns), reliability, number of items, number of subscales
##did it break (y/n), where it broke, partial invariance (y/n), citation counts, publication year, 

tableprint[11, c(3, 4, 6, 8, 9)] = c(nrow(notrandom[, -c(1:2,18)]), nrow(random), ncol(random[ , -c(1:2,18)]), PI, wherebroke)

tableprint[11, c(3, 4, 6, 8, 9)]

```


```{r GLPStable, echo = FALSE, results = 'asis'}
tableGLPS = matrix(NA, nrow = 7, ncol = 8)
tableGLPS[ , 1] = c("Overall Model", "Random", "Not Random", 
                   "Configural", "Metric", "Scalar", "Strict")

fitused = c("chisq", "df", "rmsea", "srmr", "cfi")

tableGLPS[1, 2:8 ] = c(nrow(nomissnop), 
                      fitmeasures(overall.fit, fit.measures = fitused), 
                      "-")
tableGLPS[2, 2:8] = c(nrow(random), 
                      fitmeasures(overall.fit.r, fit.measures = fitused), 
                      "-")

tableGLPS[3, 2:8] = c(nrow(notrandom), 
                      fitmeasures(overall.fit.nr, fit.measures = fitused), 
                      "-")

tableGLPS[4, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps2$fit.configural, fit.measures = fitused), 
                      "-")

tableGLPS[5, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps2$fit.loadings, fit.measures = fitused), 
                      fitmeasures(multisteps2$fit.loadings)["cfi"] - fitmeasures(multisteps2$fit.configural)["cfi"])

tableGLPS[6, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps2$fit.intercepts, fit.measures = fitused), 
                      fitmeasures(multisteps2$fit.intercepts)["cfi"] - fitmeasures(multisteps2$fit.loadings)["cfi"])

tableGLPS[7, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps2$fit.residuals, fit.measures = fitused), 
                      fitmeasures(multisteps2$fit.residuals)["cfi"] - fitmeasures(multisteps2$fit.intercepts)["cfi"])

tableGLPS[ , 3] = printnum(as.numeric(tableGLPS[ , 3]), big.mark = "")
tableGLPS[ , 5:8] = printnum(as.numeric(tableGLPS[ , 5:8]), gt1 = F, digits = 3)


kable(tableGLPS, 
      col.names = c("Model", "N", "Chi-Square", 
                       "df", "RMSEA", "SRMR", "CFI", "Change CFI"))

```


```{r LAP, include=FALSE}





```

```{r LAPtable, echo = FALSE, results = 'asis'}


```

```{r LAP-R, include=FALSE}

lapr = master[ , c(630:685,14,955,956)]
names(lapr)

##Reverse Code. No Reverse Coding.
library(car)
lapr$LAPR16 = recode(lapr$LAPR16, "1='7'; 2='6'; 3='5'; 4='4'; 5='3'; 6='2'; 7='1'")

####DATA SCREENING####

##Missing Data##
library(mice)
percentmiss = function(x){ sum(is.na(x))/length(x) *100 }

##Going by rows ONLY
##here I excluded the first two columns because they were 
##included for everyone as IDs, so I don't want to count that
##as part of the percent toward what they did
notypos = lapr
names(notypos)
missing = apply(notypos[ , 1:56], 1, percentmiss) 
table(missing)

##replace only the data that you should
replacepeople = notypos[ missing <= 5 , ]  
dontpeople = notypos[ missing > 5 , ]

##figure out the columns to exclude (survey data)
apply(replacepeople, 2, percentmiss)
names(replacepeople)
replacecolumn = replacepeople[ , -c(57,58,59)]
dontcolumn = replacepeople[ , c(57,58,59)]

##let's mice it!
tempnomiss = mice(replacecolumn)
nomiss = complete(tempnomiss, 1)
summary(nomiss)

##put everything back together
filledin_none = cbind(dontcolumn, nomiss)
summary(filledin_none)

##Outliers##
names(filledin_none)
mahal = mahalanobis(filledin_none[ , -c(1:3)], 
                    colMeans(filledin_none[ , -c(1:3)], na.rm = TRUE),
                    cov(filledin_none[ , -c(1:3)], use="pairwise.complete.obs"))

summary(mahal)
cutoff = qchisq(.999,ncol(filledin_none[ , -c(1:3)])) 
summary(mahal < cutoff)
noout = filledin_none[ mahal < cutoff, ]

##additivity: correlations
names(noout)
correlations = cor(noout[,-c(1:3)], use="pairwise.complete.obs")
symnum(correlations)

##make the random stuff
random = rchisq(nrow(noout), 7)
##be sure here not to include the ID columns!
fake = lm(random~., data=noout[ , -c(1:3)])

##get the linearity plot
##create the standardized residuals
standardized = rstudent(fake)
qqnorm(standardized)
abline(0,1)

##multivariate normality
hist(standardized, breaks=15)

##homogeneity and homoscedaticity
fitvalues = scale(fake$fitted.values)
plot(fitvalues, standardized) 
abline(0,0)
abline(v = 0)

##not changing this because the columns changed and I don't think it matters in building the models
##since we already have them built and know what goes where
##Scoring
LP <- rowSums(noout[, c(14,22,23,30,31,38,39,46)])
LP

EV <- rowSums(noout[, c(4,12,16,20,28,34,40)])
EV

LC <- rowSums(noout[, c(17,25,41)])
LC

Death <- rowSums(noout[, c(19,27,35,43)])
Death

WM <- rowSums(noout[, c(7,9,15,36,44,47)])
WM

GS <- rowSums(noout[, c(21,24,29,37)])
GS

FMF <- rowSums(noout[, c(5,8,13,45)])
FMF

##exclude paper people using noout dataset 
nooutnop = subset(noout, source != 'paper')
nomissnop = subset(nomiss, source != 'paper')

notrandom = subset(nomissnop, source == 'not random')
random = subset(nomissnop, source == 'random')

##overallmodel 
names(nomissnop)
library(lavaan)
overallmodel = '
LP =~ LAPR11 + LAPR19 + LAPR20 + LAPR27 + LAPR28 + LAPR35 + LAPR36 + LAPR43
EV =~ LAPR1 + LAPR9 + LAPR13 + LAPR17 + LAPR25 + LAPR31 + LAPR37
LC =~ LAPR14 + LAPR22 + LAPR38
Death =~ LAPR16 +LAPR24 + LAPR32 + LAPR40
WM =~ LAPR4 + LAPR6 + LAPR12 + LAPR33 + LAPR41 + LAPR44 
GS =~ LAPR18 + LAPR21 + LAPR26 + LAPR34 
FMF =~ LAPR_2 + LAPR5 + LAPR10 + LAPR42
'
fit = cfa(overallmodel, 
          data = nomissnop, 
          meanstructure = TRUE)

fitMeasures(fit)
table(nomissnop$Source)
inspect(fit,"cov.lv")

##subset 

nooutnop = subset(noout, source != 'paper')
nomissnop = subset(filledin_none, source != 'paper')

notrandom = subset(nomissnop, source == 'not random')
random = subset(nomissnop, source == 'random')

##fit for overall 
overall.fit = cfa(model = overallmodel, 
                  data = nomissnop, 
                  meanstructure = TRUE)

summary(overall.fit, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE) 

##fit for random 
overall.fit.r = cfa(overallmodel, 
                 data = random, 
                 meanstructure = TRUE)
summary(random.fit, 
        standardized = TRUE, 
        rsquare = TRUE, 
        fit.measure = TRUE)
fitMeasures(random.fit)

##fit for not random 
overall.fit.nr = cfa(overallmodel, 
                 data = notrandom, 
                 meanstructure = TRUE)
summary(notrandom.fit, 
        standardized = TRUE, 
        rsquare = TRUE, 
        fit.measure = TRUE)
fitMeasures(notrandom.fit)

multisteps = measurementInvariance(overallmodel, 
                                   data = nomissnop, 
                                   group = 'source', 
                                   strict = T)

fitmeasures(multisteps$fit.configural)
fitmeasures(multisteps$fit.loadings)
fitmeasures(multisteps$fit.intercepts)
fitmeasures(multisteps$fit.residuals)


```

```{r LAP-Rtable, echo = FALSE, results = 'asis'}

tableLAPR = matrix(NA, nrow = 7, ncol = 8)
tableLAPR[ , 1] = c("Overall Model", "Random", "Not Random", 
                   "Configural", "Metric", "Scalar", "Strict")

fitused = c("chisq", "df", "rmsea", "srmr", "cfi")

tableLAPR[1, 2:8 ] = c(nrow(nomissnop), 
                      fitmeasures(overall.fit, fit.measures = fitused), 
                      "-")
tableLAPR[2, 2:8] = c(nrow(random), 
                      fitmeasures(overall.fit.r, fit.measures = fitused), 
                      "-")

tableLAPR[3, 2:8] = c(nrow(notrandom), 
                      fitmeasures(overall.fit.nr, fit.measures = fitused), 
                      "-")

tableLAPR[4, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.configural, fit.measures = fitused), 
                      "-")

tableLAPR[5, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.loadings, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.loadings)["cfi"] - fitmeasures(multisteps$fit.configural)["cfi"])

tableLAPR[6, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.intercepts, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.intercepts)["cfi"] - fitmeasures(multisteps$fit.loadings)["cfi"])

tableLAPR[7, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.residuals, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.residuals)["cfi"] - fitmeasures(multisteps$fit.intercepts)["cfi"])

tableLAPR[ , 3] = printnum(as.numeric(tableLAPR[ , 3]), big.mark = "")
tableLAPR[ , 5:8] = printnum(as.numeric(tableLAPR[ , 5:8]), gt1 = F, digits = 3)


kable(tableLAPR, 
      col.names = c("Model", "N", "Chi-Square", 
                       "df", "RMSEA", "SRMR", "CFI", "Change CFI"))

```

```{r LAS, include = FALSE}

names(master)
Las = master[ , c(506:532,14,955,956)]

##Missing Data##
library(mice)
percentmiss = function(x){ sum(is.na(x))/length(x) *100 }

##Going by rows ONLY
##here I excluded the first two columns because they were 
##included for everyone as IDs, so I don't want to count that
##as part of the percent toward what they did
notypos = Las
names(notypos)
missing = apply(notypos[ , 1:27], 1, percentmiss) 
table(missing)


##replace only the data that you should
replacepeople = notypos[ missing <= 5 , ]  
dontpeople = notypos[ missing > 5 , ]

##figure out the columns to exclude (survey data)
apply(replacepeople, 2, percentmiss)
replacecolumn = replacepeople[ , -c(28:30)]
dontcolumn = replacepeople[ , c(28:30)]

##let's mice it!
tempnomiss = mice(replacecolumn)
nomiss = complete(tempnomiss, 1)
summary(nomiss)

##put everything back together
filledin_none = cbind(dontcolumn, nomiss)
summary(filledin_none)

##Outliers##
names(filledin_none)
mahal = mahalanobis(filledin_none[ , -c(1:3)], 
                    colMeans(filledin_none[ , -c(1:3)], na.rm = TRUE),
                    cov(filledin_none[ , -c(1:3)], use="pairwise.complete.obs"))
mahal
summary(mahal)
cutoff = qchisq(.999,ncol(filledin_none[ , -c(1:3)])) 
summary(mahal < cutoff)
noout = filledin_none[ mahal < cutoff, ]

##additivity: correlations
correlations = cor(noout[,-c(1:3)], use="pairwise.complete.obs")
symnum(correlations)

##make the random stuff
random = rchisq(nrow(noout), 7)
##be sure here not to include the ID columns!
fake = lm(random~., data=noout[ , -c(1:3)])

##get the linearity plot
##create the standardized residuals
standardized = rstudent(fake)
qqnorm(standardized)
abline(0,1)

##multivariate normality
hist(standardized, breaks=15)

##homogeneity and homoscedaticity
fitvalues = scale(fake$fitted.values)
plot(fitvalues, standardized) 
abline(0,0)
abline(v = 0)

##Scoring 
LAS<- rowSums(noout[, c(4:30)])
LAS

##MGCFA
library(lavaan)
library(semTools)
library(mice)
library(effsize)
library(ltm)


##Factoring source##
#Zero = notrandom, One = random, Two = paper
nooutnop = subset(noout, source != 'paper')
nomissnop = subset(filledin_none, source != 'paper')

notrandom = subset(nomissnop, source == 'not random')
random = subset(nomissnop, source == 'random')

##Model 
overallmodel = '
LAS =~ LAS1 + LAS2 + LAS3 + LAS4 + LAS5 + LAS6 + LAS7 + LAS8 +LAS9 +LAS10 + LAS11 + LAS12 + LAS13 + LAS14 + LAS15 + LAS16 + LAS17 + LAS18 + LAS19 + LAS20 + LAS21 +LAS22 + LAS23 + LAS24 + LAS25 + LAS26 + LAS27
'
overall.fit = cfa(overallmodel, 
                  data=nomissnop, 
                  meanstructure = TRUE)

summary(overall.fit, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE)

####separate group models####
##notrandom
overall.fit.nr = cfa(overallmodel, 
                     data=notrandom, 
                     meanstructure = TRUE)

summary(overall.fit.nr, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE)

##random
overall.fit.r = cfa(overallmodel, 
                    data=random, 
                    meanstructure = TRUE)

summary(overall.fit.r, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE)


####multi group testing####
###measurement invariance
options(scipen = 999)

multisteps = measurementInvariance(overallmodel, 
                                   data = nomissnop, 
                                   group = "source",
                                   strict = T)

fitmeasures(multisteps$fit.configural)
fitmeasures(multisteps$fit.loadings)
fitmeasures(multisteps$fit.intercepts)
fitmeasures(multisteps$fit.residuals)



```

```{r LAStable, echo=FALSE, results='asis'}

tableLAS = matrix(NA, nrow = 7, ncol = 8)
tableLAS[ , 1] = c("Overall Model", "Random", "Not Random", 
                   "Configural", "Metric", "Scalar", "Strict")

fitused = c("chisq", "df", "rmsea", "srmr", "cfi")

tableLAS[1, 2:8 ] = c(nrow(nomissnop), 
                      fitmeasures(overall.fit, fit.measures = fitused), 
                      "-")
tableLAS[2, 2:8] = c(nrow(random), 
                      fitmeasures(overall.fit.r, fit.measures = fitused), 
                      "-")

tableLAS[3, 2:8] = c(nrow(notrandom), 
                      fitmeasures(overall.fit.nr, fit.measures = fitused), 
                      "-")

tableLAS[4, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.configural, fit.measures = fitused), 
                      "-")

tableLAS[5, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.loadings, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.loadings)["cfi"] - fitmeasures(multisteps$fit.configural)["cfi"])

tableLAS[6, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.intercepts, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.intercepts)["cfi"] - fitmeasures(multisteps$fit.loadings)["cfi"])

tableLAS[7, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.residuals, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.residuals)["cfi"] - fitmeasures(multisteps$fit.intercepts)["cfi"])

tableLAS[ , 3] = printnum(as.numeric(tableLAS[ , 3]), big.mark = "")
tableLAS[ , 5:8] = printnum(as.numeric(tableLAS[ , 5:8]), gt1 = F, digits = 3)


kable(tableLAS, 
      col.names = c("Model", "N", "Chi-Square", 
                       "df", "RMSEA", "SRMR", "CFI", "Change CFI"))
```

```{r LET, include=FALSE}

LET = master[ , c(316:321,14,955,956)]
names(LET)

##Reverse Code. 
library(car)
master$LET1 = recode(master$LET1, "1='5'; 2='4'; 3='3'; 4='2'; 5='1'")
master$LET3 = recode(master$LET3, "1='5'; 2='4'; 3='3'; 4='2'; 5='1'")
master$LET5 = recode(master$LET5, "1='5'; 2='4'; 3='3'; 4='2'; 5='1'")

####DATA SCREENING####

##Missing Data##
library(mice)
percentmiss = function(x){ sum(is.na(x))/length(x) *100 }

##Going by rows ONLY
##here I excluded the first two columns because they were 
##included for everyone as IDs, so I don't want to count that
##as part of the percent toward what they did
notypos = LET
names(notypos)
missing = apply(notypos[ , 1:6], 1, percentmiss) 
table(missing)

##replace only the data that you should
replacepeople = notypos[ missing <= 5 , ]  
dontpeople = notypos[ missing > 5 , ]

##figure out the columns to exclude (survey data)
apply(replacepeople, 2, percentmiss)
names(replacepeople)
replacecolumn = replacepeople[ , -c(7:9)]
dontcolumn = replacepeople[ , c(7:9)]

nomiss = replacepeople

##Outliers##
names(nomiss)
mahal = mahalanobis(nomiss[ , -c(7:9)], 
                    colMeans(nomiss[ , -c(7:9)], na.rm = TRUE),
                    cov(nomiss[ , -c(7:9)], use="pairwise.complete.obs"))

summary(mahal)
cutoff = qchisq(.999,ncol(nomiss[ , -c(7:9)])) 
summary(mahal < cutoff)
noout = nomiss[ mahal < cutoff, ]

##additivity: correlations
correlations = cor(nomiss[,-c(7:9)], use="pairwise.complete.obs")
symnum(correlations)

##make the random stuff
random = rchisq(nrow(nomiss), 7)
##be sure here not to include the ID columns!
fake = lm(random~., data=nomiss[ , -c(7:9)])

##get the linearity plot
##create the standardized residuals
standardized = rstudent(fake)
qqnorm(standardized)
abline(0,1)

##multivariate normality
hist(standardized, breaks=15)

##homogeneity and homoscedaticity
fitvalues = scale(fake$fitted.values)
plot(fitvalues, standardized) 
abline(0,0)
abline(v = 0)

##Scoring
LET <- rowSums(noout[, c(1:6)])
LET

##exclude paper people using noout dataset 
nooutnop = subset(noout, source != 'paper')
nomissnop = subset(nomiss, source != 'paper')

notrandom = subset(nomissnop, source == 'not random')
random = subset(nomissnop, source == 'random')

##model 

##overall model 
library(lavaan)
summary(nomissnop)

overallmodel = '
Life =~ LET1 + LET2 + LET3 + LET4 + LET5 + LET6
'

overall.fit = cfa(overallmodel, 
          data = nomissnop, 
          meanstructure = TRUE)

summary(overall.fit, 
        standardized = TRUE, 
        rsquare = TRUE, 
        fit.measure = TRUE)

##fit for random 
overall.fit.r = cfa(overallmodel, 
                 data = random, 
                 meanstructure = TRUE)
summary(overall.fit.r, 
        standardized = TRUE, 
        rsquare = TRUE, 
        fit.measure = TRUE)
fitMeasures(overall.fit.r)

##fit for not random 
overall.fit.nr = cfa(overallmodel, 
                    data = notrandom, 
                    meanstructure = TRUE)
summary(overall.fit.nr, 
        standardized = TRUE, 
        rsquare = TRUE, 
        fit.measure = TRUE) 
fitMeasures(overall.fit.nr)

##invariances 
library(semTools)
multisteps = measurementInvariance(overallmodel, 
                                   data = nomissnop, 
                                   group = 'source', 
                                   strict = T)
fitmeasures(multisteps)
fitMeasures(multisteps$fit.configural)
fitMeasures(multisteps$fit.loadings)
fitMeasures(multisteps$fit.intercepts)
fitMeasures(multisteps$fit.residuals)
fitMeasures(multisteps$fit.means)

#partial invariances 
partial = partialInvariance(multisteps, 
                            type = "metric")
strictfree = partial$results


##after letting it go 
partialstrict = measurementInvariance(overallmodel, 
                                      data = nomissnop, 
                                      group = 'source', 
                                      strict = T, 
                                      group.partial = c("Life=~LET1", "Life=~LET6", "Life=~LET2" ))

fitmeasures(partialstrict$fit.loadings)
fitMeasures(partialstrict$fit.intercepts)
fitMeasures(partialstrict$fit.residuals)

```

```{r LETtable, echo=FALSE, results='asis'}
tableLET = matrix(NA, nrow = 7, ncol = 8)
tableLET[ , 1] = c("Overall Model", "Random", "Not Random", 
                   "Configural", "Metric", "Scalar", "Strict")

fitused = c("chisq", "df", "rmsea", "srmr", "cfi")

tableLET[1, 2:8 ] = c(nrow(nomissnop), 
                      fitmeasures(overall.fit, fit.measures = fitused), 
                      "-")
tableLET[2, 2:8] = c(nrow(random), 
                      fitmeasures(overall.fit.r, fit.measures = fitused), 
                      "-")

tableLET[3, 2:8] = c(nrow(notrandom), 
                      fitmeasures(overall.fit.nr, fit.measures = fitused), 
                      "-")

tableLET[4, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(partialstrict$fit.configural, fit.measures = fitused), 
                      "-")

tableLET[5, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(partialstrict$fit.loadings, fit.measures = fitused), 
                      fitmeasures(partialstrict$fit.loadings)["cfi"] - fitmeasures(partialstrict$fit.configural)["cfi"])

tableLET[6, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(partialstrict$fit.intercepts, fit.measures = fitused), 
                      fitmeasures(partialstrict$fit.intercepts)["cfi"] - fitmeasures(partialstrict$fit.loadings)["cfi"])

tableLET[7, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(partialstrict$fit.residuals, fit.measures = fitused), 
                      fitmeasures(partialstrict$fit.residuals)["cfi"] - fitmeasures(partialstrict$fit.intercepts)["cfi"])

tableLET[ , 3] = printnum(as.numeric(tableLET[ , 3]), big.mark = "")
tableLET[ , 5:8] = printnum(as.numeric(tableLET[ , 5:8]), gt1 = F, digits = 3)


kable(tableLET, 
      col.names = c("Model", "N", "Chi-Square", 
                       "df", "RMSEA", "SRMR", "CFI", "Change CFI"))

```

```{r LPQ, include=FALSE}
names(master)
LPQ = master[ , c(816:835,14,955,956)]
names(LPQ)

##Reverse Code. True = 1, False = 2
##1 Point for True: 3, 4, 6, 7, 10, 13, 17, 18, 20; 
LPQ[ , c(3,4,6,7,10,13,17,18,20)] = 2 - LPQ[ , c(3,4,6,7,10,13,17,18,20)]
##1 Point for False: 1, 2, 5, 8, 9, 11, 12, 14, 15, 16, 19
LPQ[ , c(1,2,5,8,9,11,12,14,15,16,19)] = LPQ[ , c(1,2,5,8,9,11,12,14,15,16,19)] - 1
LPQ$LPQ16[LPQ$Q3_16 > 1 ] = NA 
summary(LPQ)

####DATA SCREENING####

##Missing Data##
library(mice)
percentmiss = function(x){ sum(is.na(x))/length(x) *100 }

##Going by rows ONLY
##here I excluded the first two columns because they were 
##included for everyone as IDs, so I don't want to count that
##as part of the percent toward what they did
notypos = LPQ
names(notypos)
missing = apply(notypos[ , 1:20], 1, percentmiss) 
table(missing)

##replace only the data that you should
replacepeople = notypos[ missing <= 5 , ]  
dontpeople = notypos[ missing > 5 , ]

##figure out the columns to exclude (survey data)
apply(replacepeople, 2, percentmiss)
names(replacepeople)
replacecolumn = replacepeople[ , -c(21:23)]
dontcolumn = replacepeople[ , c(21:23)]

##let's mice it!
tempnomiss = mice(replacecolumn)
nomiss = complete(tempnomiss, 1)
summary(nomiss)

##put everything back together
filledin_none = cbind(dontcolumn, nomiss)
summary(filledin_none)

##Outliers##
names(filledin_none)
mahal = mahalanobis(filledin_none[ , -c(1:3)], 
                    colMeans(filledin_none[ , -c(1:3)], na.rm = TRUE),
                    cov(filledin_none[ , -c(1:3)], use="pairwise.complete.obs"))
summary(mahal)
cutoff = qchisq(.999,ncol(filledin_none[ , -c(1:3)])) 
summary(mahal < cutoff)
noout = filledin_none[ mahal < cutoff, ]

##additivity: correlations
correlations = cor(noout[,-c(1:3)], use="pairwise.complete.obs")
symnum(correlations)

##make the random stuff
random = rchisq(nrow(noout), 7)
##be sure here not to include the ID columns!
fake = lm(random~., data=noout[ , -c(1:3)])

##get the linearity plot
##create the standardized residuals
standardized = rstudent(fake)
qqnorm(standardized)
abline(0,1)

##multivariate normality
hist(standardized, breaks=15)

##homogeneity and homoscedaticity
fitvalues = scale(fake$fitted.values)
plot(fitvalues, standardized) 
abline(0,0)
abline(v = 0)

##Scoring 
LPQ <- rowSums(noout[, c(4:23)])
summary(LPQ)

####CFA####
library(lavaan)
library(semTools)
##subsetting data

nooutnop = subset(noout, source != 'paper') ##excludes paper
nomissnop = subset(filledin_none, source != 'paper') ##excludes paper

notrandom = subset(nomissnop, source == 'not random')
random = subset(nomissnop, source == 'random')

####overall model for everyone together##
colnames(nomissnop)
overallmodel = '
LPQ =~
LPQ1 + LPQ2 + LPQ3 + LPQ4 + LPQ5 + LPQ6 + LPQ7 +
LPQ8 + LPQ9 + LPQ10 + LPQ11 + LPQ12 + LPQ13 + LPQ14 + 
LPQ15 + LPQ16 + LPQ17 + LPQ18 + LPQ19 + LPQ20
'

overall.fit = cfa(model = overallmodel, 
                  data=nomissnop, 
                  meanstructure = TRUE)

summary(overall.fit, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE)

##random
overall.fit.r = cfa(overallmodel, 
                    data=random, 
                    meanstructure = TRUE)

summary(overall.fit.r, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE)

##notrandom
overall.fit.nr = cfa(overallmodel, 
                     data=notrandom, 
                     meanstructure = TRUE)

summary(overall.fit.nr, 
        standardized=TRUE,
        rsquare=TRUE, 
        fit.measure = TRUE)


####multi group testing####
###measurement invariance
options(scipen = 999)

multisteps = measurementInvariance(overallmodel, 
                                   data = nomissnop, 
                                   group = "source",
                                   strict = T)

fitmeasures(multisteps$fit.configural)
fitmeasures(multisteps$fit.loadings)
fitmeasures(multisteps$fit.intercepts)
fitmeasures(multisteps$fit.residuals)

##It broke down at Strict Invariance
partial = partialInvariance(multisteps, 
                            type = "residuals")

##save only the results for easier viewing
residualsfree = partial$results

##click on the name, sort by FREE CFI 
##release the biggest one first

####stopped because I don't know what I'm doing####
multisteps2 = measurementInvariance(overallmodel,  
                                    data = nomissnop, 
                                    group = "source",
                                    strict = T,
                                    group.partial = c("LPQ13~~LPQ13"))



```

```{r LPQtable, echo=FALSE, results='asis'}
tableLPQ = matrix(NA, nrow = 7, ncol = 8)
tableLPQ[ , 1] = c("Overall Model", "Random", "Not Random", 
                   "Configural", "Metric", "Scalar", "Strict")

fitused = c("chisq", "df", "rmsea", "srmr", "cfi")

tableLPQ[1, 2:8 ] = c(nrow(nomissnop), 
                      fitmeasures(overall.fit, fit.measures = fitused), 
                      "-")
tableLPQ[2, 2:8] = c(nrow(random), 
                      fitmeasures(overall.fit.r, fit.measures = fitused), 
                      "-")

tableLPQ[3, 2:8] = c(nrow(notrandom), 
                      fitmeasures(overall.fit.nr, fit.measures = fitused), 
                      "-")

tableLPQ[4, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps2$fit.configural, fit.measures = fitused), 
                      "-")

tableLPQ[5, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps2$fit.loadings, fit.measures = fitused), 
                      fitmeasures(multisteps2$fit.loadings)["cfi"] - fitmeasures(multisteps2$fit.configural)["cfi"])

tableLPQ[6, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps2$fit.intercepts, fit.measures = fitused), 
                      fitmeasures(multisteps2$fit.intercepts)["cfi"] - fitmeasures(multisteps2$fit.loadings)["cfi"])

tableLPQ[7, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps2$fit.residuals, fit.measures = fitused), 
                      fitmeasures(multisteps2$fit.residuals)["cfi"] - fitmeasures(multisteps2$fit.intercepts)["cfi"])

tableLPQ[ , 3] = printnum(as.numeric(tableLPQ[ , 3]), big.mark = "")
tableLPQ[ , 5:8] = printnum(as.numeric(tableLPQ[ , 5:8]), gt1 = F, digits = 3)


kable(tableLPQ, 
      col.names = c("Model", "N", "Chi-Square", 
                       "df", "RMSEA", "SRMR", "CFI", "Change CFI"))

```

```{r LRI, include=FALSE}


LRI = master[ , c(533:560,14,955,956)]
names(LRI)

##Reverse Code. None.

####DATA SCREENING####

##Missing Data##
library(mice)
percentmiss = function(x){ sum(is.na(x))/length(x) *100 }

##Going by rows ONLY
##here I excluded the first two columns because they were 
##included for everyone as IDs, so I don't want to count that
##as part of the percent toward what they did
notypos = LRI
names(notypos)
missing = apply(notypos[ , 1:28], 1, percentmiss) 
table(missing)

##replace only the data that you should
replacepeople = notypos[ missing <= 5 , ]  
dontpeople = notypos[ missing > 5 , ]

##figure out the columns to exclude (survey data)
apply(replacepeople, 2, percentmiss)
names(replacepeople)
replacecolumn = replacepeople[ , -c(29:31)]
dontcolumn = replacepeople[ , c(29:31)]

##let's mice it!
tempnomiss = mice(replacecolumn)
nomiss = complete(tempnomiss, 1)
summary(nomiss)

##put everything back together
filledin_none = cbind(dontcolumn, nomiss)
summary(filledin_none)

##Outliers##
names(filledin_none)
mahal = mahalanobis(filledin_none[ , -c(1:3)], 
                    colMeans(filledin_none[ , -c(1:3)], na.rm = TRUE),
                    cov(filledin_none[ , -c(1:3)], use="pairwise.complete.obs"))
mahal
summary(mahal)
cutoff = qchisq(.999,ncol(filledin_none[ , -c(1:3)])) 
summary(mahal < cutoff)
noout = filledin_none[ mahal < cutoff, ]

##additivity: correlations
correlations = cor(filledin_none[,-c(1:3)], use="pairwise.complete.obs")
symnum(correlations)

##make the random stuff
random = rchisq(nrow(filledin_none), 7)
##be sure here not to include the ID columns!
fake = lm(random~., data=filledin_none[ , -c(1:3)])

##get the linearity plot
##create the standardized residuals
standardized = rstudent(fake)
qqnorm(standardized)
abline(0,1)

##multivariate normality
hist(standardized, breaks=15)

##homogeneity and homoscedaticity
fitvalues = scale(fake$fitted.values)
plot(fitvalues, standardized) 
abline(0,0)
abline(v = 0)

##exclude paper people using noout dataset 
nooutnop = subset(noout, source != 'paper')
nomissnop = subset(filledin_none, source != 'paper')

notrandom = subset(nomissnop, source == 'not random')
random = subset(nomissnop, source == 'random')

##overall model 
names(filledin_none)
overallmodel = '
FRAME =~ LRI1 + LRI3 + LRI4 + LRI7 + LRI8 + LRI9 + LRI10 + LRI11 + LRI13 + LRI14 + LRI16 + LRI23 + LRI25 + LRI28
FULFILL =~ LRI2 + LRI5 + LRI6 + LRI12 + LRI15 + LRI17 + LRI18 + LRI19 + LRI20 + LRI21 + LRI22 + LRI24 + LRI26 + LRI27'

overall.fit = cfa(overallmodel, 
data = nomissnop, 
meanstructure = TRUE)

summary(overall.fit, 
standardized = TRUE, 
rsquare = TRUE, 
fit.measure = TRUE)

fitMeasures(overall.fit)

##fit for random 
overall.fit.r = cfa(overallmodel, 
                 data = random, 
                 meanstructure = TRUE)
summary(overall.fit.r, 
        standardized = TRUE, 
        rsquare = TRUE, 
        fit.measure = TRUE)
fitMeasures(overall.fit.r)

##fit for not random 
overall.fit.nr = cfa(overallmodel, 
                    data = notrandom, 
                    meanstructure = TRUE)
summary(overall.fit.nr, 
        standardized = TRUE, 
        rsquare = TRUE, 
        fit.measure = TRUE) 
fitMeasures(overall.fit.nr)

##invariances 
library(semTools)
multisteps = measurementInvariance(overallmodel, 
                                   data = nomissnop, 
                                   group = 'source', 
                                   strict = T)
fitmeasures(multisteps)
fitMeasures(multisteps$fit.configural)
fitMeasures(multisteps$fit.loadings)
fitMeasures(multisteps$fit.intercepts)
fitMeasures(multisteps$fit.residuals)
fitMeasures(multisteps$fit.means)

```

```{r LRItable, echo=FALSE, results='asis'}
tableLRI = matrix(NA, nrow = 7, ncol = 8)
tableLRI[ , 1] = c("Overall Model", "Random", "Not Random", 
                   "Configural", "Metric", "Scalar", "Strict")

fitused = c("chisq", "df", "rmsea", "srmr", "cfi")

tableLRI[1, 2:8 ] = c(nrow(nomissnop), 
                      fitmeasures(overall.fit, fit.measures = fitused), 
                      "-")
tableLRI[2, 2:8] = c(nrow(random), 
                      fitmeasures(overall.fit.r, fit.measures = fitused), 
                      "-")

tableLRI[3, 2:8] = c(nrow(notrandom), 
                      fitmeasures(overall.fit.nr, fit.measures = fitused), 
                      "-")

tableLRI[4, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.configural, fit.measures = fitused), 
                      "-")

tableLRI[5, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.loadings, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.loadings)["cfi"] - fitmeasures(multisteps$fit.configural)["cfi"])

tableLRI[6, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.intercepts, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.intercepts)["cfi"] - fitmeasures(multisteps$fit.loadings)["cfi"])

tableLRI[7, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.residuals, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.residuals)["cfi"] - fitmeasures(multisteps$fit.intercepts)["cfi"])

tableLRI[ , 3] = printnum(as.numeric(tableLRI[ , 3]), big.mark = "")
tableLRI[ , 5:8] = printnum(as.numeric(tableLRI[ , 5:8]), gt1 = F, digits = 3)


kable(tableLRI, 
      col.names = c("Model", "N", "Chi-Square", 
                       "df", "RMSEA", "SRMR", "CFI", "Change CFI"))

```

```{r MAPA, include=FALSE}

MAPA = master[ , c(85:140,14,955,956)]

##recode 0 to 6 for frequency Q4
names(MAPA)
library(car)
MAPA$MAPA1 = recode(MAPA$MAPA1, "1='0'; 2='1'; 3='2'; 4='3'; 5='4'; 6='5'; 7 = '6'")
MAPA$MAPA2 = recode(MAPA$MAPA2, "1='0'; 2='1'; 3='2'; 4='3'; 5='4'; 6='5'; 7 = '6'")
MAPA$MAPA3 = recode(MAPA$MAPA3, "1='0'; 2='1'; 3='2'; 4='3'; 5='4'; 6='5'; 7 = '6'")
MAPA$MAPA4 = recode(MAPA$MAPA4, "1='0'; 2='1'; 3='2'; 4='3'; 5='4'; 6='5'; 7 = '6'")
MAPA$MAPA5 = recode(MAPA$MAPA5, "1='0'; 2='1'; 3='2'; 4='3'; 5='4'; 6='5'; 7 = '6'")
MAPA$MAPA6 = recode(MAPA$MAPA6, "1='0'; 2='1'; 3='2'; 4='3'; 5='4'; 6='5'; 7 = '6'")
MAPA$MAPA7 = recode(MAPA$MAPA7, "1='0'; 2='1'; 3='2'; 4='3'; 5='4'; 6='5'; 7 = '6'")
MAPA$MAPA8 = recode(MAPA$MAPA8, "1='0'; 2='1'; 3='2'; 4='3'; 5='4'; 6='5'; 7 = '6'")
MAPA$MAPA9 = recode(MAPA$MAPA9, "1='0'; 2='1'; 3='2'; 4='3'; 5='4'; 6='5'; 7 = '6'")
MAPA$MAPA10 = recode(MAPA$MAPA10, "1='0'; 2='1'; 3='2'; 4='3'; 5='4'; 6='5'; 7 = '6'")
MAPA$MAPA11 = recode(MAPA$MAPA11, "1='0'; 2='1'; 3='2'; 4='3'; 5='4'; 6='5'; 7 = '6'")
MAPA$MAPA12 = recode(MAPA$MAPA12, "1='0'; 2='1'; 3='2'; 4='3'; 5='4'; 6='5'; 7 = '6'")
MAPA$MAPA13 = recode(MAPA$MAPA13, "1='0'; 2='1'; 3='2'; 4='3'; 5='4'; 6='5'; 7 = '6'")
MAPA$MAPA14 = recode(MAPA$MAPA14, "1='0'; 2='1'; 3='2'; 4='3'; 5='4'; 6='5'; 7 = '6'")
MAPA$MAPA15 = recode(MAPA$MAPA15, "1='0'; 2='1'; 3='2'; 4='3'; 5='4'; 6='5'; 7 = '6'")
MAPA$MAPA16 = recode(MAPA$MAPA16, "1='0'; 2='1'; 3='2'; 4='3'; 5='4'; 6='5'; 7 = '6'")
MAPA$MAPA17 = recode(MAPA$MAPA17, "1='0'; 2='1'; 3='2'; 4='3'; 5='4'; 6='5'; 7 = '6'")
MAPA$MAPA18 = recode(MAPA$MAPA18, "1='0'; 2='1'; 3='2'; 4='3'; 5='4'; 6='5'; 7 = '6'")
MAPA$MAPA19 = recode(MAPA$MAPA19, "1='0'; 2='1'; 3='2'; 4='3'; 5='4'; 6='5'; 7 = '6'")
MAPA$MAPA20 = recode(MAPA$MAPA20, "1='0'; 2='1'; 3='2'; 4='3'; 5='4'; 6='5'; 7 = '6'")
MAPA$MAPA21 = recode(MAPA$MAPA21, "1='0'; 2='1'; 3='2'; 4='3'; 5='4'; 6='5'; 7 = '6'")
MAPA$MAPA22 = recode(MAPA$MAPA22, "1='0'; 2='1'; 3='2'; 4='3'; 5='4'; 6='5'; 7 = '6'")
MAPA$MAPA23 = recode(MAPA$MAPA23, "1='0'; 2='1'; 3='2'; 4='3'; 5='4'; 6='5'; 7 = '6'")
MAPA$MAPA24 = recode(MAPA$MAPA24, "1='0'; 2='1'; 3='2'; 4='3'; 5='4'; 6='5'; 7 = '6'")
MAPA$MAPA25 = recode(MAPA$MAPA25, "1='0'; 2='1'; 3='2'; 4='3'; 5='4'; 6='5'; 7 = '6'")
MAPA$MAPA26 = recode(MAPA$MAPA26, "1='0'; 2='1'; 3='2'; 4='3'; 5='4'; 6='5'; 7 = '6'")
MAPA$MAPA27 = recode(MAPA$MAPA27, "1='0'; 2='1'; 3='2'; 4='3'; 5='4'; 6='5'; 7 = '6'")
MAPA$MAPA28 = recode(MAPA$MAPA28, "1='0'; 2='1'; 3='2'; 4='3'; 5='4'; 6='5'; 7 = '6'")

##recode 0 to 4 for rating Q5
library(car)
MAPA$MAPA1 = recode(MAPA$MAPA1, "1='0'; 2='1'; 3='2'; 4='3'; 5='4'")
MAPA$MAPA2 = recode(MAPA$MAPA2, "1='0'; 2='1'; 3='2'; 4='3'; 5='4'")
MAPA$MAPA3 = recode(MAPA$MAPA3, "1='0'; 2='1'; 3='2'; 4='3'; 5='4'")
MAPA$MAPA4 = recode(MAPA$MAPA4, "1='0'; 2='1'; 3='2'; 4='3'; 5='4'")
MAPA$MAPA5 = recode(MAPA$MAPA5, "1='0'; 2='1'; 3='2'; 4='3'; 5='4'")
MAPA$MAPA6 = recode(MAPA$MAPA6, "1='0'; 2='1'; 3='2'; 4='3'; 5='4'")
MAPA$MAPA7 = recode(MAPA$MAPA7, "1='0'; 2='1'; 3='2'; 4='3'; 5='4'")
MAPA$MAPA8 = recode(MAPA$MAPA8, "1='0'; 2='1'; 3='2'; 4='3'; 5='4'")
MAPA$MAPA9 = recode(MAPA$MAPA9, "1='0'; 2='1'; 3='2'; 4='3'; 5='4''")
MAPA$MAPA10 = recode(MAPA$MAPA10, "1='0'; 2='1'; 3='2'; 4='3'; 5='4'")
MAPA$MAPA11 = recode(MAPA$MAPA11, "1='0'; 2='1'; 3='2'; 4='3'; 5='4'")
MAPA$MAPA12 = recode(MAPA$MAPA12, "1='0'; 2='1'; 3='2'; 4='3'; 5='4'")
MAPA$MAPA13 = recode(MAPA$MAPA13, "1='0'; 2='1'; 3='2'; 4='3'; 5='4'")
MAPA$MAPA14 = recode(MAPA$MAPA14, "1='0'; 2='1'; 3='2'; 4='3'; 5='4'")
MAPA$MAPA15 = recode(MAPA$MAPA15, "1='0'; 2='1'; 3='2'; 4='3'; 5='4'")
MAPA$MAPA16 = recode(MAPA$MAPA16, "1='0'; 2='1'; 3='2'; 4='3'; 5='4'")
MAPA$MAPA17 = recode(MAPA$MAPA17, "1='0'; 2='1'; 3='2'; 4='3'; 5='4'")
MAPA$MAPA18 = recode(MAPA$MAPA18, "1='0'; 2='1'; 3='2'; 4='3'; 5='4'")
MAPA$MAPA19 = recode(MAPA$MAPA19, "1='0'; 2='1'; 3='2'; 4='3'; 5='4'")
MAPA$MAPA20 = recode(MAPA$MAPA20, "1='0'; 2='1'; 3='2'; 4='3'; 5='4'")
MAPA$MAPA21 = recode(MAPA$MAPA21, "1='0'; 2='1'; 3='2'; 4='3'; 5='4'")
MAPA$MAPA22 = recode(MAPA$MAPA22, "1='0'; 2='1'; 3='2'; 4='3'; 5='4'")
MAPA$MAPA23 = recode(MAPA$MAPA23, "1='0'; 2='1'; 3='2'; 4='3'; 5='4'")
MAPA$MAPA24 = recode(MAPA$MAPA24, "1='0'; 2='1'; 3='2'; 4='3'; 5='4'")
MAPA$MAPA25 = recode(MAPA$MAPA25, "1='0'; 2='1'; 3='2'; 4='3'; 5='4'")
MAPA$MAPA26 = recode(MAPA$MAPA26, "1='0'; 2='1'; 3='2'; 4='3'; 5='4'")
MAPA$MAPA27 = recode(MAPA$MAPA27, "1='0'; 2='1'; 3='2'; 4='3'; 5='4'")
MAPA$MAPA28 = recode(MAPA$MAPA28, "1='0'; 2='1'; 3='2'; 4='3'; 5='4'")

##missing
library(mice)
percentmiss = function (x){ sum(is.na(x))/length(x) * 100}

##Going by ROWS only
notypos = MAPA
names(notypos)
missing = apply(notypos[ , 1:56], 1, percentmiss) 
table(missing)

##replace only the data that you should
replacepeople = notypos[ missing <= 5 , ]  
dontpeople = notypos[ missing > 5 , ]

##figure out the columns to exclude (survey data)
apply(replacepeople, 2, percentmiss)
names(replacepeople)
replacecolumn = replacepeople[ , -c(57:59)]
dontcolumn = replacepeople[ , c(57:59)]

##let's mice it!
tempnomiss = mice(replacecolumn)
nomiss = complete(tempnomiss, 1)
summary(nomiss)

##put everything back together
filledin_none = cbind(dontcolumn, nomiss)
summary(filledin_none)

##Outliers##
names(filledin_none)
mahal = mahalanobis(filledin_none[ , -c(1:3)], 
                    colMeans(filledin_none[ , -c(1:3)], na.rm = TRUE),
                    cov(filledin_none[ , -c(1:3)], use="pairwise.complete.obs"))

cutoff = qchisq(.999,ncol(filledin_none[ , -c(1:3)])) 
summary(mahal < cutoff)
noout = filledin_none[ mahal < cutoff, ]

##additivity: correlations
correlations = cor(noout[,-c(1:3)], use="pairwise.complete.obs")
symnum(correlations)

##make the random stuff
random = rchisq(nrow(noout), 7)
##be sure here not to include the ID columns!
fake = lm(random~., data=noout[ , -c(1:3)])

##get the linearity plot
##create the standardized residuals
standardized = rstudent(fake)
qqnorm(standardized)
abline(0,1)

##multivariate normality
hist(standardized, breaks=15)

##homogeneity and homoscedaticity
fitvalues = scale(fake$fitted.values)
plot(fitvalues, standardized) 
abline(0,0)
abline(v = 0)

##subsetting data
#Zero = notrandom, One = random, Two = paper
nooutnop = subset(noout, source != 'paper') ##excludes paper
nomissnop = subset(filledin_none, source != 'paper') ##excludes paper

notrandom = subset(nomissnop, source == 'not random') ##noout and filled in none same dataset
random = subset(nomissnop, source == 'random')

library(lavaan)
##data sets
overallmodel = '
MAPA =~ MAPA1 + MAPA2 + MAPA3 + MAPA4 + MAPA5 + MAPA6 + MAPA7 + MAPA8 + MAPA9 + MAPA10
+ MAPA11 + MAPA12 + MAPA13 + MAPA14 + MAPA15 + MAPA16 + MAPA17 + MAPA18 + MAPA19 + MAPA20
+ MAPA21 + MAPA22 + MAPA23 + MAPA24 + MAPA25 + MAPA26 + MAPA27 + MAPA28
'
overall.fit = cfa(model = overallmodel, 
                  data=nomissnop, 
                  meanstructure = TRUE)

summary(overall.fit, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE)
##random
overall.fit.r = cfa(overallmodel, 
                    data=random, 
                    meanstructure = TRUE)

summary(overall.fit.r, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE)
##notrandom
overall.fit.nr = cfa(overallmodel, 
                     data=notrandom, 
                     meanstructure = TRUE)

summary(overall.fit.nr, 
        standardized=TRUE,
        rsquare=TRUE, 
        fit.measure = TRUE)
####Multigroup Testing####
library(semTools)
options(scipen = 999)
multisteps = measurementInvariance(overallmodel, 
                                   data = nomissnop, 
                                   group = "source",
                                   strict = T)
fitmeasures(multisteps$fit.configural)
fitmeasures(multisteps$fit.loadings)
fitmeasures(multisteps$fit.intercepts)
fitmeasures(multisteps$fit.residuals)

##Broke Down on Scalar and Strict Invariance
##Scalar First
partial = partialInvariance(multisteps, 
                            type = "intercepts")
interceptsfree = partial$results
multisteps2 = measurementInvariance(overallmodel,  
                                    data = nomissnop, 
                                    group = "source",
                                    strict = T,
                                    group.partial = c("MAPA19~1"))
##Now Strict
partial2 = partialInvariance(multisteps2, 
                            type = "residuals")
residualsfree = partial2$results
multisteps3 = measurementInvariance(overallmodel,  
                                    data = nomissnop, 
                                    group = "source",
                                    strict = T,
                                    group.partial = c("MAPA19~1", "MAPA5~~MAPA5"))


```

```{r MAPAtable, echo=FALSE, results='asis'}
tableMAPA = matrix(NA, nrow = 7, ncol = 8)
tableMAPA[ , 1] = c("Overall Model", "Random", "Not Random", 
                   "Configural", "Metric", "Scalar", "Strict")

fitused = c("chisq", "df", "rmsea", "srmr", "cfi")

tableMAPA[1, 2:8 ] = c(nrow(nomissnop), 
                      fitmeasures(overall.fit, fit.measures = fitused), 
                      "-")
tableMAPA[2, 2:8] = c(nrow(random), 
                      fitmeasures(overall.fit.r, fit.measures = fitused), 
                      "-")

tableMAPA[3, 2:8] = c(nrow(notrandom), 
                      fitmeasures(overall.fit.nr, fit.measures = fitused), 
                      "-")

tableMAPA[4, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps3$fit.configural, fit.measures = fitused), 
                      "-")

tableMAPA[5, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps3$fit.loadings, fit.measures = fitused), 
                      fitmeasures(multisteps3$fit.loadings)["cfi"] - fitmeasures(multisteps3$fit.configural)["cfi"])

tableMAPA[6, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps3$fit.intercepts, fit.measures = fitused), 
                      fitmeasures(multisteps3$fit.intercepts)["cfi"] - fitmeasures(multisteps3$fit.loadings)["cfi"])

tableMAPA[7, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps3$fit.residuals, fit.measures = fitused), 
                      fitmeasures(multisteps3$fit.residuals)["cfi"] - fitmeasures(multisteps3$fit.intercepts)["cfi"])

tableMAPA[ , 3] = printnum(as.numeric(tableMAPA[ , 3]), big.mark = "")
tableMAPA[ , 5:8] = printnum(as.numeric(tableMAPA[ , 5:8]), gt1 = F, digits = 3)


kable(tableMAPA, 
      col.names = c("Model", "N", "Chi-Square", 
                       "df", "RMSEA", "SRMR", "CFI", "Change CFI"))

```

```{r Meaning, include=FALSE}
##what is this one? -Jeff

```

```{r Meaningtable, echo=FALSE, results='asis'}

##what is this one? -Jeff

```

```{r MLM, include=FALSE}

MLM = master[ , c(160:183,14,955,956)]
names(MLM) 

##reverse coding for 5, 9, 19
library(car)
MLM$MLM5 = recode(MLM$MLM5, "1='7'; 2='6'; 3='5'; 4='4'; 5='3'; 6='2'; 7 = '1'")
MLM$MLM9 = recode(MLM$MLM9, "1='7'; 2='6'; 3='5'; 4='4'; 5='3'; 6='2'; 7 = '1'")
MLM$MLM18 = recode(MLM$MLM18, "1='7'; 2='6'; 3='5'; 4='4'; 5='3'; 6='2'; 7 = '1'")
MLM$MLM19 = recode(MLM$MLM19, "1='7'; 2='6'; 3='5'; 4='4'; 5='3'; 6='2'; 7 = '1'")
MLM$MLM20 = recode(MLM$MLM20, "1='7'; 2='6'; 3='5'; 4='4'; 5='3'; 6='2'; 7 = '1'")
MLM$MLM21 = recode(MLM$MLM21, "1='7'; 2='6'; 3='5'; 4='4'; 5='3'; 6='2'; 7 = '1'")
MLM$MLM22 = recode(MLM$MLM22, "1='7'; 2='6'; 3='5'; 4='4'; 5='3'; 6='2'; 7 = '1'")
MLM$MLM23 = recode(MLM$MLM23, "1='7'; 2='6'; 3='5'; 4='4'; 5='3'; 6='2'; 7 = '1'")

##Missing Data##
library(mice)
percentmiss = function(x){ sum(is.na(x))/length(x) *100 }

##Going by rows ONLY
notypos = MLM
names(notypos)
missing = apply(notypos[ , 1:24], 1, percentmiss) 
table(missing)

##replace only the data that you should
replacepeople = notypos[ missing <= 5 , ]  
dontpeople = notypos[ missing > 5 , ]

##figure out the columns to exclude (survey data)
apply(replacepeople, 2, percentmiss)
names(replacepeople)
replacecolumn = replacepeople[ , -c(25:27)]
dontcolumn = replacepeople[ , c(25:27)]

##let's mice it!
tempnomiss = mice(replacecolumn)
nomiss = complete(tempnomiss, 1)
summary(nomiss)

##put everything back together
filledin_none = cbind(dontcolumn, nomiss)
summary(filledin_none)

##Outliers##
names(filledin_none)
mahal = mahalanobis(filledin_none[ , -c(1:3)], 
                    colMeans(filledin_none[ , -c(1:3)], na.rm = TRUE),
                    cov(filledin_none[ , -c(1:3)], use="pairwise.complete.obs"))

cutoff = qchisq(.999,ncol(filledin_none[ , -c(1:3)])) 
summary(mahal < cutoff)
noout = filledin_none[ mahal < cutoff, ]

##additivity: correlations
correlations = cor(noout[,-c(1:3)], use="pairwise.complete.obs")
symnum(correlations)

##make the random stuff
random = rchisq(nrow(noout), 7)
##be sure here not to include the ID columns!
fake = lm(random~., data=noout[ , -c(1:3)])

##get the linearity plot
##create the standardized residuals
standardized = rstudent(fake)
qqnorm(standardized)
abline(0,1)

##multivariate normality
hist(standardized, breaks=15)

##homogeneity and homoscedaticity
fitvalues = scale(fake$fitted.values)
plot(fitvalues, standardized) 
abline(0,0)
abline(v = 0)

##scoring
##make sure 5, 9, 19 are reverse coded (this should be up top)
##exciting life = 1-5
##accomplished life = 6-10 
##principled life = 11-15 
##purposeful life = 16-19 
##valued life = 20-23

##subsetting data
#Zero = notrandom, One = random, Two = paper
nooutnop = subset(noout, source != 'paper') ##excludes paper
nomissnop = subset(filledin_none, source != 'paper') ##excludes paper

notrandom = subset(nomissnop, source == 'not random') ##noout and filled in none same dataset
random = subset(nomissnop, source == 'random')

library(lavaan)
##data sets
overallmodel = '
Exciting =~ MLM1 + MLM2 + MLM3 + MLM4 + MLM5 
Accomplished =~ MLM6 + MLM7 + MLM8 + MLM9 + MLM10
Principled =~ MLM11 + MLM12 + MLM13 + MLM14 + MLM15
Purposeful =~ MLM16 + MLM17 + MLM18 + MLM19  
Valued =~ MLM20 + MLM21 + MLM22 + MLM23
'

overall.fit = cfa(model = overallmodel, 
                  data=nomissnop, 
                  meanstructure = TRUE)

summary(overall.fit, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE)

##random
overall.fit.r = cfa(overallmodel, 
                    data=random, 
                    meanstructure = TRUE)

summary(overall.fit.r, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE)

##notrandom
overall.fit.nr = cfa(overallmodel, 
                     data=notrandom, 
                     meanstructure = TRUE)

summary(overall.fit.nr, 
        standardized=TRUE,
        rsquare=TRUE, 
        fit.measure = TRUE)
####Multigroup Testing####
library(semTools)
options(scipen = 999)
multisteps = measurementInvariance(overallmodel, 
                                   data = nomissnop, 
                                   group = "source",
                                   strict = T)

fitmeasures(multisteps$fit.configural)
fitmeasures(multisteps$fit.loadings)
fitmeasures(multisteps$fit.intercepts)
fitmeasures(multisteps$fit.residuals)

##Broke down at strict Invariance
partial = partialInvariance(multisteps, 
                            type = "residuals")
redidualsfree = partial$results
multisteps2 = measurementInvariance(overallmodel,  
                                    data = nomissnop, 
                                    group = "source",
                                    strict = T,
                                    group.partial = c("MLM22~~MLM22"))



```

```{r MLMtable, echo=FALSE, results='asis'}

tableMLM = matrix(NA, nrow = 7, ncol = 8)
tableMLM[ , 1] = c("Overall Model", "Random", "Not Random", 
                   "Configural", "Metric", "Scalar", "Strict")

fitused = c("chisq", "df", "rmsea", "srmr", "cfi")

tableMLM[1, 2:8 ] = c(nrow(nomissnop), 
                      fitmeasures(overall.fit, fit.measures = fitused), 
                      "-")
tableMLM[2, 2:8] = c(nrow(random), 
                      fitmeasures(overall.fit.r, fit.measures = fitused), 
                      "-")

tableMLM[3, 2:8] = c(nrow(notrandom), 
                      fitmeasures(overall.fit.nr, fit.measures = fitused), 
                      "-")

tableMLM[4, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps2$fit.configural, fit.measures = fitused), 
                      "-")

tableMLM[5, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps2$fit.loadings, fit.measures = fitused), 
                      fitmeasures(multisteps2$fit.loadings)["cfi"] - fitmeasures(multisteps2$fit.configural)["cfi"])

tableMLM[6, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps2$fit.intercepts, fit.measures = fitused), 
                      fitmeasures(multisteps2$fit.intercepts)["cfi"] - fitmeasures(multisteps2$fit.loadings)["cfi"])

tableMLM[7, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps2$fit.residuals, fit.measures = fitused), 
                      fitmeasures(multisteps2$fit.residuals)["cfi"] - fitmeasures(multisteps2$fit.intercepts)["cfi"])

tableMLM[ , 3] = printnum(as.numeric(tableMLM[ , 3]), big.mark = "")
tableMLM[ , 5:8] = printnum(as.numeric(tableMLM[ , 5:8]), gt1 = F, digits = 3)


kable(tableMLM, 
      col.names = c("Model", "N", "Chi-Square", 
                       "df", "RMSEA", "SRMR", "CFI", "Change CFI"))

```

```{r MIL-Jim, include=FALSE}

MILS = master[ , c(780:799,14,955,956)]
names(MILS)

##Reverse Coding
library(car)
MILS$MILS15 = recode(MILS$MILS15, "1='6'; 2='5'; 3='4'; 4='3'; 5='2'; 6='1'")

####DATA SCREENING####
##accuracy##
summary(MILS)

##hannah had a miscored thing here but I'm not sure what she meant - Jeff

##Missing Data##
library(mice)
percentmiss = function(x){ sum(is.na(x))/length(x) *100 }

##Going by rows ONLY
notypos = MILS
names(notypos)
missing = apply(notypos[ , 1:20], 1, percentmiss) 
table(missing)

##replace only the data that you should
replacepeople = notypos[ missing <= 5 , ]  
dontpeople = notypos[ missing > 5 , ]

##figure out the columns to exclude (survey data)
apply(replacepeople, 2, percentmiss)
names(replacepeople)
replacecolumn = replacepeople[ , -c(21:23)]
dontcolumn = replacepeople[ , c(21:23)]

##let's mice it!
tempnomiss = mice(replacecolumn)
nomiss = complete(tempnomiss, 1)
summary(nomiss)

##put everything back together
filledin_none = cbind(dontcolumn, nomiss)
summary(filledin_none)

##Outliers##
names(filledin_none)
mahal = mahalanobis(filledin_none[ , -c(1:3)], 
                    colMeans(filledin_none[ , -c(1:3)], na.rm = TRUE),
                    cov(filledin_none[ , -c(1:3)], use="pairwise.complete.obs"))
mahal
summary(mahal)
cutoff = qchisq(.999,ncol(filledin_none[ , -c(1:3)])) 
summary(mahal < cutoff)
noout = filledin_none[ mahal < cutoff, ]

##additivity: correlations
correlations = cor(noout[,-c(1:3)], use="pairwise.complete.obs")
symnum(correlations)

##make the random stuff
random = rchisq(nrow(noout), 7)
##be sure here not to include the ID columns!
fake = lm(random~., data=noout[ , -c(1:3)])

##get the linearity plot
##create the standardized residuals
standardized = rstudent(fake)
qqnorm(standardized)
abline(0,1)

##multivariate normality
hist(standardized, breaks=15)

##homogeneity and homoscedaticity
fitvalues = scale(fake$fitted.values)
plot(fitvalues, standardized) 
abline(0,0)
abline(v = 0)

##Factoring source##
#Zero = notrandom, One = random, Two = paper
nooutnop = subset(noout, source != 'paper') ##excludes paper
nomissnop = subset(filledin_none, source != 'paper') ##excludes paper

notrandom = subset(nomissnop, source == 'not random') ##noout and filled in none same dataset
random = subset(nomissnop, source == 'random')

####overall cfa everyone together##
overallmodel = '
harmony =~ MILS17 + MILS16 + MILS20 + MILS15
lifeperspective =~ MILS1 + MILS3 + MILS6 + MILS7 + MILS9 + MILS11 + MILS13
confusion =~ MILS2 + MILS5 + MILS4 + MILS8 + MILS10 + MILS12 + MILS14
spirit =~ MILS18 + MILS19
'

overall.fit = cfa(overallmodel, 
                  data=nomissnop, 
                  meanstructure = TRUE)

summary(overall.fit, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE)

####separate group models####
##notrandom
overall.fit.nr = cfa(overallmodel, 
                     data=notrandom, 
                     meanstructure = TRUE)

summary(overall.fit.nr, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE)

##random
overall.fit.r = cfa(overallmodel, 
                    data=random, 
                    meanstructure = TRUE)

summary(overall.fit.r, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE)


####multi group testing####
###measurement invariance
options(scipen = 999)

multisteps = measurementInvariance(overallmodel, 
                                   data = nomissnop, 
                                   group = "source",
                                   strict = T)

fitmeasures(multisteps$fit.configural)
fitmeasures(multisteps$fit.loadings)
fitmeasures(multisteps$fit.intercepts)
fitmeasures(multisteps$fit.residuals)






```

```{r MIL-Jimtable, echo=FALSE, results='asis'}

tableMILS = matrix(NA, nrow = 7, ncol = 8)
tableMILS[ , 1] = c("Overall Model", "Random", "Not Random", 
                   "Configural", "Metric", "Scalar", "Strict")

fitused = c("chisq", "df", "rmsea", "srmr", "cfi")

tableMILS[1, 2:8 ] = c(nrow(nomissnop), 
                      fitmeasures(overall.fit, fit.measures = fitused), 
                      "-")
tableMILS[2, 2:8] = c(nrow(random), 
                      fitmeasures(overall.fit.r, fit.measures = fitused), 
                      "-")

tableMILS[3, 2:8] = c(nrow(notrandom), 
                      fitmeasures(overall.fit.nr, fit.measures = fitused), 
                      "-")

tableMILS[4, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.configural, fit.measures = fitused), 
                      "-")

tableMILS[5, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.loadings, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.loadings)["cfi"] - fitmeasures(multisteps$fit.configural)["cfi"])

tableMILS[6, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.intercepts, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.intercepts)["cfi"] - fitmeasures(multisteps$fit.loadings)["cfi"])

tableMILS[7, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.residuals, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.residuals)["cfi"] - fitmeasures(multisteps$fit.intercepts)["cfi"])

tableMILS[ , 3] = printnum(as.numeric(tableMILS[ , 3]), big.mark = "")
tableMILS[ , 5:8] = printnum(as.numeric(tableMILS[ , 5:8]), gt1 = F, digits = 3)


kable(tableMILS, 
      col.names = c("Model", "N", "Chi-Square", 
                       "df", "RMSEA", "SRMR", "CFI", "Change CFI"))


```

```{r MIL-Kernes, include=FALSE}

##is this the right data? I know it's a repeat of MLQ. Wasn't sure which columns it was. Added the MLQ columns for now - Jeff

MLQ = master[ , c(894:903,14,955,956)]
names(MLQ)

##Reverse Code. 9
library(car)
MLQ$MLQ9 = recode(MLQ$MLQ9, "1='7'; 2='6'; 3='5'; 4='4'; 5='3'; 6='2'; 7='1'")

####DATA SCREENING####

##Missing Data##
library(mice)
percentmiss = function(x){ sum(is.na(x))/length(x) *100 }

##Going by rows ONLY
notypos = MLQ
names(notypos)
missing = apply(notypos[ , 1:10], 1, percentmiss) 
table(missing)


##replace only the data that you should
replacepeople = notypos[ missing <= 5 , ]  
dontpeople = notypos[ missing > 5 , ]

##figure out the columns to exclude (survey data)
apply(replacepeople, 2, percentmiss)
names(replacepeople)
replacecolumn = replacepeople[ , -c(11:13)]
dontcolumn = replacepeople[ , c(11:13)]

##no missing data.
nomiss = replacepeople

##Outliers##
mahal = mahalanobis(nomiss[ , -c(11:13)], 
                    colMeans(nomiss[ , -c(11:13)], na.rm = TRUE),
                    cov(nomiss[ , -c(11:13)], use="pairwise.complete.obs"))
mahal
summary(mahal)
cutoff = qchisq(.999,ncol(nomiss[ , -c(11:13)])) 
summary(mahal < cutoff)
noout = nomiss[ mahal < cutoff, ]

##additivity: correlations
correlations = cor(noout[,-c(11:13)], use="pairwise.complete.obs")
symnum(correlations)

##make the random stuff
random = rchisq(nrow(noout), 7)
##be sure here not to include the ID columns!
fake = lm(random~., data=noout[ , -c(11:13)])

##get the linearity plot
##create the standardized residuals
standardized = rstudent(fake)
qqnorm(standardized)
abline(0,1)

##multivariate normality
hist(standardized, breaks=15)

##homogeneity and homoscedaticity
fitvalues = scale(fake$fitted.values)
plot(fitvalues, standardized) 
abline(0,0)
abline(v = 0)


##MGCFA
library(lavaan)
library(semTools)
library(mice)
library(effsize)
library(ltm)

##Factoring source##
#Zero = notrandom, One = random, Two = paper
nooutnop = subset(noout, source != 'paper') ##excludes paper
nomissnop = subset(nomiss, source != 'paper') ##excludes paper

notrandom = subset(nomissnop, source == 'not random') ##noout and filled in none same dataset
random = subset(nomissnop, source == 'random')

##Model 
overallmodel = '
Presence =~ MLQ1 + MLQ4 + MLQ5 + MLQ6 + MLQ9
Search =~ MLQ2 + MLQ3 + MLQ7 + MLQ8 + MLQ10
'
overall.fit = cfa(overallmodel, 
                   data=nomissnop, 
                   meanstructure = TRUE)

summary(overall.fit, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE)

####separate group models####
##notrandom
overall.fit.nr = cfa(overallmodel, 
                     data=notrandom, 
                     meanstructure = TRUE)

summary(overall.fit.nr, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE)

##random
overall.fit.r = cfa(overallmodel, 
                    data=random, 
                    meanstructure = TRUE)

summary(overall.fit.r, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE)


####multi group testing####
###measurement invariance
options(scipen = 999)

multisteps = measurementInvariance(overallmodel, 
                                   data = nomissnop, 
                                   group = "source",
                                   strict = T)

fitmeasures(multisteps$fit.configural)
fitmeasures(multisteps$fit.loadings)
fitmeasures(multisteps$fit.intercepts)
fitmeasures(multisteps$fit.residuals)

```

```{r MIL-Kernestable, echo=FALSE, results='asis'}

tableMILK = matrix(NA, nrow = 7, ncol = 8)
tableMILK[ , 1] = c("Overall Model", "Random", "Not Random", 
                   "Configural", "Metric", "Scalar", "Strict")

fitused = c("chisq", "df", "rmsea", "srmr", "cfi")

tableMILK[1, 2:8 ] = c(nrow(nomissnop), 
                      fitmeasures(overall.fit, fit.measures = fitused), 
                      "-")
tableMILK[2, 2:8] = c(nrow(random), 
                      fitmeasures(overall.fit.r, fit.measures = fitused), 
                      "-")

tableMILK[3, 2:8] = c(nrow(notrandom), 
                      fitmeasures(overall.fit.nr, fit.measures = fitused), 
                      "-")

tableMILK[4, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.configural, fit.measures = fitused), 
                      "-")

tableMILK[5, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.loadings, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.loadings)["cfi"] - fitmeasures(multisteps$fit.configural)["cfi"])

tableMILK[6, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.intercepts, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.intercepts)["cfi"] - fitmeasures(multisteps$fit.loadings)["cfi"])

tableMILK[7, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.residuals, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.residuals)["cfi"] - fitmeasures(multisteps$fit.intercepts)["cfi"])

tableMILK[ , 3] = printnum(as.numeric(tableMILK[ , 3]), big.mark = "")
tableMILK[ , 5:8] = printnum(as.numeric(tableMILK[ , 5:8]), gt1 = F, digits = 3)


kable(tableMILK, 
      col.names = c("Model", "N", "Chi-Square", 
                       "df", "RMSEA", "SRMR", "CFI", "Change CFI"))

```

```{r MIL-Steger, include=FALSE}

##this is the same exact code for the Kernes one, because I don't know how the Kernes one's are labeled in regards to columns. Will need to figure that out and then update the one right above this.  

MLQ = master[ , c(894:903,14,955,956)]
names(MLQ)

##Reverse Code. 9
library(car)
MLQ$MLQ9 = recode(MLQ$MLQ9, "1='7'; 2='6'; 3='5'; 4='4'; 5='3'; 6='2'; 7='1'")

####DATA SCREENING####

##Missing Data##
library(mice)
percentmiss = function(x){ sum(is.na(x))/length(x) *100 }

##Going by rows ONLY
notypos = MLQ
names(notypos)
missing = apply(notypos[ , 1:10], 1, percentmiss) 
table(missing)


##replace only the data that you should
replacepeople = notypos[ missing <= 5 , ]  
dontpeople = notypos[ missing > 5 , ]

##figure out the columns to exclude (survey data)
apply(replacepeople, 2, percentmiss)
names(replacepeople)
replacecolumn = replacepeople[ , -c(11:13)]
dontcolumn = replacepeople[ , c(11:13)]

##no missing data.
nomiss = replacepeople

##Outliers##
mahal = mahalanobis(nomiss[ , -c(11:13)], 
                    colMeans(nomiss[ , -c(11:13)], na.rm = TRUE),
                    cov(nomiss[ , -c(11:13)], use="pairwise.complete.obs"))
mahal
summary(mahal)
cutoff = qchisq(.999,ncol(nomiss[ , -c(11:13)])) 
summary(mahal < cutoff)
noout = nomiss[ mahal < cutoff, ]

##additivity: correlations
correlations = cor(noout[,-c(11:13)], use="pairwise.complete.obs")
symnum(correlations)

##make the random stuff
random = rchisq(nrow(noout), 7)
##be sure here not to include the ID columns!
fake = lm(random~., data=noout[ , -c(11:13)])

##get the linearity plot
##create the standardized residuals
standardized = rstudent(fake)
qqnorm(standardized)
abline(0,1)

##multivariate normality
hist(standardized, breaks=15)

##homogeneity and homoscedaticity
fitvalues = scale(fake$fitted.values)
plot(fitvalues, standardized) 
abline(0,0)
abline(v = 0)


##MGCFA
library(lavaan)
library(semTools)
library(mice)
library(effsize)
library(ltm)

##Factoring source##
#Zero = notrandom, One = random, Two = paper
nooutnop = subset(noout, source != 'paper') ##excludes paper
nomissnop = subset(nomiss, source != 'paper') ##excludes paper

notrandom = subset(nomissnop, source == 'not random') ##noout and filled in none same dataset
random = subset(nomissnop, source == 'random')

##Model 
overallmodel = '
Presence =~ MLQ1 + MLQ4 + MLQ5 + MLQ6 + MLQ9
Search =~ MLQ2 + MLQ3 + MLQ7 + MLQ8 + MLQ10
'
overall.fit = cfa(overallmodel, 
                   data=nomissnop, 
                   meanstructure = TRUE)

summary(overall.fit, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE)

####separate group models####
##notrandom
overall.fit.nr = cfa(overallmodel, 
                     data=notrandom, 
                     meanstructure = TRUE)

summary(overall.fit.nr, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE)

##random
overall.fit.r = cfa(overallmodel, 
                    data=random, 
                    meanstructure = TRUE)

summary(overall.fit.r, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE)


####multi group testing####
###measurement invariance
options(scipen = 999)

multisteps = measurementInvariance(overallmodel, 
                                   data = nomissnop, 
                                   group = "source",
                                   strict = T)

fitmeasures(multisteps$fit.configural)
fitmeasures(multisteps$fit.loadings)
fitmeasures(multisteps$fit.intercepts)
fitmeasures(multisteps$fit.residuals)

```

```{r MIL-Stegertable, echo=FALSE, results='asis'}

tableMLQ = matrix(NA, nrow = 7, ncol = 8)
tableMLQ[ , 1] = c("Overall Model", "Random", "Not Random", 
                   "Configural", "Metric", "Scalar", "Strict")

fitused = c("chisq", "df", "rmsea", "srmr", "cfi")

tableMLQ[1, 2:8 ] = c(nrow(nomissnop), 
                      fitmeasures(overall.fit, fit.measures = fitused), 
                      "-")
tableMLQ[2, 2:8] = c(nrow(random), 
                      fitmeasures(overall.fit.r, fit.measures = fitused), 
                      "-")

tableMLQ[3, 2:8] = c(nrow(notrandom), 
                      fitmeasures(overall.fit.nr, fit.measures = fitused), 
                      "-")

tableMLQ[4, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.configural, fit.measures = fitused), 
                      "-")

tableMLQ[5, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.loadings, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.loadings)["cfi"] - fitmeasures(multisteps$fit.configural)["cfi"])

tableMLQ[6, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.intercepts, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.intercepts)["cfi"] - fitmeasures(multisteps$fit.loadings)["cfi"])

tableMLQ[7, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.residuals, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.residuals)["cfi"] - fitmeasures(multisteps$fit.intercepts)["cfi"])

tableMLQ[ , 3] = printnum(as.numeric(tableMLQ[ , 3]), big.mark = "")
tableMLQ[ , 5:8] = printnum(as.numeric(tableMLQ[ , 5:8]), gt1 = F, digits = 3)


kable(tableMLQ, 
      col.names = c("Model", "N", "Chi-Square", 
                       "df", "RMSEA", "SRMR", "CFI", "Change CFI"))

```

```{r MIL-Tomich, include=FALSE}

MLT = master[ , c(184:187,14,955,956)]
names(MLT)

##Reverse Code. No reverse coding

####DATA SCREENING####

##Missing Data##
library(mice)
percentmiss = function(x){ sum(is.na(x))/length(x) *100 }

##Going by rows ONLY
notypos = MLT
names(notypos)
missing = apply(notypos[ , 1:4], 1, percentmiss) 
table(missing)

##replace only the data that you should
replacepeople = notypos[ missing <= 5 , ]  
dontpeople = notypos[ missing > 5 , ]

##figure out the columns to exclude (survey data)
apply(replacepeople, 2, percentmiss)
names(replacepeople)
replacecolumn = replacepeople[ , -c(5:7)]
dontcolumn = replacepeople[ , c(5:7)]

nomiss = replacepeople

##Outliers##
names(nomiss)
mahal = mahalanobis(nomiss[ , -c(5:7)], 
                    colMeans(nomiss[ , -c(5:7)], na.rm = TRUE),
                    cov(nomiss[ , -c(5:7)], use="pairwise.complete.obs"))
mahal
summary(mahal)
cutoff = qchisq(.999,ncol(nomiss[ , -c(5:7)])) 
summary(mahal < cutoff)
noout = nomiss[ mahal < cutoff, ]

##additivity: correlations
correlations = cor(noout[,-c(5:7)], use="pairwise.complete.obs")
symnum(correlations)

##make the random stuff
random = rchisq(nrow(noout), 7)
##be sure here not to include the ID columns!
fake = lm(random~., data=noout[ , -c(5:7)])

##get the linearity plot
##create the standardized residuals
standardized = rstudent(fake)
qqnorm(standardized)
abline(0,1)

##multivariate normality
hist(standardized, breaks=15)

##homogeneity and homoscedaticity
fitvalues = scale(fake$fitted.values)
plot(fitvalues, standardized) 
abline(0,0)
abline(v = 0)

##Scoring
MLT <- rowMeans(noout[, c(1:4)])
MLT

##Factoring source##
#Zero = notrandom, One = random, Two = paper
nooutnop = subset(noout, source != 'paper') ##excludes paper
nomissnop = subset(nomiss, source != 'paper') ##excludes paper

notrandom = subset(nomissnop, source == 'not random') ##noout and filled in none same dataset
random = subset(nomissnop, source == 'random')

####overall cfa everyone together##
overallmodel = '
MLT =~ MLT1 + MLT2 + MLT3 + MLT4
'

overall.fit = cfa(overallmodel, 
                  data=nomissnop, 
                  meanstructure = TRUE)

summary(overall.fit, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE)

####separate group models####
##notrandom
overall.fit.nr = cfa(overallmodel, 
                     data=notrandom, 
                     meanstructure = TRUE)

summary(overall.fit.nr, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE)

##random
overall.fit.r = cfa(overallmodel, 
                    data=random, 
                    meanstructure = TRUE)

summary(overall.fit.r, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE)


####multi group testing####
###measurement invariance
options(scipen = 999)

multisteps = measurementInvariance(overallmodel, 
                                   data = nomissnop, 
                                   group = "source",
                                   strict = T)

fitmeasures(multisteps$fit.configural)
fitmeasures(multisteps$fit.loadings)
fitmeasures(multisteps$fit.intercepts)
fitmeasures(multisteps$fit.residuals)
```

```{r MIL-Tomichtable, echo=FALSE, results='asis'}

tableMLT = matrix(NA, nrow = 7, ncol = 8)
tableMLT[ , 1] = c("Overall Model", "Random", "Not Random", 
                   "Configural", "Metric", "Scalar", "Strict")

fitused = c("chisq", "df", "rmsea", "srmr", "cfi")

tableMLT[1, 2:8 ] = c(nrow(nomissnop), 
                      fitmeasures(overall.fit, fit.measures = fitused), 
                      "-")
tableMLT[2, 2:8] = c(nrow(random), 
                      fitmeasures(overall.fit.r, fit.measures = fitused), 
                      "-")

tableMLT[3, 2:8] = c(nrow(notrandom), 
                      fitmeasures(overall.fit.nr, fit.measures = fitused), 
                      "-")

tableMLT[4, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.configural, fit.measures = fitused), 
                      "-")

tableMLT[5, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.loadings, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.loadings)["cfi"] - fitmeasures(multisteps$fit.configural)["cfi"])

tableMLT[6, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.intercepts, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.intercepts)["cfi"] - fitmeasures(multisteps$fit.loadings)["cfi"])

tableMLT[7, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.residuals, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.residuals)["cfi"] - fitmeasures(multisteps$fit.intercepts)["cfi"])

tableMLT[ , 3] = printnum(as.numeric(tableMLQ[ , 3]), big.mark = "")
tableMLT[ , 5:8] = printnum(as.numeric(tableMLQ[ , 5:8]), gt1 = F, digits = 3)


kable(tableMLT, 
      col.names = c("Model", "N", "Chi-Square", 
                       "df", "RMSEA", "SRMR", "CFI", "Change CFI"))

```

```{r MIL-Warner, include=FALSE}

ML = master[ , c(592:605, 14,955,956)]
names(ML)

####DATA SCREENING####
##accuracy##
##Missing Data##
library(mice)
percentmiss = function(x){ sum(is.na(x))/length(x) *100 }

##Going by rows ONLY
notypos = ML
names(notypos)
missing = apply(notypos[ , 1:14], 1, percentmiss) 
table(missing)

##replace only the data that you should
replacepeople = notypos[ missing <= 5 , ]  
dontpeople = notypos[ missing > 5 , ]

##figure out the columns to exclude (survey data)
apply(replacepeople, 2, percentmiss)
names(replacepeople)
replacecolumn = replacepeople[ , -c(15:17)]
dontcolumn = replacepeople[ , c(15:17)]

nomiss = replacepeople

##Outliers##
names(nomiss)
mahal = mahalanobis(nomiss[ , -c(15:17)], 
                    colMeans(nomiss[ , -c(15:17)], na.rm = TRUE),
                    cov(nomiss[ , -c(15:17)], use="pairwise.complete.obs"))
mahal
summary(mahal)
cutoff = qchisq(.999,ncol(nomiss[ , -c(15:17)])) 
summary(mahal < cutoff)
noout = nomiss[ mahal < cutoff, ]

##additivity: correlations
correlations = cor(noout[,-c(15:17)], use="pairwise.complete.obs")
symnum(correlations)

##make the random stuff
random = rchisq(nrow(noout), 7)
##be sure here not to include the ID columns!
fake = lm(random~., data=noout[ , -c(15:17)])

##get the linearity plot
##create the standardized residuals
standardized = rstudent(fake)
qqnorm(standardized)
abline(0,1)

##multivariate normality
hist(standardized, breaks=15)

##homogeneity and homoscedaticity
fitvalues = scale(fake$fitted.values)
plot(fitvalues, standardized) 
abline(0,0)
abline(v = 0)

###Scoring
ML <- rowSums(noout[, c(1:14)])
ML

##subsetting data
#Zero = notrandom, One = random, Two = paper
nooutnop = subset(noout, source != 'paper') ##excludes paper
nomissnop = subset(nomiss, source != 'paper') ##excludes paper

notrandom = subset(nomissnop, source == 'not random') ##noout and filled in none same dataset
random = subset(nomissnop, source == 'random')

library(lavaan)
##data sets

overallmodel = 'ML =~ ML1 + ML2 + ML3 + ML4 + ML5 + ML6 + ML7 + ML8 +
      ML9 + ML10 + ML11 + ML12 + ML13 + ML14
'
overall.fit = cfa(model = overallmodel, 
                   data=nomissnop, 
                   meanstructure = TRUE)

summary(overall.fit, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE)

##random
overall.fit.r = cfa(overallmodel, 
                    data=random, 
                    meanstructure = TRUE)

summary(overall.fit.r, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE)
##notrandom
overall.fit.nr = cfa(overallmodel, 
                     data=notrandom, 
                     meanstructure = TRUE)

summary(overall.fit.nr, 
        standardized=TRUE,
        rsquare=TRUE, 
        fit.measure = TRUE)
####Multigroup Testing####
library(semTools)
options(scipen = 999)
multisteps = measurementInvariance(overallmodel, 
                                   data = nomissnop, 
                                   group = "source",
                                   strict = T)

fitmeasures(multisteps$fit.configural)
fitmeasures(multisteps$fit.loadings)
fitmeasures(multisteps$fit.intercepts)
fitmeasures(multisteps$fit.residuals)

## broke down on strict invariance 
partial = partialInvariance(multisteps, 
                            type = "residuals")
redidualsfree = partial$results
multisteps2 = measurementInvariance(overallmodel,  
                                    data = nomissnop, 
                                    group = "source",
                                    strict = T,
                                    group.partial = c("ML8~~ML8"))

```

```{r MIL-Warnertable, echo=FALSE, results='asis'}

tableML = matrix(NA, nrow = 7, ncol = 8)
tableML[ , 1] = c("Overall Model", "Random", "Not Random", 
                   "Configural", "Metric", "Scalar", "Strict")

fitused = c("chisq", "df", "rmsea", "srmr", "cfi")

tableML[1, 2:8 ] = c(nrow(nomissnop), 
                      fitmeasures(overall.fit, fit.measures = fitused), 
                      "-")
tableML[2, 2:8] = c(nrow(random), 
                      fitmeasures(overall.fit.r, fit.measures = fitused), 
                      "-")

tableML[3, 2:8] = c(nrow(notrandom), 
                      fitmeasures(overall.fit.nr, fit.measures = fitused), 
                      "-")

tableML[4, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps2$fit.configural, fit.measures = fitused), 
                      "-")

tableML[5, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps2$fit.loadings, fit.measures = fitused), 
                      fitmeasures(multisteps2$fit.loadings)["cfi"] - fitmeasures(multisteps2$fit.configural)["cfi"])

tableML[6, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps2$fit.intercepts, fit.measures = fitused), 
                      fitmeasures(multisteps2$fit.intercepts)["cfi"] - fitmeasures(multisteps2$fit.loadings)["cfi"])

tableML[7, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps2$fit.residuals, fit.measures = fitused), 
                      fitmeasures(multisteps2$fit.residuals)["cfi"] - fitmeasures(multisteps2$fit.intercepts)["cfi"])

tableML[ , 3] = printnum(as.numeric(tableML[ , 3]), big.mark = "")
tableML[ , 5:8] = printnum(as.numeric(tableML[ , 5:8]), gt1 = F, digits = 3)


kable(tableML, 
      col.names = c("Model", "N", "Chi-Square", 
                       "df", "RMSEA", "SRMR", "CFI", "Change CFI"))

```

```{r MILI, include=FALSE}

MILI = master[ , c(561:569, 14,955,956)]
names(MILI)

##Reverse Code. No reverse coding

####DATA SCREENING####

##Missing Data##
library(mice)
percentmiss = function(x){ sum(is.na(x))/length(x) *100 }

##Going by rows ONLY
notypos = MILI
names(notypos)
missing = apply(notypos[ , 1:9], 1, percentmiss) 
table(missing)
 
##replace only the data that you should
replacepeople = notypos[ missing <= 5 , ]  
dontpeople = notypos[ missing > 5 , ]

##figure out the columns to exclude (survey data)
apply(replacepeople, 2, percentmiss)
names(replacepeople)
replacecolumn = replacepeople[ , -c(10:12)]
dontcolumn = replacepeople[ , c(10:12)]

nomiss = replacepeople

##Outliers##
mahal = mahalanobis(nomiss[ , -c(10:12)], 
                    colMeans(nomiss[ , -c(10:12)], na.rm = TRUE),
                    cov(nomiss[ , -c(10:12)], use="pairwise.complete.obs"))
mahal
summary(mahal)
cutoff = qchisq(.999,ncol(nomiss[ , -c(10:12)])) 
summary(mahal < cutoff)
noout = nomiss[ mahal < cutoff, ]

##additivity: correlations
correlations = cor(noout[,-c(10:12)], use="pairwise.complete.obs")
symnum(correlations)

##make the random stuff
random = rchisq(nrow(noout), 7)
##be sure here not to include the ID columns!
fake = lm(random~., data=noout[ , -c(10:12)])

##get the linearity plot
##create the standardized residuals
standardized = rstudent(fake)
qqnorm(standardized)
abline(0,1)

##multivariate normality
hist(standardized, breaks=15)

##homogeneity and homoscedaticity
fitvalues = scale(fake$fitted.values)
plot(fitvalues, standardized) 
abline(0,0)
abline(v = 0)

##Scoring
MILI <- rowSums(noout[, c(1:9)])
MILI

##Factoring source##
#Zero = notrandom, One = random, Two = paper
nooutnop = subset(noout, source != 'paper') ##excludes paper
nomissnop = subset(nomiss, source != 'paper') ##excludes paper

notrandom = subset(nomissnop, source == 'not random') ##noout and filled in none same dataset
random = subset(nomissnop, source == 'random')

####overall cfa everyone together##
overallmodel = '
MILI =~ MILI1 + MILI2 + MILI3 + MILI4 + MILI5 + MILI6 + MILI7 + MILI8 + MILI9
'

overall.fit = cfa(overallmodel, 
                  data=nomissnop, 
                  meanstructure = TRUE)

summary(overall.fit, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE)

####separate group models####
##notrandom
overall.fit.nr = cfa(overallmodel, 
                     data=notrandom, 
                     meanstructure = TRUE)

summary(overall.fit.nr, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE)

##random
overall.fit.r = cfa(overallmodel, 
                    data=random, 
                    meanstructure = TRUE)

summary(overall.fit.r, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE)


####multi group testing####
###measurement invariance
options(scipen = 999)

multisteps = measurementInvariance(overallmodel, 
                                   data = nomissnop, 
                                   group = "source",
                                   strict = T)

fitmeasures(multisteps$fit.configural)
fitmeasures(multisteps$fit.loadings)
fitmeasures(multisteps$fit.intercepts)
fitmeasures(multisteps$fit.residuals)

```

```{r MILItable, echo=FALSE, results='asis'}

tableMILI = matrix(NA, nrow = 7, ncol = 8)
tableMILI[ , 1] = c("Overall Model", "Random", "Not Random", 
                   "Configural", "Metric", "Scalar", "Strict")

fitused = c("chisq", "df", "rmsea", "srmr", "cfi")

tableMILI[1, 2:8 ] = c(nrow(nomissnop), 
                      fitmeasures(overall.fit, fit.measures = fitused), 
                      "-")
tableMILI[2, 2:8] = c(nrow(random), 
                      fitmeasures(overall.fit.r, fit.measures = fitused), 
                      "-")

tableMILI[3, 2:8] = c(nrow(notrandom), 
                      fitmeasures(overall.fit.nr, fit.measures = fitused), 
                      "-")

tableMILI[4, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.configural, fit.measures = fitused), 
                      "-")

tableMILI[5, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.loadings, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.loadings)["cfi"] - fitmeasures(multisteps$fit.configural)["cfi"])

tableMILI[6, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.intercepts, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.intercepts)["cfi"] - fitmeasures(multisteps$fit.loadings)["cfi"])

tableMILI[7, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.residuals, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.residuals)["cfi"] - fitmeasures(multisteps$fit.intercepts)["cfi"])

tableMILI[ , 3] = printnum(as.numeric(tableMILI[ , 3]), big.mark = "")
tableMILI[ , 5:8] = printnum(as.numeric(tableMILI[ , 5:8]), gt1 = F, digits = 3)


kable(tableMILI, 
      col.names = c("Model", "N", "Chi-Square", 
                       "df", "RMSEA", "SRMR", "CFI", "Change CFI"))

```

```{r MMS, include=FALSE}

MMS = master[ , c(188:194, 14,955,956)]
names(MMS)

##Reverse Code for number 3
library(car)
MMS$MMS3 = recode(MMS$MMS3, "1='6'; 2='5'; 3='4'; 4='3'; 5='2'; 6='1'")

####DATA SCREENING####

##Missing Data##
library(mice)
percentmiss = function(x){ sum(is.na(x))/length(x) *100 }

##Going by rows ONLY
notypos = MMS
names(notypos)
missing = apply(notypos[ , 1:7], 1, percentmiss) 
table(missing)

##replace only the data that you should
replacepeople = notypos[ missing <= 5 , ]  
dontpeople = notypos[ missing > 5 , ]

##figure out the columns to exclude (survey data)
apply(replacepeople, 2, percentmiss)
names(replacepeople)
replacecolumn = replacepeople[ , -c(8:10)]
dontcolumn = replacepeople[ , c(8:10)]

nomiss = replacepeople

##Outliers##
mahal = mahalanobis(nomiss[ , -c(8:10)], 
                    colMeans(nomiss[ , -c(8:10)], na.rm = TRUE),
                    cov(nomiss[ , -c(8:10)], use="pairwise.complete.obs"))

cutoff = qchisq(.999,ncol(nomiss[ , -c(8:10)])) 
summary(mahal < cutoff)
noout = nomiss[ mahal < cutoff, ]

##additivity: correlations
correlations = cor(noout[,-c(8:10)], use="pairwise.complete.obs")
symnum(correlations)

##make the random stuff
random = rchisq(nrow(noout), 7)
##be sure here not to include the ID columns!
fake = lm(random~., data=noout[ , -c(8:10)])

##get the linearity plot
##create the standardized residuals
standardized = rstudent(fake)
qqnorm(standardized)
abline(0,1)

##multivariate normality
hist(standardized, breaks=15)

##homogeneity and homoscedaticity
fitvalues = scale(fake$fitted.values)
plot(fitvalues, standardized) 
abline(0,0)
abline(v = 0)

##Scoring
MMS <- rowSums(noout[, c(1:7)])
MMS

##subsetting data
#Zero = notrandom, One = random, Two = paper
nooutnop = subset(noout, source != 'paper') ##excludes paper
nomissnop = subset(nomiss, source != 'paper') ##excludes paper

notrandom = subset(nomissnop, source == 'not random') ##noout and filled in none same dataset
random = subset(nomissnop, source == 'random')


library(lavaan)
overallmodel = '
MMS =~ MMS1 + MMS2 + MMS3 + MMS4 + MMS5 + MMS6 + MMS7
'
overall.fit = cfa(model = overallmodel, 
                  data=nomissnop, 
                  meanstructure = TRUE)

summary(overall.fit, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE)
##random
overall.fit.r = cfa(overallmodel, 
                    data=random, 
                    meanstructure = TRUE)

summary(overall.fit.r, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE)
##notrandom
overall.fit.nr = cfa(overallmodel, 
                     data=notrandom, 
                     meanstructure = TRUE)

summary(overall.fit.nr, 
        standardized=TRUE,
        rsquare=TRUE, 
        fit.measure = TRUE)

####Multigroup Testing####
library(semTools)
options(scipen = 999)
multisteps = measurementInvariance(overallmodel, 
                                   data = nomissnop, 
                                   group = "source",
                                   strict = T)

fitmeasures(multisteps$fit.configural)
fitmeasures(multisteps$fit.loadings)
fitmeasures(multisteps$fit.intercepts)
fitmeasures(multisteps$fit.residuals)

##Broke down on Metric and Strict Invariance
partial = partialInvariance(multisteps, 
                            type = "loadings")
loadingsfree = partial$results
multisteps2 = measurementInvariance(overallmodel,  
                                    data = nomissnop, 
                                    group = "source",
                                    strict = T,
                                    group.partial = c("=~MMS1"))
##Now Broke down on Scalar Invariance
partial2 = partialInvariance(multisteps2, 
                             type = "intercepts")
interceptsfree = partial2$results
multisteps3 = measurementInvariance(overallmodel,  
                                    data = nomissnop, 
                                    group = "source",
                                    strict = T,
                                    group.partial = c("=~MMS1", "MMS4~1", "MMS6~1"))


```

```{r MMStable, echo=FALSE, results='asis'}

tableMMS = matrix(NA, nrow = 7, ncol = 8)
tableMMS[ , 1] = c("Overall Model", "Random", "Not Random", 
                   "Configural", "Metric", "Scalar", "Strict")

fitused = c("chisq", "df", "rmsea", "srmr", "cfi")

tableMMS[1, 2:8 ] = c(nrow(nomissnop), 
                      fitmeasures(overall.fit, fit.measures = fitused), 
                      "-")
tableMMS[2, 2:8] = c(nrow(random), 
                      fitmeasures(overall.fit.r, fit.measures = fitused), 
                      "-")

tableMMS[3, 2:8] = c(nrow(notrandom), 
                      fitmeasures(overall.fit.nr, fit.measures = fitused), 
                      "-")

tableMMS[4, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps3$fit.configural, fit.measures = fitused), 
                      "-")

tableMMS[5, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps3$fit.loadings, fit.measures = fitused), 
                      fitmeasures(multisteps3$fit.loadings)["cfi"] - fitmeasures(multisteps3$fit.configural)["cfi"])

tableMMS[6, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps3$fit.intercepts, fit.measures = fitused), 
                      fitmeasures(multisteps3$fit.intercepts)["cfi"] - fitmeasures(multisteps3$fit.loadings)["cfi"])

tableMMS[7, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps3$fit.residuals, fit.measures = fitused), 
                      fitmeasures(multisteps3$fit.residuals)["cfi"] - fitmeasures(multisteps3$fit.intercepts)["cfi"])

tableMMS[ , 3] = printnum(as.numeric(tableMMS[ , 3]), big.mark = "")
tableMMS[ , 5:8] = printnum(as.numeric(tableMMS[ , 5:8]), gt1 = F, digits = 3)


kable(tableMMS, 
      col.names = c("Model", "N", "Chi-Square", 
                       "df", "RMSEA", "SRMR", "CFI", "Change CFI"))

```

```{r MM, include=FALSE}

##I'm guessing this one is the mundane meaning one

MMM = master[ , c(800:815,14,955,956)]
names(MMM)

####DATA SCREENING####
##Reverse Code. No reverse coding. Stopped here for scoring.
##Missing Data##
library(mice)
percentmiss = function(x){ sum(is.na(x))/length(x) *100 }

##Going by rows ONLY
notypos = MMM
names(notypos)
missing = apply(notypos[ , 1:16], 1, percentmiss) 
table(missing)

##replace only the data that you should
replacepeople = notypos[ missing <= 5 , ]  
dontpeople = notypos[ missing > 5 , ]

##figure out the columns to exclude (survey data)
apply(replacepeople, 2, percentmiss)
names(replacepeople)
replacecolumn = replacepeople[ , -c(17:19)]
dontcolumn = replacepeople[ , c(17:19)]

nomiss = replacepeople

##Outliers##
mahal = mahalanobis(nomiss[ , -c(17:19)], 
                    colMeans(nomiss[ , -c(17:19)], na.rm = TRUE),
                    cov(nomiss[ , -c(17:19)], use="pairwise.complete.obs"))

cutoff = qchisq(.999,ncol(nomiss[ , -c(17:19)])) 
summary(mahal < cutoff)
noout = nomiss[ mahal < cutoff, ]

##additivity: correlations
correlations = cor(noout[,-c(17:19)], use="pairwise.complete.obs")
symnum(correlations)

##make the random stuff
random = rchisq(nrow(noout), 7)
##be sure here not to include the ID columns!
fake = lm(random~., data=noout[ , -c(17:19)])

##get the linearity plot
##create the standardized residuals
standardized = rstudent(fake)
qqnorm(standardized)
abline(0,1)

##multivariate normality
hist(standardized, breaks=15)

##homogeneity and homoscedaticity
fitvalues = scale(fake$fitted.values)
plot(fitvalues, standardized) 
abline(0,0)
abline(v = 0)

##scoring 
##Coherence = 1-4 
##Integration of Circumstances = 5-8 
##High Level Action Identification = 9-12 
##Sense of Purpose = 13-16

##subsetting data
#Zero = notrandom, One = random, Two = paper
nooutnop = subset(noout, source != 'paper') ##excludes paper
nomissnop = subset(nomiss, source != 'paper') ##excludes paper

notrandom = subset(nomissnop, source == 'not random') ##noout and filled in none same dataset
random = subset(nomissnop, source == 'random')

library(lavaan)
##data sets
overallmodel = '
Coherence =~ MMM1 + MMM2 + MMM3 + MMM4 
Integration =~ MMM5 + MMM6 +MMM7 + MMM8  
HLAIdentification =~ MMM9 + MMM10 + MMM11 + MMM12   
SunseofPurpose =~ MMM13 + MMM14 + MMM15 + MMM16    
'
overall.fit = cfa(model = overallmodel, 
                  data=nomissnop, 
                  meanstructure = TRUE)

summary(overall.fit, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE)
##random
overall.fit.r = cfa(overallmodel, 
                    data=random, 
                    meanstructure = TRUE)

summary(overall.fit.r, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE)
##notrandom
overall.fit.nr = cfa(overallmodel, 
                     data=notrandom, 
                     meanstructure = TRUE)

summary(overall.fit.nr, 
        standardized=TRUE,
        rsquare=TRUE, 
        fit.measure = TRUE)
####Multigroup Testing####
library(semTools)
options(scipen = 999)
multisteps = measurementInvariance(overallmodel, 
                                   data = nomissnop, 
                                   group = "source",
                                   strict = T)
fitmeasures(multisteps$fit.configural)
fitmeasures(multisteps$fit.loadings)
fitmeasures(multisteps$fit.intercepts)
fitmeasures(multisteps$fit.residuals)

```

```{r MMtable, echo=FALSE, results='asis'}

tableMM = matrix(NA, nrow = 7, ncol = 8)
tableMM[ , 1] = c("Overall Model", "Random", "Not Random", 
                   "Configural", "Metric", "Scalar", "Strict")

fitused = c("chisq", "df", "rmsea", "srmr", "cfi")

tableMM[1, 2:8 ] = c(nrow(nomissnop), 
                      fitmeasures(overall.fit, fit.measures = fitused), 
                      "-")
tableMM[2, 2:8] = c(nrow(random), 
                      fitmeasures(overall.fit.r, fit.measures = fitused), 
                      "-")

tableMM[3, 2:8] = c(nrow(notrandom), 
                      fitmeasures(overall.fit.nr, fit.measures = fitused), 
                      "-")

tableMM[4, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.configural, fit.measures = fitused), 
                      "-")

tableMM[5, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.loadings, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.loadings)["cfi"] - fitmeasures(multisteps$fit.configural)["cfi"])

tableMM[6, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.intercepts, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.intercepts)["cfi"] - fitmeasures(multisteps$fit.loadings)["cfi"])

tableMM[7, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.residuals, fit.measures = fitused), 
                      fitmeasures(multistep$fit.residuals)["cfi"] - fitmeasures(multisteps3$fit.intercepts)["cfi"])

tableMM[ , 3] = printnum(as.numeric(tableMM[ , 3]), big.mark = "")
tableMM[ , 5:8] = printnum(as.numeric(tableMM[ , 5:8]), gt1 = F, digits = 3)


kable(tableMM, 
      col.names = c("Model", "N", "Chi-Square", 
                       "df", "RMSEA", "SRMR", "CFI", "Change CFI"))

```

```{r NoM, include=FALSE}

NOM = master[ , c(578:591,14,955,956)]
names(NOM)

##Reverse Code. Not needed.

####DATA SCREENING####

##Missing Data##
library(mice)
percentmiss = function(x){ sum(is.na(x))/length(x) *100 }

##Going by rows ONLY
##here I excluded the first two columns because they were 
##included for everyone as IDs, so I don't want to count that
##as part of the percent toward what they did
notypos = NOM
names(notypos)
missing = apply(notypos[ , 1:14], 1, percentmiss) 
table(missing)


##replace only the data that you should
replacepeople = notypos[ missing <= 5 , ]  
dontpeople = notypos[ missing > 5 , ]

##figure out the columns to exclude (survey data)
apply(replacepeople, 2, percentmiss)
names(replacepeople)
replacecolumn = replacepeople[ , -c(15:17)]
dontcolumn = replacepeople[ , c(15:17)]

nomiss = replacepeople

##Outliers##
mahal = mahalanobis(nomiss[ , -c(15:17)], 
                    colMeans(nomiss[ , -c(15:17)], na.rm = TRUE),
                    cov(nomiss[ , -c(15:17)], use="pairwise.complete.obs"))
mahal
summary(mahal)
cutoff = qchisq(.999,ncol(nomiss[ , -c(15:17)])) 
summary(mahal < cutoff)
noout = nomiss[ mahal < cutoff, ]

##additivity: correlations
correlations = cor(noout[,-c(15:17)], use="pairwise.complete.obs")
symnum(correlations)

##make the random stuff
random = rchisq(nrow(noout), 7)
##be sure here not to include the ID columns!
fake = lm(random~., data=noout[ , -c(15:17)])

##get the linearity plot
##create the standardized residuals
standardized = rstudent(fake)
qqnorm(standardized)
abline(0,1)

##multivariate normality
hist(standardized, breaks=15)

##homogeneity and homoscedaticity
fitvalues = scale(fake$fitted.values)
plot(fitvalues, standardized) 
abline(0,0)
abline(v = 0)

##Scoring
##Not enough questions on this one to justify all the scales
##Summed the questions that were avalible

NoM <- rowSums(noout[, c(1:14)])
NoM

##Factoring source##
#Zero = notrandom, One = random, Two = paper
nooutnop = subset(noout, source != 'paper') ##excludes paper
nomissnop = subset(nomiss, source != 'paper') ##excludes paper

notrandom = subset(nomissnop, source == 'not random') ##noout and filled in none same dataset
random = subset(nomissnop, source == 'random')


##Model 
overallmodel = '
NoMean =~ NOM1 + NOM2 + NOM3 + NOM4 + NOM5 + NOM6 + NOM7 + NOM8 + NOM9 + NOM10 + NOM11 + NOM12 + NOM13 + NOM14
'
overall.fit = cfa(overallmodel, 
                  data=nomissnop, 
                  meanstructure = TRUE)

summary(overall.fit, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE)

####separate group models####
##notrandom
overall.fit.nr = cfa(overallmodel, 
                     data=notrandom, 
                     meanstructure = TRUE)

summary(overall.fit.nr, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE)

##random
overall.fit.r = cfa(overallmodel, 
                    data=random, 
                    meanstructure = TRUE)

summary(overall.fit.r, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE)


####multi group testing####
###measurement invariance
options(scipen = 999)

multisteps = measurementInvariance(overallmodel, 
                                   data = nomissnop, 
                                   group = "Source",
                                   strict = T)

fitmeasures(multisteps$fit.configural)
fitmeasures(multisteps$fit.loadings)
fitmeasures(multisteps$fit.intercepts)
fitmeasures(multisteps$fit.residuals)



```

```{r NoMtable, echo=FALSE, results='asis'}

tableNOM = matrix(NA, nrow = 7, ncol = 8)
tableNOM[ , 1] = c("Overall Model", "Random", "Not Random", 
                   "Configural", "Metric", "Scalar", "Strict")

fitused = c("chisq", "df", "rmsea", "srmr", "cfi")

tableNOM[1, 2:8 ] = c(nrow(nomissnop), 
                      fitmeasures(overall.fit, fit.measures = fitused), 
                      "-")
tableNOM[2, 2:8] = c(nrow(random), 
                      fitmeasures(overall.fit.r, fit.measures = fitused), 
                      "-")

tableNOM[3, 2:8] = c(nrow(notrandom), 
                      fitmeasures(overall.fit.nr, fit.measures = fitused), 
                      "-")

tableNOM[4, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.configural, fit.measures = fitused), 
                      "-")

tableNOM[5, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.loadings, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.loadings)["cfi"] - fitmeasures(multisteps$fit.configural)["cfi"])

tableNOM[6, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.intercepts, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.intercepts)["cfi"] - fitmeasures(multisteps$fit.loadings)["cfi"])

tableNOM[7, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.residuals, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.residuals)["cfi"] - fitmeasures(multisteps3$fit.intercepts)["cfi"])

tableNOM[ , 3] = printnum(as.numeric(tableNOM[ , 3]), big.mark = "")
tableNOM[ , 5:8] = printnum(as.numeric(tableNOM[ , 5:8]), gt1 = F, digits = 3)


kable(tableNOM, 
      col.names = c("Model", "N", "Chi-Square", 
                       "df", "RMSEA", "SRMR", "CFI", "Change CFI"))

```

```{r OTH, include=FALSE}

##this one is the OHS abbreviation in the word doc. same scale. double checked. 

OHS = master[ , c(391:408,14,955,956)]
names(OHS)

####DATA SCREENING####

##Missing Data##
library(mice)
percentmiss = function(x){ sum(is.na(x))/length(x) *100 }

##Going by rows ONLY
notypos = OHS
missing = apply(notypos[ ,1:18], 1, percentmiss) 
table(missing)

##replace only the data that you should
replacepeople = notypos[ missing <= 5 , ]  
dontpeople = notypos[ missing > 5 , ]

##figure out the columns to exclude (survey data)
apply(replacepeople, 2, percentmiss)
names(replacepeople)
replacecolumn = replacepeople[ , -c(19:21)]
dontcolumn = replacepeople[ , c(19:21)]

nomiss = replacepeople

##Outliers##
mahal = mahalanobis(nomiss[ , -c(19:21)], 
                    colMeans(nomiss[ , -c(19:21)], na.rm = TRUE),
                    cov(nomiss[ , -c(19:21)], use="pairwise.complete.obs"))

cutoff = qchisq(.999,ncol(nomiss[ , -c(19:21)])) 
summary(mahal < cutoff)
noout = nomiss[ mahal < cutoff, ]

##additivity: correlations
correlations = cor(noout[,-c(19:21)], use="pairwise.complete.obs")
symnum(correlations)

##make the random stuff
random = rchisq(nrow(noout), 7)
##be sure here not to include the ID columns!
fake = lm(random~., data=noout[ , -c(19:21)])

##get the linearity plot
##create the standardized residuals
standardized = rstudent(fake)
qqnorm(standardized)
abline(0,1)

##multivariate normality
hist(standardized, breaks=15)

##homogeneity and homoscedaticity
fitvalues = scale(fake$fitted.values)
plot(fitvalues, standardized) 
abline(0,0)
abline(v = 0)

##CFA with internal + external + noout datasets / need to drop paper
nooutnop = subset(noout, source != 'paper') ##excludes paper
nomissnop = subset(nomiss, source != 'paper') ##excludes paper

notrandom = subset(nomissnop, source == 'not random') ##noout and filled in none same dataset
random = subset(nomissnop, source == 'random')

library(lavaan)
overallmodel = '
MN =~ OHS2 + OHS5 + OHS11 + OHS12 + OHS14 + OHS17 
EG =~ OHS3 + OHS8 + OHS13 + OHS15 + OHS16 + OHS18
PL =~ OHS1 + OHS4 + OHS6 + OHS7 + OHS9 + OHS10
'
##fit for overall (excluding paper)
overall.fit = cfa(model = overallmodel, 
                  data = nomissnop, 
                  meanstructure = TRUE)

summary(overall.fit, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE) ##no heywood cases

##fit for random 
overall.fit.r = cfa(overallmodel, 
                 data = random, 
                 meanstructure = TRUE)
summary(overall.fit.r, 
        standardized = TRUE, 
        rsquare = TRUE, 
        fit.measure = TRUE)

fitMeasures(overall.fit.r) 

##fit for not random 
overall.fit.nr = cfa(overallmodel, 
                    data = notrandom, 
                    meanstructure = TRUE)
summary(overall.fit.nr, 
        standardized = TRUE, 
        rsquare = TRUE, 
        fit.measure = TRUE)

##invariances 
library(semTools)
multisteps = measurementInvariance(overallmodel, 
                                   data = nomissnop, 
                                   group = 'source', 
                                   strict = T)

fitmeasures(multisteps)
fitMeasures(multisteps$fit.configural)
fitMeasures(multisteps$fit.loadings)
fitMeasures(multisteps$fit.intercepts)
fitMeasures(multisteps$fit.residuals)
fitMeasures(multisteps$fit.means)

##Broke down at Scalar Level

##partials f/residuals
partial = partialInvariance(multisteps, 
                            type = "intercepts")

interceptssfree = partial$results
multisteps2 = measurementInvariance(overallmodel, 
                                    data = nomissnop, 
                                    group = "source",
                                    strict = T,
                                    group.partial = c(OHS9~1))

##Allow for question 9 to vary 

```

```{r OTHtable, echo=FALSE, results='asis'}

tableOHS = matrix(NA, nrow = 7, ncol = 8)
tableOHS[ , 1] = c("Overall Model", "Random", "Not Random", 
                   "Configural", "Metric", "Scalar", "Strict")

fitused = c("chisq", "df", "rmsea", "srmr", "cfi")

tableOHS[1, 2:8 ] = c(nrow(nomissnop), 
                      fitmeasures(overall.fit, fit.measures = fitused), 
                      "-")
tableOHS[2, 2:8] = c(nrow(random), 
                      fitmeasures(overall.fit.r, fit.measures = fitused), 
                      "-")

tableOHS[3, 2:8] = c(nrow(notrandom), 
                      fitmeasures(overall.fit.nr, fit.measures = fitused), 
                      "-")

tableOHS[4, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps2$fit.configural, fit.measures = fitused), 
                      "-")

tableOHS[5, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps2$fit.loadings, fit.measures = fitused), 
                      fitmeasures(multisteps2$fit.loadings)["cfi"] - fitmeasures(multisteps2$fit.configural)["cfi"])

tableOHS[6, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps2$fit.intercepts, fit.measures = fitused), 
                      fitmeasures(multisteps2$fit.intercepts)["cfi"] - fitmeasures(multisteps2$fit.loadings)["cfi"])

tableOHS[7, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps2$fit.residuals, fit.measures = fitused), 
                      fitmeasures(multisteps2$fit.residuals)["cfi"] - fitmeasures(multisteps2$fit.intercepts)["cfi"])

tableOHS[ , 3] = printnum(as.numeric(tableOHS[ , 3]), big.mark = "")
tableOHS[ , 5:8] = printnum(as.numeric(tableOHS[ , 5:8]), gt1 = F, digits = 3)


kable(tableOHS, 
      col.names = c("Model", "N", "Chi-Square", 
                       "df", "RMSEA", "SRMR", "CFI", "Change CFI"))



```

```{r PVS, include=FALSE}

PVS = master[ , c(856:873,14,955,956)]
names(PVS)

##fix to 0-3, since qualtrics did 1-4
PVS[ , c(1:18)] = PVS[ , c(1:18)] - 1

##reverse coding 2, 4, 5, 7, 10, 12, 13, 15, 18
PVS[ , c(2,4,5,7,10,12,13,15,18)] = 3 - PVS[ , c(2,4,5,7,10,12,13,15,18)]
apply(PVS[ , c(3:20)],2,table)

####DATA SCREENING####

##Missing Data##
library(mice)
percentmiss = function(x){ sum(is.na(x))/length(x) *100 }

##Going by rows ONLY
notypos = PVS
names(notypos)
missing = apply(notypos[ , 1:18], 1, percentmiss) 
table(missing)

##Replace only the data that you should
replacepeople = notypos[ missing <= 5 , ]  
dontpeople = notypos[ missing > 5 , ]

##Figure out the columns to exclude
apply(replacepeople, 2, percentmiss)
names(replacepeople)
replacecolumn = replacepeople[ , -c(19:21)]
dontcolumn = replacepeople[ , c(19:21)]

##no missing data.
nomiss = replacepeople

##Outliers##
names(nomiss)
mahal = mahalanobis(nomiss[ , -c(19:21)], 
                    colMeans(nomiss[ , -c(19:21)], na.rm = TRUE),
                    cov(nomiss[ , -c(19:21)], use="pairwise.complete.obs"))
summary(mahal)
cutoff = qchisq(.999,ncol(nomiss[ , -c(19:21)])) 
summary(mahal < cutoff)
noout = nomiss[ mahal < cutoff, ]

##additivity: correlations

correlations = cor(noout[,-c(19:21)], use="pairwise.complete.obs")
symnum(correlations)

##make the random stuff
random = rchisq(nrow(noout), 7)
##be sure here not to include the ID columns!
fake = lm(random~., data=noout[ , -c(19:21)])

##get the linearity plot
##create the standardized residuals
standardized = rstudent(fake)
qqnorm(standardized)
abline(0,1)

##multivariate normality
hist(standardized, breaks=15)

##homogeneity and homoscedaticity
fitvalues = scale(fake$fitted.values)
plot(fitvalues, standardized) 
abline(0,0)
abline(v = 0)

##Scoring
PVSIII <- rowSums(noout[, c(1:18)])
summary(PVSIII)

####CFA####
##subsetting data
#Zero = notrandom, One = random, Two = paper
##subset the data
nooutnop = subset(noout, source != 'paper') ##excludes paper
nomissnop = subset(filledin_none, source != 'paper') ##excludes paper

notrandom = subset(nomissnop, source == 'not random') ##noout and filled in none same dataset
random = subset(nomissnop, source == 'random')

####overall model for everyone together##
colnames(nomissnop)
overallmodel = '
PVS =~
PVS1 + PVS2 + PVS3 + PVS4 + PVS5 + PVS6 + PVS7 + PVS8 +
PVS9 + PVS10 + PVS11 + PVS12 + PVS13 + PVS14 + PVS15 +
PVS16 + PVS17 + PVS18
'

overall.fit = cfa(model = overallmodel, 
                  data=nomissnop, 
                  meanstructure = TRUE)

summary(overall.fit, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE)

##random
overall.fit.r = cfa(overallmodel, 
                    data=random, 
                    meanstructure = TRUE)

summary(overall.fit.r, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE)

##notrandom
overall.fit.nr = cfa(overallmodel, 
                     data=notrandom, 
                     meanstructure = TRUE)

summary(overall.fit.nr, 
        standardized=TRUE,
        rsquare=TRUE, 
        fit.measure = TRUE)

####Multigroup Testing####
library(semTools)
options(scipen = 999)
multisteps = measurementInvariance(overallmodel, 
                                   data = nomissnop, 
                                   group = "source",
                                   strict = T)

fitmeasures(multisteps$fit.configural)
fitmeasures(multisteps$fit.loadings)
fitmeasures(multisteps$fit.intercepts)
fitmeasures(multisteps$fit.residuals)


```

```{r PVStable, echo=FALSE, results='asis'}

tablePVS = matrix(NA, nrow = 7, ncol = 8)
tablePVS[ , 1] = c("Overall Model", "Random", "Not Random", 
                   "Configural", "Metric", "Scalar", "Strict")

fitused = c("chisq", "df", "rmsea", "srmr", "cfi")

tablePVS[1, 2:8 ] = c(nrow(nomissnop), 
                      fitmeasures(overall.fit, fit.measures = fitused), 
                      "-")
tablePVS[2, 2:8] = c(nrow(random), 
                      fitmeasures(overall.fit.r, fit.measures = fitused), 
                      "-")

tablePVS[3, 2:8] = c(nrow(notrandom), 
                      fitmeasures(overall.fit.nr, fit.measures = fitused), 
                      "-")

tablePVS[4, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.configural, fit.measures = fitused), 
                      "-")

tablePVS[5, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.loadings, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.loadings)["cfi"] - fitmeasures(multisteps$fit.configural)["cfi"])

tablePVS[6, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.intercepts, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.intercepts)["cfi"] - fitmeasures(multisteps$fit.loadings)["cfi"])

tablePVS[7, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.residuals, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.residuals)["cfi"] - fitmeasures(multisteps$fit.intercepts)["cfi"])

tablePVS[ , 3] = printnum(as.numeric(tablePVS[ , 3]), big.mark = "")
tablePVS[ , 5:8] = printnum(as.numeric(tablePVS[ , 5:8]), gt1 = F, digits = 3)


kable(tablePVS, 
      col.names = c("Model", "N", "Chi-Square", 
                       "df", "RMSEA", "SRMR", "CFI", "Change CFI"))

```

```{r PIL, include=FALSE}

PIL = master[ , c(874:893,14,955,956)]
names(PIL)

##Missing Data##
library(mice)
percentmiss = function(x){ sum(is.na(x))/length(x) *100 }

##Going by rows ONLY
notypos = PIL
names(notypos)
missing = apply(notypos[ , 1:20], 1, percentmiss) 
table(missing)

##replace only the data that you should
replacepeople = notypos[ missing <= 5 , ]  
dontpeople = notypos[ missing > 5 , ]

##figure out the columns to exclude (survey data)
apply(replacepeople, 2, percentmiss)
names(replacepeople)
replacecolumn = replacepeople[ , -c(21:23)]
dontcolumn = replacepeople[ , c(21:23)]

##let's mice it!
tempnomiss = mice(replacecolumn)
nomiss = complete(tempnomiss, 1)
summary(nomiss)

##put everything back together
filledin_none = cbind(dontcolumn, nomiss)
summary(filledin_none)

##Outliers##
names(filledin_none)
mahal = mahalanobis(filledin_none[ , -c(1:3)], 
                    colMeans(filledin_none[ , -c(1:3)], na.rm = TRUE),
                    cov(filledin_none[ , -c(1:3)], use="pairwise.complete.obs"))

cutoff = qchisq(.999,ncol(filledin_none[ , -c(1:3)])) 
summary(mahal < cutoff)
noout = filledin_none[ mahal < cutoff, ]

##additivity: correlations
correlations = cor(noout[,-c(1:3)], use="pairwise.complete.obs")
symnum(correlations)

##make the random stuff
random = rchisq(nrow(noout), 7)
##be sure here not to include the ID columns!
fake = lm(random~., data=noout[ , -c(1:3)])

##get the linearity plot
##create the standardized residuals
standardized = rstudent(fake)
qqnorm(standardized)
abline(0,1)

##multivariate normality
hist(standardized, breaks=15)

##homogeneity and homoscedaticity
fitvalues = scale(fake$fitted.values)
plot(fitvalues, standardized) 
abline(0,0)
abline(v = 0)

##CFA with internal + external + noout datasets / need to drop paper
nooutnop = subset(noout, source != 'paper')
nomissnop = subset(filledin_none, source != 'paper')

notrandom = subset(nomissnop, source == 'not random')
random = subset(nomissnop, source == 'random')

library(lavaan)
overallmodel = 'Purpose =~
PIL1 + PIL2 + PIL3 + PIL4 + PIL5 + PIL6 + PIL7 + PIL8 + PIL9
+ PIL10 + PIL11 +PIL12 + PIL13 + PIL14 + PIL15 + PIL16 + PIL17 + PIL18 + PIL19 + PIL20
'

##fit for overall (excluding paper)
overall.fit = cfa(model = overallmodel, 
                  data = nomissnop, 
                  meanstructure = TRUE)

summary(overall.fit, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE) ##no heywood cases

##fit for random 
overall.fit.r = cfa(overallmodel, 
                 data = random, 
                 meanstructure = TRUE)
summary(overall.fit.r, 
        standardized = TRUE, 
        rsquare = TRUE, 
        fit.measure = TRUE)

fitMeasures(overall.fit.r) 

##fit for not random 
overall.fit.nr = cfa(overallmodel, 
                    data = notrandom, 
                    meanstructure = TRUE)
summary(overall.fit.nr, 
        standardized = TRUE, 
        rsquare = TRUE, 
        fit.measure = TRUE)

##invariances 
library(semTools)
multisteps = measurementInvariance(overallmodel, 
                                   data = nomissnop, 
                                   group = 'source', 
                                   strict = T)

fitmeasures(multisteps)
fitMeasures(multisteps$fit.configural)
fitMeasures(multisteps$fit.loadings)
fitMeasures(multisteps$fit.intercepts)
fitMeasures(multisteps$fit.residuals)
fitMeasures(multisteps$fit.means)

```

```{r PILtable, echo=FALSE, results='asis'}

tablePIL = matrix(NA, nrow = 7, ncol = 8)
tablePIL[ , 1] = c("Overall Model", "Random", "Not Random", 
                   "Configural", "Metric", "Scalar", "Strict")

fitused = c("chisq", "df", "rmsea", "srmr", "cfi")

tablePIL[1, 2:8 ] = c(nrow(nomissnop), 
                      fitmeasures(overall.fit, fit.measures = fitused), 
                      "-")
tablePIL[2, 2:8] = c(nrow(random), 
                      fitmeasures(overall.fit.r, fit.measures = fitused), 
                      "-")

tablePIL[3, 2:8] = c(nrow(notrandom), 
                      fitmeasures(overall.fit.nr, fit.measures = fitused), 
                      "-")

tablePIL[4, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.configural, fit.measures = fitused), 
                      "-")

tablePIL[5, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.loadings, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.loadings)["cfi"] - fitmeasures(multisteps$fit.configural)["cfi"])

tablePIL[6, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.intercepts, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.intercepts)["cfi"] - fitmeasures(multisteps$fit.loadings)["cfi"])

tablePIL[7, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.residuals, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.residuals)["cfi"] - fitmeasures(multisteps$fit.intercepts)["cfi"])

tablePIL[ , 3] = printnum(as.numeric(tablePIL[ , 3]), big.mark = "")
tablePIL[ , 5:8] = printnum(as.numeric(tablePIL[ , 5:8]), gt1 = F, digits = 3)


kable(tablePIL, 
      col.names = c("Model", "N", "Chi-Square", 
                       "df", "RMSEA", "SRMR", "CFI", "Change CFI"))

```

```{r PILshort, include=FALSE}

PILSF = master[ , c(155:159,14,955,956)]
names(PILSF)

####DATA SCREENING####
##Reverse Code. No reverse coding. Stopped here for scoring.

##Missing Data##
library(mice)
percentmiss = function(x){ sum(is.na(x))/length(x) *100 }

##Going by rows ONLY
notypos = PILSF
names(notypos)
missing = apply(notypos[ , 1:5], 1, percentmiss) 
table(missing)

##replace only the data that you should
replacepeople = notypos[ missing <= 5 , ]  
dontpeople = notypos[ missing > 5 , ]

##figure out the columns to exclude (survey data)
apply(replacepeople, 2, percentmiss)
replacecolumn = replacepeople[ , -c(5:7)]
dontcolumn = replacepeople[ , c(5:7)] 

nomiss = replacepeople
summary(nomiss)
summary(replacepeople) ##dont mice bec nothing less than 5

##Outliers##
names(nomiss)
mahal = mahalanobis(nomiss[ , -c(5:7)], 
                    colMeans(nomiss[ , -c(5:7)], na.rm = TRUE),
                    cov(nomiss[ , -c(5:7)], use="pairwise.complete.obs"))

cutoff = qchisq(.999,ncol(nomiss[ , -c(5:7)])) 
summary(mahal < cutoff)
noout = nomiss[ mahal < cutoff, ]

##additivity: correlations
correlations = cor(noout[,-c(5:7)], use="pairwise.complete.obs")
symnum(correlations)

##make the random stuff
random = rchisq(nrow(noout), 7)

##be sure here not to include the ID columns!
fake = lm(random~., data=noout[ , -c(5:7)])

##get the linearity plot
##create the standardized residuals
standardized = rstudent(fake)
qqnorm(standardized)
abline(0,1)

##multivariate normality
hist(standardized, breaks=15)

##homogeneity and homoscedaticity
fitvalues = scale(fake$fitted.values)
plot(fitvalues, standardized) 
abline(0,0)
abline(v = 0)

##Scoring
PIL <- rowSums(noout[, c(1:5)])
summary(PIL)

##exclude paper people using noout dataset 
nooutnop = subset(noout, source != 'paper') ##excludes paper
nomissnop = subset(nomiss, source != 'paper') ##excludes paper

notrandom = subset(nomissnop, source == 'not random') ##noout and filled in none same dataset
random = subset(nomissnop, source == 'random')

##overall model 
library(lavaan)
overallmodel = '
PIL =~ PILSF1 + PILSF2 + PILSF3 + PILSF4 + PILSF5
'
overall.fit = cfa(overallmodel, 
          data = nomissnop, 
          meanstructure = TRUE)
summary(overall.fit, 
        standardized = TRUE, 
        rsquare = TRUE, 
        fit.measure = TRUE)
fitMeasures(overall.fit)


##fit for random 
overall.fit.r = cfa(overallmodel, 
                 data = random, 
                 meanstructure = TRUE)
summary(overall.fit.r, 
        standardized = TRUE, 
        rsquare = TRUE, 
        fit.measure = TRUE)
fitMeasures(overall.fit.r)

##fit for not random 
overall.fit.nr = cfa(overallmodel, 
                    data = notrandom, 
                    meanstructure = TRUE)
summary(overall.fit.nr, 
        standardized = TRUE, 
        rsquare = TRUE, 
        fit.measure = TRUE) 
fitMeasures(overall.fit.nr)

##invariances 
library(semTools)
multisteps = measurementInvariance(overallmodel, 
                                   data = nomissnop, 
                                   group = 'source', 
                                   strict = T)
fitmeasures(multisteps)
fitMeasures(multisteps$fit.configural)
fitMeasures(multisteps$fit.loadings)
fitMeasures(multisteps$fit.intercepts)
fitMeasures(multisteps$fit.residuals)
fitMeasures(multisteps$fit.means)

```

```{r PILshorttable, echo=FALSE, results='asis'}

tablePILSF = matrix(NA, nrow = 7, ncol = 8)
tablePILSF[ , 1] = c("Overall Model", "Random", "Not Random", 
                   "Configural", "Metric", "Scalar", "Strict")

fitused = c("chisq", "df", "rmsea", "srmr", "cfi")

tablePILSF[1, 2:8 ] = c(nrow(nomissnop), 
                      fitmeasures(overall.fit, fit.measures = fitused), 
                      "-")
tablePILSF[2, 2:8] = c(nrow(random), 
                      fitmeasures(overall.fit.r, fit.measures = fitused), 
                      "-")

tablePILSF[3, 2:8] = c(nrow(notrandom), 
                      fitmeasures(overall.fit.nr, fit.measures = fitused), 
                      "-")

tablePILSF[4, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.configural, fit.measures = fitused), 
                      "-")

tablePILSF[5, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.loadings, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.loadings)["cfi"] - fitmeasures(multisteps$fit.configural)["cfi"])

tablePILSF[6, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.intercepts, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.intercepts)["cfi"] - fitmeasures(multisteps$fit.loadings)["cfi"])

tablePILSF[7, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.residuals, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.residuals)["cfi"] - fitmeasures(multisteps$fit.intercepts)["cfi"])

tablePILSF[ , 3] = printnum(as.numeric(tablePILSF[ , 3]), big.mark = "")
tablePILSF[ , 5:8] = printnum(as.numeric(tablePILSF[ , 5:8]), gt1 = F, digits = 3)


kable(tablePILSF, 
      col.names = c("Model", "N", "Chi-Square", 
                       "df", "RMSEA", "SRMR", "CFI", "Change CFI"))

```

```{r PPM&PMP, include=FALSE}

PPMS = master[ , c(570:577,14,955,956)]
names(PPMS)

####Data Screening####
##Missing Data##
library(mice)
percentmiss = function(x){ sum(is.na(x))/length(x) *100 }

##Going by rows ONLY
notypos = PPMS
names(notypos)
missing = apply(notypos[ , 1:8], 1, percentmiss) 
table(missing)

##replace only the data that you should
replacepeople = notypos[ missing <= 5 , ]  
dontpeople = notypos[ missing > 5 , ]

##figure out the columns to exclude (survey data)
apply(replacepeople, 2, percentmiss)
replacecolumn = replacepeople[ , -c(9:11)]
dontcolumn = replacepeople[ , c(9:11)]

nomiss = replacepeople

##Outliers##
names(nomiss)
mahal = mahalanobis(nomiss[ , -c(9:11)], 
                    colMeans(nomiss[ , -c(9:11)], na.rm = TRUE),
                    cov(nomiss[ , -c(9:11)], use="pairwise.complete.obs"))

cutoff = qchisq(.999,ncol(nomiss[ , -c(9:11)])) 
summary(mahal < cutoff)
noout = nomiss[ mahal < cutoff, ]

##additivity: correlations
correlations = cor(noout[,-c(9:11)], use="pairwise.complete.obs")
symnum(correlations)

##make the random stuff
random = rchisq(nrow(noout), 7)
##be sure here not to include the ID columns!
fake = lm(random~., data=noout[ , -c(9:11)])

##get the linearity plot
##create the standardized residuals
standardized = rstudent(fake)
qqnorm(standardized)
abline(0,1)

##multivariate normality
hist(standardized, breaks=15)

##homogeneity and homoscedaticity
fitvalues = scale(fake$fitted.values)
plot(fitvalues, standardized) 
abline(0,0)
abline(v = 0)

##Scoring 
PPMS <- rowSums(noout[, c(1:8)])
summary(PPMS)

####CFA####
##subsetting data
#Zero = notrandom, One = random, Two = paper
nooutnop = subset(noout, source != 'paper') ##excludes paper
nomissnop = subset(nomiss, source != 'paper') ##excludes paper

notrandom = subset(nomissnop, source == 'not random') ##noout and filled in none same dataset
random = subset(nomissnop, source == 'random')

overallmodel = '
PMS =~ PPMS1 + PPMS2 + PPMS3 + PPMS4 + PPMS5 + PPMS6 + PPMS7 + PPMS8'

##fit for overall (excluding paper)
overall.fit = cfa(model = overallmodel, 
                  data = nomissnop, 
                  meanstructure = TRUE)

summary(overall.fit, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE) ##no heywood cases

##fit for random 
overall.fit.r = cfa(overallmodel, 
                 data = random, 
                 meanstructure = TRUE)
summary(overall.fit.r, 
        standardized = TRUE, 
        rsquare = TRUE, 
        fit.measure = TRUE)

##fit for not random 
overall.fit.nr = cfa(overallmodel, 
                    data = notrandom, 
                    meanstructure = TRUE)
summary(overall.fit.nr, 
        standardized = TRUE, 
        rsquare = TRUE, 
        fit.measure = TRUE)


multisteps = measurementInvariance(overallmodel, 
                                   data = nomissnop, 
                                   group = 'source', 
                                   strict = T)

fitmeasures(multisteps$fit.configural)
fitmeasures(multisteps$fit.loadings)
fitmeasures(multisteps$fit.intercepts)
fitmeasures(multisteps$fit.residuals)





```

```{r PPM&PMPtable, echo=FALSE, results='asis'}

tablePPMS = matrix(NA, nrow = 7, ncol = 8)
tablePPMS[ , 1] = c("Overall Model", "Random", "Not Random", 
                   "Configural", "Metric", "Scalar", "Strict")

fitused = c("chisq", "df", "rmsea", "srmr", "cfi")

tablePPMS[1, 2:8 ] = c(nrow(nomissnop), 
                      fitmeasures(overall.fit, fit.measures = fitused), 
                      "-")
tablePPMS[2, 2:8] = c(nrow(random), 
                      fitmeasures(overall.fit.r, fit.measures = fitused), 
                      "-")

tablePPMS[3, 2:8] = c(nrow(notrandom), 
                      fitmeasures(overall.fit.nr, fit.measures = fitused), 
                      "-")

tablePPMS[4, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.configural, fit.measures = fitused), 
                      "-")

tablePPMS[5, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.loadings, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.loadings)["cfi"] - fitmeasures(multisteps$fit.configural)["cfi"])

tablePPMS[6, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.intercepts, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.intercepts)["cfi"] - fitmeasures(multisteps$fit.loadings)["cfi"])

tablePPMS[7, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.residuals, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.residuals)["cfi"] - fitmeasures(multisteps$fit.intercepts)["cfi"])

tablePPMS[ , 3] = printnum(as.numeric(tablePPMS[ , 3]), big.mark = "")
tablePPMS[ , 5:8] = printnum(as.numeric(tablePPMS[ , 5:8]), gt1 = F, digits = 3)


kable(tablePPMS, 
      col.names = c("Model", "N", "Chi-Square", 
                       "df", "RMSEA", "SRMR", "CFI", "Change CFI"))

```

```{r PVSH, include=FALSE}

##this one is already added above. must be a repeat. -Jeff

```

```{r PVSHtable, echo=FALSE, results='asis'}

##this one is already added above. must be a repeat. -Jeff


```

```{r QE, include=FALSE}

QE = master[ , c(699:719,14,955,956)]
names(QE)

##No reverse coded items.
library(car)
QE$QEWB3 = recode(QE$QEWB3, "1='5'; 2='4'; 3='3'; 4='2'; 5='1'")
QE$QEWB7 = recode(QE$QEWB7, "1='5'; 2='4'; 3='3'; 4='2'; 5='1'")
QE$QEWB11 = recode(QE$QEWB11, "1='5'; 2='4'; 3='3'; 4='2'; 5='1'")
QE$QEWB12 = recode(QE$QEWB12, "1='5'; 2='4'; 3='3'; 4='2'; 5='1'")
QE$QEWB16 = recode(QE$QEWB16, "1='5'; 2='4'; 3='3'; 4='2'; 5='1'")
QE$QEWB19 = recode(QE$QEWB19, "1='5'; 2='4'; 3='3'; 4='2'; 5='1'")
QE$QEWB20 = recode(QE$QEWB20, "1='5'; 2='4'; 3='3'; 4='2'; 5='1'")
####DATA SCREENING####

##Missing Data##
library(mice)
percentmiss = function(x){ sum(is.na(x))/length(x) *100 }

##Going by rows ONLY
notypos = QE
names(notypos)
missing = apply(notypos[ , 1:21], 1, percentmiss) 
table(missing)

##Replace only the data that you should
replacepeople = notypos[ missing <= 5 , ]  
dontpeople = notypos[ missing > 5 , ]

##Figure out the columns to exclude
apply(replacepeople, 2, percentmiss)
names(replacepeople)
replacecolumn = replacepeople[ , -c(22:24)]
dontcolumn = replacepeople[ , c(22:24)]

##MICE
tempnomiss = mice(replacecolumn)
nomiss = complete(tempnomiss, 1)

##(By your powers) Combine (I am Captain Planet!)
filledin_none = cbind(dontcolumn, nomiss)

##Small note: When MICE is run on this project the YEAR column
##is moved from the last column to the thrid column.
##This trend is not observed with data that does not need
##to be MICE'd. All code exluding ID columns has been corrected
##for this. 
#~Hannah 

##Outliers##
##Mahal
names(filledin_none)

mahal = mahalanobis(filledin_none[ , -c(1:3)], 
                    colMeans(filledin_none[ , -c(1:3)], na.rm = TRUE),
                    cov(filledin_none[ , -c(1:3)], use="pairwise.complete.obs"))

summary(mahal)
cutoff = qchisq(.999,ncol(filledin_none[ , -c(1:3)])) 
summary(mahal < cutoff)
noout = nomiss[ mahal < cutoff, ]

##Additivity: correlations
correlations = cor(filledin_none[,-c(1:3)], use="pairwise.complete.obs")
symnum(correlations)

##Make the random stuff & exclude the ID columns 
random = rchisq(nrow(filledin_none), 7)
fake = lm(random~., data=filledin_none[ , -c(1:3)])

##get the linearity plot
##create the standardized residuals
standardized = rstudent(fake)
qqnorm(standardized)
abline(0,1)

##multivariate normality
hist(standardized, breaks=30)

##homogeneity and homoscedasticity
fitvalues = scale(fake$fitted.values)
plot(fitvalues, standardized) 
abline(0,0)
abline(v = 0)

##Scoring
QWEB <- rowSums(noout[, c(1:21)])
QWEB

##exclude paper people using noout dataset 
nooutnop = subset(noout, source != 'paper') ##excludes paper
nomissnop = subset(filledin_none, source != 'paper') ##excludes paper

notrandom = subset(nomissnop, source == 'not random') ##noout and filled in none same dataset
random = subset(nomissnop, source == 'random')

##overall model 
overallmodel = '
QEWB =~ QEWB1 + QEWB2 + QEWB3 + QEWB4 + QEWB5 + QEWB6 + QEWB7 + QEWB8 + QEWB9 + QEWB10 + QEWB11 + QEWB12 + QEWB13 + QEWB14 + QEWB15 + QEWB16 + QEWB17 + QEWB18 + QEWB19 + QEWB20 + QEWB21
'

overall.fit = cfa(overallmodel, 
          data = nomissnop, 
          meanstructure = TRUE)

summary(overall.fit, 
        standardized = TRUE, 
        rsquare = TRUE, 
        fit.measure = TRUE)
fitMeasures(overall.fit)


##fit for random 
overall.fit.r = cfa(overallmodel, 
                 data = random, 
                 meanstructure = TRUE)
summary(overall.fit.r, 
        standardized = TRUE, 
        rsquare = TRUE, 
        fit.measure = TRUE)
fitMeasures(overall.fit.r)

##fit for not random 
overall.fit.nr = cfa(overallmodel, 
                    data = notrandom, 
                    meanstructure = TRUE)
summary(overall.fit.nr, 
        standardized = TRUE, 
        rsquare = TRUE, 
        fit.measure = TRUE) 
fitMeasures(overall.fit.nr)

##invariances 
library(semTools)
multisteps = measurementInvariance(overallmodel, 
                                   data = nomissnop, 
                                   group = 'source', 
                                   strict = T)
fitmeasures(multisteps)
fitMeasures(multisteps$fit.configural)
fitMeasures(multisteps$fit.loadings)
fitMeasures(multisteps$fit.intercepts)
fitMeasures(multisteps$fit.residuals)
fitMeasures(multisteps$fit.means)

#partial invariances 
partial = partialInvariance(multisteps, 
                            type = "metric")
strictfree = partial$results


##after letting it go 
partialstrict = measurementInvariance(overallmodel, 
                                      data = nomissnop, 
                                      group = 'source', 
                                      strict = T, 
                                      group.partial = c("QEWB=~QEWB16"))

fitMeasures(partialstrict$fit.loadings)
fitMeasures(partialstrict$fit.intercepts)

##partials2 breaks on intercepts
partial2 = partialInvariance(partialstrict, type = "scalar")
strictfree2 = partial2$results

partialstrict2 = measurementInvariance(overallmodel, 
                                       data = nomissnop, 
                                       group = 'source', 
                                       strict = T, 
                                       group.partial = c("QEWB=~QEWB16","QEWB6~1" ))
fitMeasures(partialstrict2$fit.intercepts)
fitMeasures(partialstrict2$fit.residuals)

##partials3 
partial3 = partialInvariance(partialstrict2, type = "strict")
strictfree3 = partial3$results

partialstrict3 = measurementInvariance(overallmodel, 
                                       data = nomissnop, 
                                       group = 'Source', 
                                       strict = T, 
                                       group.partial = c("QEWB=~QEWB16","QEWB6~1", "QEWB19~~QEWB19" ))
fitMeasures(partialstrict3$fit.residuals)

```

```{r QEtable, echo=FALSE, results='asis'}

##partialstrict3

tableQE = matrix(NA, nrow = 7, ncol = 8)
tableQE[ , 1] = c("Overall Model", "Random", "Not Random", 
                   "Configural", "Metric", "Scalar", "Strict")

fitused = c("chisq", "df", "rmsea", "srmr", "cfi")

tableQE[1, 2:8 ] = c(nrow(nomissnop), 
                      fitmeasures(overall.fit, fit.measures = fitused), 
                      "-")
tableQE[2, 2:8] = c(nrow(random), 
                      fitmeasures(overall.fit.r, fit.measures = fitused), 
                      "-")

tableQE[3, 2:8] = c(nrow(notrandom), 
                      fitmeasures(overall.fit.nr, fit.measures = fitused), 
                      "-")

tableQE[4, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(partialstrict3$fit.configural, fit.measures = fitused), 
                      "-")

tableQE[5, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(partialstrict3$fit.loadings, fit.measures = fitused), 
                      fitmeasures(partialstrict3$fit.loadings)["cfi"] - fitmeasures(partialstrict3$fit.configural)["cfi"])

tableQE[6, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(partialstrict3$fit.intercepts, fit.measures = fitused), 
                      fitmeasures(partialstrict3$fit.intercepts)["cfi"] - fitmeasures(partialstrict3$fit.loadings)["cfi"])

tableQE[7, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(partialstrict3$fit.residuals, fit.measures = fitused), 
                      fitmeasures(partialstrict3$fit.residuals)["cfi"] - fitmeasures(partialstrict3$fit.intercepts)["cfi"])

tableQE[ , 3] = printnum(as.numeric(tableQE[ , 3]), big.mark = "")
tableQE[ , 5:8] = printnum(as.numeric(tableQE[ , 5:8]), gt1 = F, digits = 3)


kable(tableQE, 
      col.names = c("Model", "N", "Chi-Square", 
                       "df", "RMSEA", "SRMR", "CFI", "Change CFI"))



```

```{r RS14, include=FALSE}

RS14 = master[ , c(836:849,14,955,956)]
names(RS14)

##No reverse coded items.

####DATA SCREENING####

##Missing Data##
library(mice)
percentmiss = function(x){ sum(is.na(x))/length(x) *100 }

##Going by rows ONLY
notypos = RS14
missing = apply(notypos[ , 1:14], 1, percentmiss) 
table(missing)

##Replace only the data that you should
replacepeople = notypos[ missing <= 5 , ]  
dontpeople = notypos[ missing > 5 , ]

##Figure out the columns to exclude
apply(replacepeople, 2, percentmiss)
names(replacepeople)
replacecolumn = replacepeople[ , -c(15:17)]
dontcolumn = replacepeople[ , c(15:17)]

##no missing data.
nomiss = replacepeople

##Outliers##
names(nomiss)
mahal = mahalanobis(nomiss[ , -c(15:17)], 
                    colMeans(nomiss[ , -c(15:17)], na.rm = TRUE),
                    cov(nomiss[ , -c(15:17)], use="pairwise.complete.obs"))
cutoff = qchisq(.999,ncol(nomiss[ , -c(15:17)])) 
summary(mahal < cutoff)
noout = nomiss[ mahal < cutoff, ]

##additivity: correlations
correlations = cor(noout[,-c(15:17)], use="pairwise.complete.obs")
symnum(correlations)

##make the random stuff
random = rchisq(nrow(noout), 7)
##be sure here not to include the ID columns!
fake = lm(random~., data=noout[ , -c(15:17)])

##get the linearity plot
##create the standardized residuals
standardized = rstudent(fake)
qqnorm(standardized)
abline(0,1)

##multivariate normality
hist(standardized, breaks=15)

##homogeneity and homoscedaticity
fitvalues = scale(fake$fitted.values)
plot(fitvalues, standardized) 
abline(0,0)
abline(v = 0)

##Scoring
R14 = rowSums(noout[, c(1:14)])
summary(R14)

####CFA####
##subsetting data
nooutnop = subset(noout, source != 'paper') ##excludes paper
nomissnop = subset(nomiss, source != 'paper') ##excludes paper

notrandom = subset(nomissnop, source == 'not random') ##noout and filled in none same dataset
random = subset(nomissnop, source == 'random')

####overall model for everyone together##
overallmodel = '
ResScale =~
RS1 + RS2 + RS3 + RS4 + RS5 + 
RS6 + RS7 + RS8 + RS9 + RS10 +
RS11 + RS12 + RS13 + RS14
'

overall.fit = cfa(model = overallmodel, 
                  data=nomissnop, 
                  meanstructure = TRUE)

summary(overall.fit, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE)

##random
overall.fit.r = cfa(overallmodel, 
                    data=random, 
                    meanstructure = TRUE)

summary(overall.fit.r, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE)

##notrandom
overall.fit.nr = cfa(overallmodel, 
                     data=notrandom, 
                     meanstructure = TRUE)

summary(overall.fit.nr, 
        standardized=TRUE,
        rsquare=TRUE, 
        fit.measure = TRUE)


####multi group testing####
###measurement invariance
options(scipen = 999)

multisteps = measurementInvariance(overallmodel, 
                                   data = nomissnop, 
                                   group = "Source",
                                   strict = T)

fitmeasures(multisteps$fit.configural)
fitmeasures(multisteps$fit.loadings)
fitmeasures(multisteps$fit.intercepts)
fitmeasures(multisteps$fit.residuals)




```

```{r RS14table, echo=FALSE, results='asis'}

tableRS14 = matrix(NA, nrow = 7, ncol = 8)
tableRS14[ , 1] = c("Overall Model", "Random", "Not Random", 
                   "Configural", "Metric", "Scalar", "Strict")

fitused = c("chisq", "df", "rmsea", "srmr", "cfi")

tableRS14[1, 2:8 ] = c(nrow(nomissnop), 
                      fitmeasures(overall.fit, fit.measures = fitused), 
                      "-")
tableRS14[2, 2:8] = c(nrow(random), 
                      fitmeasures(overall.fit.r, fit.measures = fitused), 
                      "-")

tableRS14[3, 2:8] = c(nrow(notrandom), 
                      fitmeasures(overall.fit.nr, fit.measures = fitused), 
                      "-")

tableRS14[4, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.configural, fit.measures = fitused), 
                      "-")

tableRS14[5, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.loadings, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.loadings)["cfi"] - fitmeasures(multisteps$fit.configural)["cfi"])

tableRS14[6, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.intercepts, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.intercepts)["cfi"] - fitmeasures(multisteps$fit.loadings)["cfi"])

tableRS14[7, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.residuals, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.residuals)["cfi"] - fitmeasures(multisteps$fit.intercepts)["cfi"])

tableRS14[ , 3] = printnum(as.numeric(tableRS14[ , 3]), big.mark = "")
tableRS14[ , 5:8] = printnum(as.numeric(tableRS14[ , 5:8]), gt1 = F, digits = 3)


kable(tableRS14, 
      col.names = c("Model", "N", "Chi-Square", 
                       "df", "RMSEA", "SRMR", "CFI", "Change CFI"))

```

```{r SWL, include=FALSE}

SWL = master[ , c(322:326,14,955,956)]
names(SWL)

##Missing Data##
library(mice)
percentmiss = function(x){ sum(is.na(x))/length(x) *100 }

##Going by rows ONLY
notypos = SWL
missing = apply(notypos[ , 1:5], 1, percentmiss) 
table(missing)

##Replace only the data that you should
replacepeople = notypos[ missing <= 5 , ]  
dontpeople = notypos[ missing > 5 , ]

##Figure out the columns to exclude
apply(replacepeople, 2, percentmiss)
replacecolumn = replacepeople[ , -c(6:8)]
dontcolumn = replacepeople[ , c(6:8)]

nomiss = replacepeople

##Small note: When MICE is run on this project the YEAR column
##is moved from the last column to the thrid column.
##This trend is not observed with data that does not need
##to be MICE'd. All code exluding ID columns has been corrected
##for this. 
#~Hannah 

##Outliers##
##Mahal
names(nomiss)
mahal = mahalanobis(nomiss[ , -c(6:8)], 
                    colMeans(nomiss[ , -c(6:8)], na.rm = TRUE),
                    cov(nomiss[ , -c(6:8)], use="pairwise.complete.obs"))

summary(mahal)
cutoff = qchisq(.999,ncol(nomiss[ , -c(6:8)])) 
summary(mahal < cutoff)
noout = nomiss[ mahal < cutoff, ]

##Additivity: correlations
correlations = cor(noout[,-c(6:8)], use="pairwise.complete.obs")
symnum(correlations)

##Make the random stuff & exclude the ID columns 
random = rchisq(nrow(noout), 7)
fake = lm(random~., data=noout[ , -c(6:8)])

##Linearity plot
##Create the standardized residuals
standardized = rstudent(fake)
qqnorm(standardized)
abline(0,1)

##Multivariate normality
hist(standardized, breaks=15)

##Homogeneity and homoscedaticity
fitvalues = scale(fake$fitted.values)
plot(fitvalues, standardized) 
abline(0,0)
abline(v = 0)

##Scoring
SWLS <- rowSums(noout[, c(1:5)])
SWLS

##exclude paper people using noout dataset 
nooutnop = subset(noout, source != 'paper')
nomissnop = subset(nomiss, source != 'paper')

notrandom = subset(nomissnop, source == 'not random')
random = subset(nomissnop, source == 'random')

##overallmodel 

overallmodel = '
SWLS =~ SWLS1 + SWLS2 + SWLS3 + SWLS4 + SWLS5
'
overall.fit = cfa(overallmodel, 
          data = nomissnop, 
          meanstructure = TRUE)

summary(overall.fit, 
        standardized = TRUE, 
        rsquare = TRUE, 
        fit.measure = TRUE)
fitMeasures(overall.fit)


##fit for random 
overall.fit.r = cfa(overallmodel, 
                 data = random, 
                 meanstructure = TRUE)
summary(overall.fit.r, 
        standardized = TRUE, 
        rsquare = TRUE, 
        fit.measure = TRUE)
fitMeasures(overall.fit.r)

##fit for not random 
overall.fit.nr = cfa(overallmodel, 
                    data = notrandom, 
                    meanstructure = TRUE)
summary(overall.fit.nr, 
        standardized = TRUE, 
        rsquare = TRUE, 
        fit.measure = TRUE) 
fitMeasures(overall.fit.nr)

##invariances 
multisteps = measurementInvariance(overallmodel, 
                                   data = nomissnop, 
                                   group = 'source', 
                                   strict = T)
fitmeasures(multisteps)
fitMeasures(multisteps$fit.configural)
fitMeasures(multisteps$fit.loadings)
fitMeasures(multisteps$fit.intercepts)
fitMeasures(multisteps$fit.residuals)
fitMeasures(multisteps$fit.means)

```

```{r SWLtable, echo=FALSE, results='asis'}

tableSWLS = matrix(NA, nrow = 7, ncol = 8)
tableSWLS[ , 1] = c("Overall Model", "Random", "Not Random", 
                   "Configural", "Metric", "Scalar", "Strict")

fitused = c("chisq", "df", "rmsea", "srmr", "cfi")

tableSWLS[1, 2:8 ] = c(nrow(nomissnop), 
                      fitmeasures(overall.fit, fit.measures = fitused), 
                      "-")
tableSWLS[2, 2:8] = c(nrow(random), 
                      fitmeasures(overall.fit.r, fit.measures = fitused), 
                      "-")

tableSWLS[3, 2:8] = c(nrow(notrandom), 
                      fitmeasures(overall.fit.nr, fit.measures = fitused), 
                      "-")

tableSWLS[4, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.configural, fit.measures = fitused), 
                      "-")

tableSWLS[5, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.loadings, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.loadings)["cfi"] - fitmeasures(multisteps$fit.configural)["cfi"])

tableSWLS[6, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.intercepts, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.intercepts)["cfi"] - fitmeasures(multisteps$fit.loadings)["cfi"])

tableSWLS[7, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.residuals, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.residuals)["cfi"] - fitmeasures(multisteps$fit.intercepts)["cfi"])

tableSWLS[ , 3] = printnum(as.numeric(tableSWLS[ , 3]), big.mark = "")
tableSWLS[ , 5:8] = printnum(as.numeric(tableSWLS[ , 5:8]), gt1 = F, digits = 3)


kable(tableSWLS, 
      col.names = c("Model", "N", "Chi-Square", 
                       "df", "RMSEA", "SRMR", "CFI", "Change CFI"))

```

```{r SONG, include=FALSE}

SONG = master[ , c(720:739,14,955,956)]
names(SONG)

##Reverse Code. 9
library(car)
SONG$SONG3 = recode(SONG$SONG3, "1='7'; 2='6'; 3='5'; 4='4'; 5='3'; 6='2'; 7='1'")
SONG$SONG4 = recode(SONG$SONG4, "1='7'; 2='6'; 3='5'; 4='4'; 5='3'; 6='2'; 7='1'")
SONG$SONG5 = recode(SONG$SONG5, "1='7'; 2='6'; 3='5'; 4='4'; 5='3'; 6='2'; 7='1'")
SONG$SONG6 = recode(SONG$SONG6, "1='7'; 2='6'; 3='5'; 4='4'; 5='3'; 6='2'; 7='1'")
SONG$SONG9 = recode(SONG$SONG9, "1='7'; 2='6'; 3='5'; 4='4'; 5='3'; 6='2'; 7='1'")
SONG$SONG12 = recode(SONG$SONG12, "1='7'; 2='6'; 3='5'; 4='4'; 5='3'; 6='2'; 7='1'")
SONG$SONG13 = recode(SONG$SONG13, "1='7'; 2='6'; 3='5'; 4='4'; 5='3'; 6='2'; 7='1'")
SONG$SONG15 = recode(SONG$SONG15, "1='7'; 2='6'; 3='5'; 4='4'; 5='3'; 6='2'; 7='1'")
SONG$SONG18 = recode(SONG$SONG18, "1='7'; 2='6'; 3='5'; 4='4'; 5='3'; 6='2'; 7='1'")
SONG$SONG20 = recode(SONG$SONG20, "1='7'; 2='6'; 3='5'; 4='4'; 5='3'; 6='2'; 7='1'")

##Missing Data##
library(mice)
percentmiss = function(x){ sum(is.na(x))/length(x) *100 }

##Going by rows ONLY
notypos = SONG
names(notypos)
missing = apply(notypos[ , 1:20], 1, percentmiss) 
table(missing)

##Replace only the data that you should
replacepeople = notypos[ missing <= 5 , ]  
dontpeople = notypos[ missing > 5 , ]

##Figure out the columns to exclude
apply(replacepeople, 2, percentmiss)
replacecolumn = replacepeople[ , -c(21:23)]
dontcolumn = replacepeople[ , c(21:23)]

##MICE
tempnomiss = mice(replacecolumn)
nomiss = complete(tempnomiss, 1)
summary(nomiss)

##(By your powers) Combine (I am Captain Planet!)
filledin_none = cbind(dontcolumn, nomiss)
summary(filledin_none)

##Small note: When MICE is run on this project the YEAR column
##is moved from the last column to the thrid column.
##This trend is not observed with data that does not need
##to be MICE'd. All code exluding ID columns has been corrected
##for this. 
#~Hannah 

##Outliers##
##Mahal
names(filledin_none)
mahal = mahalanobis(filledin_none[ , -c(1:3)], 
                    colMeans(filledin_none[ , -c(1:3)], na.rm = TRUE),
                    cov(filledin_none[ , -c(1:3)], use="pairwise.complete.obs"))

summary(mahal)
cutoff = qchisq(.999,ncol(filledin_none[ , -c(1:3)])) 
summary(mahal < cutoff)
noout = filledin_none[ mahal < cutoff, ]

##Additivity: correlations
correlations = cor(noout[,-c(1:3)], use="pairwise.complete.obs")
symnum(correlations)

##Make the random stuff & exclude the ID columns 
random = rchisq(nrow(noout), 7)
fake = lm(random~., data=noout[ , -c(1:3)])

##Linearity plot
##Create the standardized residuals
standardized = rstudent(fake)
qqnorm(standardized)
abline(0,1)

##Multivariate normality
hist(standardized, breaks=15)

##Homogeneity and homoscedaticity
fitvalues = scale(fake$fitted.values)
plot(fitvalues, standardized) 
abline(0,0)
abline(v = 0)

##Scoring
##Existential vacu
vac = colSums(noout[,c("SONG3", "SONG4", "SONG8", "SONG9", "SONG11", "SONG12", "SONG13", "SONG14","SONG17", "SONG19")])
vac

vactot = sum(vac)
vactot

#Life perspective 
WM = rowSums(noout[,c("SONG1", "SONG6", "SONG7", "SONG10", "SONG15", "SONG18", "SONG20")])
WM

##exclude paper people using noout dataset 
nooutnop = subset(noout, source != 'paper') ##excludes paper
nomissnop = subset(filledin_none, source != 'paper') ##excludes paper

notrandom = subset(nomissnop, source == 'not random') ##noout and filled in none same dataset
random = subset(nomissnop, source == 'random')


##overallmodel 
library(lavaan)
names(filledin_none)
overallmodel = '
VA =~ SONG3 + SONG4 + SONG8 + SONG9 + SONG11 + SONG12 + SONG13 + SONG14 + SONG17 + SONG19
WM =~ SONG1 + SONG6 + SONG7 + SONG10 + SONG15 + SONG18 + SONG20
'
overall.fit = cfa(overallmodel, 
          data = nomissnop, 
          meanstructure = TRUE)

summary(overall.fit, 
        standardized = TRUE, 
        rsquare = TRUE, 
        fit.measure = TRUE)
fitMeasures(overall.fit)

##fit for random 
overall.fit.r = cfa(overallmodel, 
                 data = random, 
                 meanstructure = TRUE)
summary(overall.fit.r, 
        standardized = TRUE, 
        rsquare = TRUE, 
        fit.measure = TRUE)
fitMeasures(overall.fit.r)

##fit for not random 
overall.fit.nr = cfa(overallmodel, 
                    data = notrandom, 
                    meanstructure = TRUE)
summary(overall.fit.nr, 
        standardized = TRUE, 
        rsquare = TRUE, 
        fit.measure = TRUE) 
fitMeasures(overall.fit.nr)

##invariances 
library(semTools)
multisteps = measurementInvariance(overallmodel, 
                                   data = nomissnop, 
                                   group = 'source', 
                                   strict = T)
fitmeasures(multisteps)
fitMeasures(multisteps$fit.configural)
fitMeasures(multisteps$fit.loadings)
fitMeasures(multisteps$fit.intercepts)
fitMeasures(multisteps$fit.residuals)
fitMeasures(multisteps$fit.means)



```

```{r SONGtable, echo=FALSE, results='asis'}

tableSONG = matrix(NA, nrow = 7, ncol = 8)
tableSONG[ , 1] = c("Overall Model", "Random", "Not Random", 
                   "Configural", "Metric", "Scalar", "Strict")

fitused = c("chisq", "df", "rmsea", "srmr", "cfi")

tableSONG[1, 2:8 ] = c(nrow(nomissnop), 
                      fitmeasures(overall.fit, fit.measures = fitused), 
                      "-")
tableSONG[2, 2:8] = c(nrow(random), 
                      fitmeasures(overall.fit.r, fit.measures = fitused), 
                      "-")

tableSONG[3, 2:8] = c(nrow(notrandom), 
                      fitmeasures(overall.fit.nr, fit.measures = fitused), 
                      "-")

tableSONG[4, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.configural, fit.measures = fitused), 
                      "-")

tableSONG[5, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.loadings, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.loadings)["cfi"] - fitmeasures(multisteps$fit.configural)["cfi"])

tableSONG[6, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.intercepts, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.intercepts)["cfi"] - fitmeasures(multisteps$fit.loadings)["cfi"])

tableSONG[7, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.residuals, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.residuals)["cfi"] - fitmeasures(multisteps$fit.intercepts)["cfi"])

tableSONG[ , 3] = printnum(as.numeric(tableSONG[ , 3]), big.mark = "")
tableSONG[ , 5:8] = printnum(as.numeric(tableSONG[ , 5:8]), gt1 = F, digits = 3)


kable(tableSONG, 
      col.names = c("Model", "N", "Chi-Square", 
                       "df", "RMSEA", "SRMR", "CFI", "Change CFI"))

```

```{r SOC, include=FALSE}

SOC = master[ , c(327:356,14,955,956)]
names(SOC)

##No reverse coded items.
library(car)
SOC$SCS7 = recode(SOC$SCS7, "1='7'; 2='6'; 3='5'; 4='4'; 5='3'; 6='2'; 7='1'")
SOC$SCS9 = recode(SOC$SCS9, "1='7'; 2='6'; 3='5'; 4='4'; 5='3'; 6='2'; 7='1'")
SOC$SCS11 = recode(SOC$SCS11, "1='7'; 2='6'; 3='5'; 4='4'; 5='3'; 6='2'; 7='1'")
SOC$SCS12 = recode(SOC$SCS12, "1='7'; 2='6'; 3='5'; 4='4'; 5='3'; 6='2'; 7='1'")
SOC$SCS13 = recode(SOC$SCS13, "1='7'; 2='6'; 3='5'; 4='4'; 5='3'; 6='2'; 7='1'")
SOC$SCS14 = recode(SOC$SCS14, "1='7'; 2='6'; 3='5'; 4='4'; 5='3'; 6='2'; 7='1'")
SOC$SCS16 = recode(SOC$SCS16, "1='7'; 2='6'; 3='5'; 4='4'; 5='3'; 6='2'; 7='1'")
SOC$SCS19 = recode(SOC$SCS19, "1='7'; 2='6'; 3='5'; 4='4'; 5='3'; 6='2'; 7='1'")
SOC$SCS20 = recode(SOC$SCS20, "1='7'; 2='6'; 3='5'; 4='4'; 5='3'; 6='2'; 7='1'")
SOC$SCS21 = recode(SOC$SCS21, "1='7'; 2='6'; 3='5'; 4='4'; 5='3'; 6='2'; 7='1'")
SOC$SCS23 = recode(SOC$SCS23, "1='7'; 2='6'; 3='5'; 4='4'; 5='3'; 6='2'; 7='1'")
SOC$SCS24 = recode(SOC$SCS24, "1='7'; 2='6'; 3='5'; 4='4'; 5='3'; 6='2'; 7='1'")
SOC$SCS27 = recode(SOC$SCS27, "1='7'; 2='6'; 3='5'; 4='4'; 5='3'; 6='2'; 7='1'")
SOC$SCS28 = recode(SOC$SCS28, "1='7'; 2='6'; 3='5'; 4='4'; 5='3'; 6='2'; 7='1'")
SOC$SCS29 = recode(SOC$SCS29, "1='7'; 2='6'; 3='5'; 4='4'; 5='3'; 6='2'; 7='1'")
####DATA SCREENING####

##Missing Data##
library(mice)
percentmiss = function(x){ sum(is.na(x))/length(x) *100 }

##Going by rows ONLY
notypos = SOC
names(notypos)
missing = apply(notypos[ , 1:30], 1, percentmiss) 
table(missing)

##Replace only the data that you should
replacepeople = notypos[ missing <= 5 , ]  
dontpeople = notypos[ missing > 5 , ]

##Figure out the columns to exclude
apply(replacepeople, 2, percentmiss)
names(replacepeople)
replacecolumn = replacepeople[ , -c(31:33)]
dontcolumn = replacepeople[ , c(31:33)]

##MICE
tempnomiss = mice(replacecolumn)
nomiss = complete(tempnomiss, 1)
summary(nomiss)

##(By your powers) Combine (I am Captain Planet!)
filledin_none = cbind(dontcolumn, nomiss)
summary(filledin_none)

##Small note: When MICE is run on this project the YEAR column
##is moved from the last column to the thrid column.
##This trend is not observed with data that does not need
##to be MICE'd. All code exluding ID columns has been corrected
##for this. 
#~Hannah 

##Outliers##
##Mahal
names(filledin_none)
mahal = mahalanobis(nomiss[ , -c(1:3)], 
                    colMeans(nomiss[ , -c(1:3)], na.rm = TRUE),
                    cov(nomiss[ , -c(1:3)], use="pairwise.complete.obs"))

summary(mahal)
cutoff = qchisq(.999,ncol(nomiss[ , -c(1:3)])) 
summary(mahal < cutoff)
noout = nomiss[ mahal < cutoff, ]

##Additivity: correlations
correlations = cor(noout[,-c(1:3)], use="pairwise.complete.obs")
symnum(correlations)

##Make the random stuff & exclude the ID columns 
random = rchisq(nrow(noout), 7)
fake = lm(random~., data=noout[ , -c(1:3)])

##get the linearity plot
##create the standardized residuals
standardized = rstudent(fake)
qqnorm(standardized)
abline(0,1)

##multivariate normality
hist(standardized, breaks=30)

##homogeneity and homoscedasticity
fitvalues = scale(fake$fitted.values)
plot(fitvalues, standardized) 
abline(0,0)
abline(v = 0)

##scoring (only one factor from the PDF)
SCS = rowSums(filledin_none[ , c(3:31)])

##subsetting data
#Zero = notrandom, One = random, Two = paper
nooutnop = subset(noout, source != 'paper') ##excludes paper
nomissnop = subset(filledin_none, source != 'paper') ##excludes paper

notrandom = subset(nomissnop, source == 'not random') ##noout and filled in none same dataset
random = subset(nomissnop, source == 'random')


##problem here - 30 items show up in data, but scale is 29 item. leaving for now -Jeff 

library(lavaan)
##data sets
overallmodel = '
Comprehensibility =~
Managability =~
Meaningfulness =~
'



```

```{r SOCtable, echo=FALSE, results='asis'}

##see comment above. 30 items on the all data combined but it should only be a 29-item scale. 


```

```{r SOM, include=FALSE}

##this one needs to be resolved with the factor structure. I didn't screen it but am not sure what the structure is. - Jeff

SOM = master[ , c(686:698,14,955,956)]
names(SOM)

####DATA SCREENING####

##Missing Data##
library(mice)
percentmiss = function(x){ sum(is.na(x))/length(x) *100 }

##Going by rows ONLY
notypos = SOM
names(notypos)
missing = apply(notypos[ , 1:13], 1, percentmiss) 
table(missing)

##Replace only the data that you should
replacepeople = notypos[ missing <= 5 , ]  
dontpeople = notypos[ missing > 5 , ]

##Figure out the columns to exclude
apply(replacepeople, 2, percentmiss)
replacecolumn = replacepeople[ , -c(14:16)]
dontcolumn = replacepeople[ , c(14:16)]

##no missing data.
nomiss = replacepeople

##Outliers##
names(nomiss)
mahal = mahalanobis(nomiss[ , -c(14:16)], 
                    colMeans(nomiss[ , -c(14:16)], na.rm = TRUE),
                    cov(nomiss[ , -c(14:16)], use="pairwise.complete.obs"))
mahal
summary(mahal)
cutoff = qchisq(.999,ncol(nomiss[ , -c(14:16)])) 
summary(mahal < cutoff)
noout = nomiss[ mahal < cutoff, ]

##additivity: correlations
correlations = cor(noout[,-c(14:16)], use="pairwise.complete.obs")
symnum(correlations)

##make the random stuff
random = rchisq(nrow(noout), 7)
##be sure here not to include the ID columns!
fake = lm(random~., data=noout[ , -c(14:16)])

##get the linearity plot
##create the standardized residuals
standardized = rstudent(fake)
qqnorm(standardized)
abline(0,1)

##multivariate normality
hist(standardized, breaks=15)

##homogeneity and homoscedaticity
fitvalues = scale(fake$fitted.values)
plot(fitvalues, standardized) 
abline(0,0)
abline(v = 0)

##scoring
##looks like each of the 13 are rated on each of the 10 constructs 
##might not be right 
Achievement = rowSums(filledin_none[ , c(3:15)])
Framework = rowSums(filledin_none[ , c(3:15)])
Religion = rowSums(filledin_none[ , c(3:15)])
DeathAcceptance = rowSums(filledin_none[ , c(3:15)])
InterpersonalSatisfaction = rowSums(filledin_none[ , c(3:15)])
ExcitementFulfillment = rowSums(filledin_none[ , c(3:15)])
GivingtoWorld = rowSums(filledin_none[ , c(3:15)])
LackExistentialVacuum = rowSums(filledin_none[ , c(3:15)])
Intimacy = rowSums(filledin_none[ , c(3:15)])
Control = rowSums(filledin_none[ , c(3:15)])
```

```{r SOMtable, echo=FALSE, results='asis'}
##see comment above. This one didn't get screened all the way through. 
```

```{r SMS, include=FALSE}
SMS = master[ , c(239:254,14,955,956)]
names(SMS)

####DATA SCREENING####
##deal with 6 and 7 should be 1 item, not two
SMS$SMS6.5 = (SMS$SMS6 + SMS$SMS7) / 2

##Reverse Code 1 5 9 13 
library(car)
SMS$SMS1 = recode(SMS$SMS1, "1='5'; 2='4'; 3='3'; 4='2'; 5='1'")
SMS$SMS5 = recode(SMS$SMS5, "1='5'; 2='4'; 3='3'; 4='2'; 5='1'")
SMS$SMS10 = recode(SMS$SMS10, "1='5'; 2='4'; 3='3'; 4='2'; 5='1'")
SMS$SMS14 = recode(SMS$SMS14, "1='5'; 2='4'; 3='3'; 4='2'; 5='1'")

##Missing Data##
library(mice)
percentmiss = function(x){ sum(is.na(x))/length(x) *100 }

##Going by rows ONLY
notypos = SMS
names(notypos)
missing = apply(notypos[ , c(1:5,8:16,20)], 1, percentmiss) 
table(missing)

##replace only the data that you should
replacepeople = notypos[ missing <= 5 , ]  
dontpeople = notypos[ missing > 5 , ]

##figure out the columns to exclude (survey data)
apply(replacepeople, 2, percentmiss)
names(replacepeople)
replacecolumn = replacepeople[ , -c(17:19)]
dontcolumn = replacepeople[ , c(17:19)]

nomiss = replacepeople

##Outliers##
mahal = mahalanobis(nomiss[ , -c(17:19)], 
                    colMeans(nomiss[ , -c(17:19)], na.rm = TRUE),
                    cov(nomiss[ , -c(17:19)], use="pairwise.complete.obs"))

cutoff = qchisq(.999,ncol(nomiss[ , -c(17:19)])) 
summary(mahal < cutoff)
noout = nomiss[ mahal < cutoff, ]

##additivity: correlations
correlations = cor(noout[,-c(17:19)], use="pairwise.complete.obs")
symnum(correlations)

##make the random stuff
random = rchisq(nrow(noout), 7)
##be sure here not to include the ID columns!
fake = lm(random~., data=noout[ , -c(17:19)])

##get the linearity plot
##create the standardized residuals
standardized = rstudent(fake)
qqnorm(standardized)
abline(0,1)

##multivariate normality
hist(standardized, breaks=15)

##homogeneity and homoscedaticity
fitvalues = scale(fake$fitted.values)
plot(fitvalues, standardized) 
abline(0,0)
abline(v = 0)

####CFA####
##subsetting data
#Zero = notrandom, One = random, Two = paper
nooutnop = subset(noout, source != 'paper') ##excludes paper
nomissnop = subset(nomiss, source != 'paper') ##excludes paper

notrandom = subset(nomissnop, source == 'not random') ##noout and filled in none same dataset
random = subset(nomissnop, source == 'random')

####overall model for everyone together##
overallmodel = '
SMS =~
SMS1 + SMS2 + SMS3 + SMS4 + SMS5 + SMS6.5 + 
SMS8 + SMS9 + SMS10 + SMS11 + SMS12 + SMS13 + SMS14 +
SMS15 + SMS16
'

overall.fit = cfa(model = overallmodel, 
                  data=nomissnop, 
                  meanstructure = TRUE)

summary(overall.fit, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE)

##random
overall.fit.r = cfa(overallmodel, 
                    data=random, 
                    meanstructure = TRUE)

summary(overall.fit.r, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE)

##notrandom
overall.fit.nr = cfa(overallmodel, 
                     data=notrandom, 
                     meanstructure = TRUE)

summary(overall.fit.nr, 
        standardized=TRUE,
        rsquare=TRUE, 
        fit.measure = TRUE)


####multi group testing####
###measurement invariance

multisteps = measurementInvariance(overallmodel, 
                                   data = nomissnop, 
                                   group = "Source",
                                   strict = T)

fitmeasures(multisteps$fit.configural)
fitmeasures(multisteps$fit.loadings)
fitmeasures(multisteps$fit.intercepts)
fitmeasures(multisteps$fit.residuals)


```

```{r SMStable, echo=FALSE, results='asis'}

tableSMS = matrix(NA, nrow = 7, ncol = 8)
tableSMS[ , 1] = c("Overall Model", "Random", "Not Random", 
                   "Configural", "Metric", "Scalar", "Strict")

fitused = c("chisq", "df", "rmsea", "srmr", "cfi")

tableSMS[1, 2:8 ] = c(nrow(nomissnop), 
                      fitmeasures(overall.fit, fit.measures = fitused), 
                      "-")
tableSMS[2, 2:8] = c(nrow(random), 
                      fitmeasures(overall.fit.r, fit.measures = fitused), 
                      "-")

tableSMS[3, 2:8] = c(nrow(notrandom), 
                      fitmeasures(overall.fit.nr, fit.measures = fitused), 
                      "-")

tableSMS[4, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.configural, fit.measures = fitused), 
                      "-")

tableSMS[5, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.loadings, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.loadings)["cfi"] - fitmeasures(multisteps$fit.configural)["cfi"])

tableSMS[6, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.intercepts, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.intercepts)["cfi"] - fitmeasures(multisteps$fit.loadings)["cfi"])

tableSMS[7, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.residuals, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.residuals)["cfi"] - fitmeasures(multisteps$fit.intercepts)["cfi"])

tableSMS[ , 3] = printnum(as.numeric(tableSMS[ , 3]), big.mark = "")
tableSMS[ , 5:8] = printnum(as.numeric(tableSMS[ , 5:8]), gt1 = F, digits = 3)


kable(tableSMS, 
      col.names = c("Model", "N", "Chi-Square", 
                       "df", "RMSEA", "SRMR", "CFI", "Change CFI"))

```

```{r STMS, include=FALSE}

STMS = master[ , c(357:390,14,955,956)]
names(STMS)

##Missing Data##
library(mice)
percentmiss = function(x){ sum(is.na(x))/length(x) *100 }

##Going by rows ONLY
notypos = STMS
names(notypos)
missing = apply(notypos[ , 1:34], 1, percentmiss) 
table(missing)

##Replace only the data that you should
replacepeople = notypos[ missing <= 5 , ]  
dontpeople = notypos[ missing > 5 , ]

##Figure out the columns to exclude
apply(replacepeople, 2, percentmiss)
names(replacepeople)
replacecolumn = replacepeople[ , -c(35:37)]
dontcolumn = replacepeople[ , c(35:37)]

##MICE
tempnomiss = mice(replacecolumn)
nomiss = complete(tempnomiss, 1)
summary(nomiss)

##(By your powers) Combine (I am Captain Planet!)
filledin_none = cbind(dontcolumn, nomiss)
summary(filledin_none)

##Small note: When MICE is run on this project the YEAR column
##is moved from the last column to the thrid column.
##This trend is not observed with data that does not need
##to be MICE'd. All code exluding ID columns has been corrected
##for this. 
#~Hannah 

##Outliers##
##Mahal
names(filledin_none)
mahal = mahalanobis(filledin_none[ , -c(1:3)], 
                    colMeans(filledin_none[ , -c(1:3)], na.rm = TRUE),
                    cov(filledin_none[ , -c(1:3)], use="pairwise.complete.obs"))

summary(mahal)
cutoff = qchisq(.999,ncol(filledin_none[ , -c(1:3)])) 
summary(mahal < cutoff)
noout = filledin_none[ mahal < cutoff, ]

##Additivity: correlations
correlations = cor(noout[,-c(1:3)], use="pairwise.complete.obs")
symnum(correlations)

##Make the random stuff & exclude the ID columns 
random = rchisq(nrow(noout), 7)
fake = lm(random~., data=noout[ , -c(1:3)])

##Linearity plot
##Create the standardized residuals
standardized = rstudent(fake)
qqnorm(standardized)
abline(0,1)

##Multivariate normality
hist(standardized, breaks=15)

##Homogeneity and homoscedaticity
fitvalues = scale(fake$fitted.values)
plot(fitvalues, standardized) 
abline(0,0)
abline(v = 0)

##exclude paper people using noout dataset 
nooutnop = subset(noout, source != 'paper') ##excludes paper
nomissnop = subset(filledin_none, source != 'paper') ##excludes paper

notrandom = subset(nomissnop, source == 'not random') ##noout and filled in none same dataset
random = subset(nomissnop, source == 'random')


##overallmodel 
names(nomissnop)
overallmodel = '
PH =~ STMS17 + STMS24 + STMS16 + STMS19 + STMS20 + STMS26 + STMS22 + STMS21 + STMS23 + STMS27 + STMS15 + STMS30 + STMS28 + STMS25 + STMS29 + STMS18 + STMS33 + STMS8 + STMS32
AH =~ STMS2 + STMS3 + STMS12 + STMS10 + STMS9 + STMS4 + STMS1 + STMS7 + STMS11 + STMS6 + STMS5 
NLE =~ STMS14 + STMS13 + STMS31
'

overall.fit = cfa(overallmodel, 
          data = nomissnop, 
          meanstructure = TRUE)

summary(overall.fit, 
        standardized = TRUE, 
        rsquare = TRUE, 
        fit.measure = TRUE)
fitMeasures(overall.fit)

##fit for random 
overall.fit.r = cfa(overallmodel, 
                 data = random, 
                 meanstructure = TRUE)
summary(overall.fit.r, 
        standardized = TRUE, 
        rsquare = TRUE, 
        fit.measure = TRUE)
fitMeasures(overall.fit.r)

##fit for not random 
overall.fit.nr = cfa(overallmodel, 
                    data = notrandom, 
                    meanstructure = TRUE)
summary(overall.fit.nr, 
        standardized = TRUE, 
        rsquare = TRUE, 
        fit.measure = TRUE) 
fitMeasures(overall.fit.nr)

##invariances 
multisteps = measurementInvariance(overallmodel, 
                                   data = nomissnop, 
                                   group = 'source', 
                                   strict = T)
fitmeasures(multisteps)
fitMeasures(multisteps$fit.configural)
fitMeasures(multisteps$fit.loadings)
fitMeasures(multisteps$fit.intercepts)
fitMeasures(multisteps$fit.residuals)
fitMeasures(multisteps$fit.means)

##partials at intercepts scalar~1 
partial = partialInvariance(multisteps, 
                            type = "scalar")
strictfree = partial$results ##STMS1

partialstrict = measurementInvariance(overallmodel, 
                                      data = nomissnop, 
                                      group = "source", 
                                      strict = T, 
                                      group.partial = c("STMS1~1"))
fitmeasures(partialstrict$fit.intercepts)
fitmeasures(partialstrict$fit.residuals)




```

```{r STMStable, echo=FALSE, results='asis'}

tableSTMS = matrix(NA, nrow = 7, ncol = 8)
tableSTMS[ , 1] = c("Overall Model", "Random", "Not Random", 
                   "Configural", "Metric", "Scalar", "Strict")

fitused = c("chisq", "df", "rmsea", "srmr", "cfi")

tableSTMS[1, 2:8 ] = c(nrow(nomissnop), 
                      fitmeasures(overall.fit, fit.measures = fitused), 
                      "-")
tableSTMS[2, 2:8] = c(nrow(random), 
                      fitmeasures(overall.fit.r, fit.measures = fitused), 
                      "-")

tableSTMS[3, 2:8] = c(nrow(notrandom), 
                      fitmeasures(overall.fit.nr, fit.measures = fitused), 
                      "-")

tableSTMS[4, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(partialstrict$fit.configural, fit.measures = fitused), 
                      "-")

tableSTMS[5, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(partialstrict$fit.loadings, fit.measures = fitused), 
                      fitmeasures(partialstrict$fit.loadings)["cfi"] - fitmeasures(partialstrict$fit.configural)["cfi"])

tableSTMS[6, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(partialstrict$fit.intercepts, fit.measures = fitused), 
                      fitmeasures(partialstrict$fit.intercepts)["cfi"] - fitmeasures(partialstrict$fit.loadings)["cfi"])

tableSTMS[7, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(partialstrict$fit.residuals, fit.measures = fitused), 
                      fitmeasures(partialstrict$fit.residuals)["cfi"] - fitmeasures(partialstrict$fit.intercepts)["cfi"])

tableSTMS[ , 3] = printnum(as.numeric(tableSTMS[ , 3]), big.mark = "")
tableSTMS[ , 5:8] = printnum(as.numeric(tableSTMS[ , 5:8]), gt1 = F, digits = 3)


kable(tableSTMS, 
      col.names = c("Model", "N", "Chi-Square", 
                       "df", "RMSEA", "SRMR", "CFI", "Change CFI"))

```

```{r VOL, include=FALSE}
VOL = master[ , c(297:315,14,955,956)]
names(VOL)

##No reverse coded items.

####DATA SCREENING####

##Missing Data##
library(mice)
percentmiss = function(x){ sum(is.na(x))/length(x) *100 }

##Going by rows ONLY
notypos = VOL
names(notypos)
missing = apply(notypos[ , 1:19], 1, percentmiss) 
table(missing)

##Replace only the data that you should
replacepeople = notypos[ missing <= 5 , ]  
dontpeople = notypos[ missing > 5 , ]

##Figure out the columns to exclude
apply(replacepeople, 2, percentmiss)
names(replacepeople)
replacecolumn = replacepeople[ , -c(20:22)]
dontcolumn = replacepeople[ , c(20:22)]

nomiss = replacepeople

##Outliers##
names(nomiss)
mahal = mahalanobis(nomiss[ , -c(20:22)], 
                    colMeans(nomiss[ , -c(20:22)], na.rm = TRUE),
                    cov(nomiss[ , -c(20:22)], use="pairwise.complete.obs"))

cutoff = qchisq(.999,ncol(nomiss[ , -c(20:22)])) 
summary(mahal < cutoff)
noout = nomiss[ mahal < cutoff, ]

##additivity: correlations
correlations = cor(noout[,-c(20:22)], use="pairwise.complete.obs")
symnum(correlations)

##make the random stuff
random = rchisq(nrow(noout), 7)
##be sure here not to include the ID columns!
fake = lm(random~., data=noout[ , -c(20:22)])

##get the linearity plot
##create the standardized residuals
standardized = rstudent(fake)
qqnorm(standardized)
abline(0,1)

##multivariate normality
hist(standardized, breaks=15)

##homogeneity and homoscedaticity
fitvalues = scale(fake$fitted.values)
plot(fitvalues, standardized) 
abline(0,0)
abline(v = 0)

##exclude paper people using noout dataset 
nooutnop = subset(noout, source != 'paper') ##excludes paper
nomissnop = subset(nomiss, source != 'paper') ##excludes paper

notrandom = subset(nomissnop, source == 'not random') ##noout and filled in none same dataset
random = subset(nomissnop, source == 'random')

##overallmodel 
library(lavaan)
overallmodel = '
POS =~ VOL1 + VOL2 + VOL3 + VOL4 + VOL5 + VOL6 + VOL7 + VOL8 + VOL9 + VOL10 + VOL11 + VOL12 + VOL13
NEG =~ VOL14 + VOL15 + VOL16 + VOL17 + VOL18 + VOL19
'
overall.fit = cfa(overallmodel, 
          data = nomissnop, 
          meanstructure = TRUE)
fitMeasures(overall.fit)

##fit for random 
overall.fit.r = cfa(overallmodel, 
                 data = random, 
                 meanstructure = TRUE)
fitMeasures(overall.fit.r)

##fit for not random 
overall.fit.nr = cfa(overallmodel, 
                    data = notrandom, 
                    meanstructure = TRUE)
fitMeasures(overall.fit.nr)

##invariances 
library(semTools)
multisteps = measurementInvariance(overallmodel, 
                                   data = nomissnop, 
                                   group = 'source', 
                                   strict = T)
fitmeasures(multisteps)
fitMeasures(multisteps$fit.configural)
fitMeasures(multisteps$fit.loadings)
fitMeasures(multisteps$fit.intercepts)
fitMeasures(multisteps$fit.residuals)
fitMeasures(multisteps$fit.means)

##partials 
partial = partialInvariance(multisteps, 
                            type = "scalar")
strictfree = partial$results
##VOL16


partialstrict = measurementInvariance(overallmodel, 
                                      data = nomissnop, 
                                      group = 'source', 
                                      strict = T, 
                                      group.partial = c("	VOL16~1"))

fitmeasures(partialstrict$fit.intercepts)
fitmeasures(partialstrict$fit.residuals)

##partials agin bc broke down at strict

partial2 = partialInvariance(partialstrict, type = "strict")
strictfree = partial2$results

partialstrict2 = measurementInvariance(overallmodel, 
                                      data = nomissnop, 
                                      group = 'source', 
                                      strict = T, 
                                      group.partial = c("	VOL16~1","VOL3~~VOL3"))
fitMeasures(partialstrict2$fit.residuals)

partial3 = partialInvariance(partialstrict2, type = "strict")
strictfree3 = partial3$results

partialstrict3 = measurementInvariance(overallmodel, 
                                       data = nomissnop, 
                                       group = 'source', 
                                       strict = T, 
                                       group.partial = c("	VOL16~1","VOL3~~VOL3", "VOL16~~VOL16"))
fitMeasures(partialstrict3$fit.residuals)

##strict 4 
partial4 = partialInvariance(partialstrict3, type = "strict")
strictfree4 = partial4$results

partialstrict4 = measurementInvariance(overallmodel, 
                                       data = nomissnop, 
                                       group = 'source', 
                                       strict = T, 
                                       group.partial = c("	VOL16~1","VOL3~~VOL3", "VOL16~~VOL16", "VOL6~~VOL6"))
fitMeasures(partialstrict4$fit.residuals)

```

```{r VOLtable, echo=FALSE, results='asis'}

tableVOL = matrix(NA, nrow = 7, ncol = 8)
tableVOL[ , 1] = c("Overall Model", "Random", "Not Random", 
                   "Configural", "Metric", "Scalar", "Strict")

fitused = c("chisq", "df", "rmsea", "srmr", "cfi")

tableVOL[1, 2:8 ] = c(nrow(nomissnop), 
                      fitmeasures(overall.fit, fit.measures = fitused), 
                      "-")
tableVOL[2, 2:8] = c(nrow(random), 
                      fitmeasures(overall.fit.r, fit.measures = fitused), 
                      "-")

tableVOL[3, 2:8] = c(nrow(notrandom), 
                      fitmeasures(overall.fit.nr, fit.measures = fitused), 
                      "-")

tableVOL[4, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(partialstrict4$fit.configural, fit.measures = fitused), 
                      "-")

tableVOL[5, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(partialstrict4$fit.loadings, fit.measures = fitused), 
                      fitmeasures(partialstrict4$fit.loadings)["cfi"] - fitmeasures(partialstrict4$fit.configural)["cfi"])

tableVOL[6, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(partialstrict4$fit.intercepts, fit.measures = fitused), 
                      fitmeasures(partialstrict4$fit.intercepts)["cfi"] - fitmeasures(partialstrict4$fit.loadings)["cfi"])

tableVOL[7, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(partialstrict4$fit.residuals, fit.measures = fitused), 
                      fitmeasures(partialstrict4$fit.residuals)["cfi"] - fitmeasures(partialstrict4$fit.intercepts)["cfi"])

tableVOL[ , 3] = printnum(as.numeric(tableVOL[ , 3]), big.mark = "")
tableVOL[ , 5:8] = printnum(as.numeric(tableVOL[ , 5:8]), gt1 = F, digits = 3)


kable(tableVOL, 
      col.names = c("Model", "N", "Chi-Square", 
                       "df", "RMSEA", "SRMR", "CFI", "Change CFI"))

```

```{r WBS, include=FALSE}
PWS = master[ , c(255:296,14,955,956)]
names(PWS)

##No reverse coded items.
library(car)
PWS$PWS5 = recode(PWS$PWS5, "1='6'; 2='5'; 3='4'; 4='3'; 5='2'; 6='1'")
PWS$PWS10 = recode(PWS$PWS10, "1='6'; 2='5'; 3='4'; 4='3'; 5='2'; 6='1'")
PWS$PWS13 = recode(PWS$PWS13, "1='6'; 2='5'; 3='4'; 4='3'; 5='2'; 6='1'")
PWS$PWS14 = recode(PWS$PWS14, "1='6'; 2='5'; 3='4'; 4='3'; 5='2'; 6='1'")
PWS$PWS15 = recode(PWS$PWS15, "1='6'; 2='5'; 3='4'; 4='3'; 5='2'; 6='1'")
PWS$PWS16 = recode(PWS$PWS16,"1='6'; 2='5'; 3='4'; 4='3'; 5='2'; 6='1'")
PWS$PWS17 = recode(PWS$PWS17, "1='6'; 2='5'; 3='4'; 4='3'; 5='2'; 6='1'")
PWS$PWS18 = recode(PWS$PWS18, "1='6'; 2='5'; 3='4'; 4='3'; 5='2'; 6='1'")
PWS$PWS19 = recode(PWS$PWS19, "1='6'; 2='5'; 3='4'; 4='3'; 5='2'; 6='1'")
PWS$PWS23 = recode(PWS$PWS23, "1='6'; 2='5'; 3='4'; 4='3'; 5='2'; 6='1'")
PWS$PWS26 = recode(PWS$PWS26, "1='6'; 2='5'; 3='4'; 4='3'; 5='2'; 6='1'")
PWS$PWS27 = recode(PWS$PWS27, "1='6'; 2='5'; 3='4'; 4='3'; 5='2'; 6='1'")
PWS$PWS30 = recode(PWS$PWS30,"1='6'; 2='5'; 3='4'; 4='3'; 5='2'; 6='1'")
PWS$PWS31 = recode(PWS$PWS31, "1='6'; 2='5'; 3='4'; 4='3'; 5='2'; 6='1'")
PWS$PWS32 = recode(PWS$PWS32, "1='6'; 2='5'; 3='4'; 4='3'; 5='2'; 6='1'")
PWS$PWS34 = recode(PWS$PWS34, "1='6'; 2='5'; 3='4'; 4='3'; 5='2'; 6='1'")
PWS$PWS36 = recode(PWS$PWS36,"1='6'; 2='5'; 3='4'; 4='3'; 5='2'; 6='1'")
PWS$PWS39 = recode(PWS$PWS39, "1='6'; 2='5'; 3='4'; 4='3'; 5='2'; 6='1'")
PWS$PWS41 = recode(PWS$PWS41, "1='6'; 2='5'; 3='4'; 4='3'; 5='2'; 6='1'")
####DATA SCREENING####

##Missing Data##
library(mice)
percentmiss = function(x){ sum(is.na(x))/length(x) *100 }

##Going by rows ONLY
notypos = PWS
names(notypos)
missing = apply(notypos[ , 1:42], 1, percentmiss) 
table(missing)

##Replace only the data that you should
replacepeople = notypos[ missing <= 5 , ]  
dontpeople = notypos[ missing > 5 , ]

##Figure out the columns to exclude
apply(replacepeople, 2, percentmiss)
replacecolumn = replacepeople[ , -c(43:45)]
dontcolumn = replacepeople[ , c(43:45)]

##MICE
tempnomiss = mice(replacecolumn)
nomiss = complete(tempnomiss, 1)
summary(nomiss)

##(By your powers) Combine (I am Captain Planet!)
filledin_none = cbind(dontcolumn, nomiss)
summary(filledin_none)

##Small note: When MICE is run on this project the YEAR column
##is moved from the last column to the thrid column.
##This trend is not observed with data that does not need
##to be MICE'd. All code exluding ID columns has been corrected
##for this. 
#~Hannah 

##Outliers##
##Mahal
names(filledin_none)
mahal = mahalanobis(nomiss[ , -c(1:3)], 
                    colMeans(nomiss[ , -c(1:3)], na.rm = TRUE),
                    cov(nomiss[ , -c(1:3)], use="pairwise.complete.obs"))

summary(mahal)
cutoff = qchisq(.999,ncol(nomiss[ , -c(1:3)])) 
summary(mahal < cutoff)
noout = nomiss[ mahal < cutoff, ]

##Additivity: correlations
correlations = cor(noout[,-c(1:3)], use="pairwise.complete.obs")
symnum(correlations)

##Make the random stuff & exclude the ID columns 
random = rchisq(nrow(noout), 7)
fake = lm(random~., data=noout[ , -c(1:3)])

##get the linearity plot
##create the standardized residuals
standardized = rstudent(fake)
qqnorm(standardized)
abline(0,1)

##multivariate normality
hist(standardized, breaks=30)

##homogeneity and homoscedasticity
fitvalues = scale(fake$fitted.values)
plot(fitvalues, standardized) 
abline(0,0)
abline(v = 0)

##Scoring
AUT <- rowSums(noout[, c("PWS1", "PWS7", "PWS13", "PWS19", "PWS25", "PWS31","PWS37")])
AUT

EM <- rowSums(noout[, c("PWS2", "PWS8", "PWS14", "PWS20", "PWS26", "PWS32","PWS38")])
EM

PG <- rowSums(noout[, c("PWS3", "PWS9", "PWS15", "PWS21", "PWS27", "PWS33","PWS39")])
PG

PR <- rowSums(noout[, c("PWS4", "PWS10", "PWS16", "PWS22", "PWS28", "PWS34","PWS40")])
PR

PL <- rowSums(noout[, c("PWS5", "PWS11", "PWS17", "PWS23", "PWS29", "PWS35","PWS41")])
PL

SA <- rowSums(noout[, c("PWS6", "PWS12", "PWS18", "PWS24", "PWS30", "PWS36","PWS42")])
SA

##CFA with internal + external + noout datasets / need to drop paper
nooutnop = subset(noout, source != 'paper') ##excludes paper
nomissnop = subset(filledin_none, source != 'paper') ##excludes paper

notrandom = subset(nomissnop, source == 'not random') ##noout and filled in none same dataset
random = subset(nomissnop, source == 'random')

library(lavaan)
overallmodel = '
AUT =~ PWS1 + PWS7 + PWS13 + PWS19 + PWS25 + PWS31 + PWS37
EM =~ PWS2 + PWS8 + PWS14 + PWS20 + PWS26 + PWS32 + PWS38
PG =~ PWS3 + PWS9 + PWS15 + PWS21 + PWS27 + PWS33 + PWS39 
PR =~ PWS4 + PWS10 + PWS16 + PWS22 + PWS28 + PWS34 + PWS40
PL =~ PWS5 + PWS11 + PWS17 + PWS23 + PWS29 + PWS35 + PWS41
SA =~ PWS6 + PWS12 + PWS18 + PWS24 + PWS30 + PWS36 + PWS42
'

##fit for overall (excluding paper)
overall.fit = cfa(model = overallmodel, 
                  data = nomissnop, 
                  meanstructure = TRUE)

summary(overall.fit, 
        standardized=TRUE, 
        rsquare=TRUE, 
        fit.measure = TRUE) ##no heywood cases

##fit for random 
overall.fit.r = cfa(overallmodel, 
                 data = random, 
                 meanstructure = TRUE)
summary(overall.fit.r, 
        standardized = TRUE, 
        rsquare = TRUE, 
        fit.measure = TRUE)

fitMeasures(overall.fit.r) ##Dr. B, is this line of code necessary?

##fit for not random 
overall.fit.nr = cfa(overallmodel, 
                    data = notrandom, 
                    meanstructure = TRUE)
summary(overall.fit.nr, 
        standardized = TRUE, 
        rsquare = TRUE, 
        fit.measure = TRUE)

##invariances 
library(semTools)
multisteps = measurementInvariance(overallmodel, 
                                   data = nomissnop, 
                                   group = 'source', 
                                   strict = T)

fitmeasures(multisteps)
fitMeasures(multisteps$fit.configural)
fitMeasures(multisteps$fit.loadings)
fitMeasures(multisteps$fit.intercepts)
fitMeasures(multisteps$fit.residuals)
fitMeasures(multisteps$fit.means)

```

```{r WBStable, echo=FALSE, results='asis'}

tableWBS = matrix(NA, nrow = 7, ncol = 8)
tableWBS[ , 1] = c("Overall Model", "Random", "Not Random", 
                   "Configural", "Metric", "Scalar", "Strict")

fitused = c("chisq", "df", "rmsea", "srmr", "cfi")

tableWBS[1, 2:8 ] = c(nrow(nomissnop), 
                      fitmeasures(overall.fit, fit.measures = fitused), 
                      "-")
tableWBS[2, 2:8] = c(nrow(random), 
                      fitmeasures(overall.fit.r, fit.measures = fitused), 
                      "-")

tableWBS[3, 2:8] = c(nrow(notrandom), 
                      fitmeasures(overall.fit.nr, fit.measures = fitused), 
                      "-")

tableWBS[4, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.configural, fit.measures = fitused), 
                      "-")

tableWBS[5, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.loadings, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.loadings)["cfi"] - fitmeasures(multisteps$fit.configural)["cfi"])

tableWBS[6, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.intercepts, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.intercepts)["cfi"] - fitmeasures(multisteps$fit.loadings)["cfi"])

tableWBS[7, 2:8] = c(nrow(nomissnop), 
                      fitmeasures(multisteps$fit.residuals, fit.measures = fitused), 
                      fitmeasures(multisteps$fit.residuals)["cfi"] - fitmeasures(multisteps$fit.intercepts)["cfi"])

tableWBS[ , 3] = printnum(as.numeric(tableWBS[ , 3]), big.mark = "")
tableWBS[ , 5:8] = printnum(as.numeric(tableWBS[ , 5:8]), gt1 = F, digits = 3)


kable(tableWBS, 
      col.names = c("Model", "N", "Chi-Square", 
                       "df", "RMSEA", "SRMR", "CFI", "Change CFI"))

```


##ideas

for the paper:
- compare # times broken down and where based on:
-- sample size 
-- type of data (likert, true/false)
-- number of items or subscales
-- previous reliability 

test test test
